<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure Identity Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。</subtitle>
  <link href="https://jpazureid.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpazureid.github.io/blog/"/>
  <updated>2023-03-05T14:02:06.271Z</updated>
  <id>https://jpazureid.github.io/blog/</id>
  
  <author>
    <name>Azure Identity Support Japan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>組織の境界やマイクロソフトのクラウドを越えたセキュアなコラボレーション</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds/</id>
    <published>2023-03-05T01:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.271Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 張替 です。</p><p>本記事は、2023 年 2 月 23 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/collaborate-securely-across-organizational-boundaries-and/ba-p/3094109">Collaborate securely across organizational boundaries and Microsoft clouds</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>今日、Microsoft のクラウド間でのコラボレーション機能が GA になったことを発表いたします！Azure Active Directory (Azure AD) の B2B コラボレーションが、以下の Microsoft クラウド間でサポートされるようになりました。</p><ul><li>Azure Commercial および Azure Government クラウド </li><li>Azure Commercial および Azure China クラウド（21Vianet）</li></ul><p>Microsoft Entra の一部である <a href="https://learn.microsoft.com/en-us/azure/active-directory/external-identities/what-is-b2b">Azure AD B2B</a> を利用して、Microsoft クラウド内で、サプライヤーやパートナー、ベンダーなどの外部ユーザーとコラボレーションしている方は、すでに多くいらっしゃると思います。また、自身の組織をホストしているクラウドとは異なる Microsoft クラウドでホストされている組織と共有および連携する必要があるお客様もいるでしょう。これまでは、複数のクラウドにテナントを設定し、同じユーザーに異なるアカウントを発行するという複雑なプロセスを踏む必要がありました。しかし現在、組織が Azure Commercial、Government、または China クラウドのいずれであっても、ユーザーは自身のプライマリとなる ID を使用して Microsoft クラウド間でシームレスに連携できるようになりました。</p><h2 id="3つの簡単なステップで-Microsoft-のクラウド間でのコラボレーションを開始する"><a href="#3つの簡単なステップで-Microsoft-のクラウド間でのコラボレーションを開始する" class="headerlink" title="3つの簡単なステップで Microsoft のクラウド間でのコラボレーションを開始する"></a>3つの簡単なステップで Microsoft のクラウド間でのコラボレーションを開始する</h2><p>Azure Government クラウドを使用している組織である Contoso Industries が、Azure Commercial クラウドのパートナーとどのようにコラボレーションしているかを例にとって説明します。</p><p>Contoso Industries は、政府機関や商業組織にミッション クリティカルな機器を供給しています。ビジネスの機密性を考慮し、政府は Contoso Industries を Azure Government Cloud でホスティングすることを求めています。</p><p>Contoso Industries には、Contoso Industries が製造する機器にソフトウェアを提供する Woodgrove のような商業パートナーもいます。現在は Microsoft のクラウドを横断してコラボレーションを行うことができるため、Contoso Industries のユーザーは Woodgrove のユーザーを招待してコラボレーションを行い、在庫管理のアプリケーションや SharePoint のドキュメントにアクセスできるようにすることが可能になっています。</p><p><img src="/blog/azure-active-directory/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds1.png"></p><p>では、実現方法について見ていきましょう。 </p><h3 id="ステップ-1：External-Identities-の-Microsoft-クラウド設定を有効にする"><a href="#ステップ-1：External-Identities-の-Microsoft-クラウド設定を有効にする" class="headerlink" title="ステップ 1：External Identities の Microsoft クラウド設定を有効にする"></a>ステップ 1：External Identities の Microsoft クラウド設定を有効にする</h3><p>Contoso Industries の管理者である Dean は、Azure ポータルの External Identities -&gt; テナント間アクセス設定 に移動して、Azure Commercial cloud と連携する設定を有効にします。</p><p><img src="/blog/azure-active-directory/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds2.png" alt="External Identities で Microsoft クラウドの設定を有効にします"></p><p>Dean は次に、<a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/cross-tenant-access-settings-for-secure-collaboration-now/ba-p/3575844">クロス テナント アクセス設定</a> で、Woodgrove のテナントをパートナーのリストに追加します。Woodgrove の管理者は、Azure ポータルで同様の変更を行います。</p><p>Dean は、特定のユーザーに特定のアプリケーションへのアクセスのみを許可するような、きめ細かい制御を行うこともできます。これによって、外部コラボレーションをさらに安全にすることができます。これらの変更が完了すると、Contoso Industries のユーザーは、Woodgrove からユーザーを招待して、Contoso Industries がホストしている業務系アプリ、SaaS アプリ、Power BI レポート、SharePoint Online サイト、ドキュメント、ファイルでのコラボレーションを行うことができるようになります。</p><p>Microsoft クラウド間でのコラボレーションを実現する方法については、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/cross-cloud-settings">B2B コラボレーションの Microsoft クラウド設定を構成する</a> をご覧ください。</p><h3 id="ステップ-2-まず他の-Microsoft-クラウドからの外部ユーザーを管理する"><a href="#ステップ-2-まず他の-Microsoft-クラウドからの外部ユーザーを管理する" class="headerlink" title="ステップ 2: まず他の Microsoft クラウドからの外部ユーザーを管理する"></a>ステップ 2: まず他の Microsoft クラウドからの外部ユーザーを管理する</h3><p>Contoso Industries では、異なるクラウドからのユーザーを適切に管理し、外部ユーザーが Contoso Industries のリソースに限られた時間だけアクセスできるようにしたいと考えています。Dean は、信頼できる組織としてWoodgrove を追加します。</p><p><img src="/blog/azure-active-directory/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds3.png" alt="他の Microsoft クラウドから接続された組織を追加します。"></p><p>Dean は、特定のリソース、アクセス レビュー、承認のためのスポンサーを含むアクセス パッケージを割り当てます。これにより、Woodgrove のユーザーは、セルフ サービスによるオンボーディングが容易になり、Contoso Industries のアクセス ポリシーが即座に適用されるようになりました。</p><p>接続された組織とアクセス パッケージを使用して、異なる Azure AD テナントのユーザーをオンボードし管理する方法については、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/entitlement-management-external-users">エンタイトルメント管理で外部ユーザーのアクセスを管理する</a> をご覧ください。 </p><h3 id="ステップ-3-Microsoft-クラウド間の外部コラボレーションを保護および監視する"><a href="#ステップ-3-Microsoft-クラウド間の外部コラボレーションを保護および監視する" class="headerlink" title="ステップ 3: Microsoft クラウド間の外部コラボレーションを保護および監視する"></a>ステップ 3: Microsoft クラウド間の外部コラボレーションを保護および監視する</h3><p>Dean は Woodgrove のユーザーと共有されるリソースを保護したいと考えています。Woodgrove のユーザーは Contoso Industries のゲスト ユーザーなので、Contoso Industries のリソースにアクセスする前に多要素認証 (MFA) を要求するなど、すべての <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/authentication-conditional-access">条件付きアクセス ポリシー</a> を Woodgrove のユーザーに適用することが可能です。</p><p>また、Contoso Industries は、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/cross-tenant-access-settings-b2b-collaboration#to-change-inbound-trust-settings-for-mfa-and-device-claims">クロス テナント アクセス設定</a> を利用して、Woodgrove から MFA や準拠済みの Azure AD の参加デバイスを信頼することができ、Woodgrove ユーザーのセキュリティをそのままに、シームレスなコラボレーション体験を実現することができます。</p><p><img src="/blog/azure-active-directory/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds4.png" alt="他の Azure AD テナントからの多要素認証とデバイス情報を信頼する。"></p><p>Woodgrove 社のユーザーが Contoso Industries のリソースにアクセスする場合、Dean はサインイン ログを使用してユーザーのアクティビティを監視することができます。また、<a href="https://learn.microsoft.com/en-us/azure/active-directory/reports-monitoring/workbook-cross-tenant-access-activity">クロス テナント アクセス アクティビティ ワークブック</a> を使用し、Woodgrove ユーザーがアクセスしているリソースを可視化することもできます。</p><h2 id="お客様の声"><a href="#お客様の声" class="headerlink" title="お客様の声"></a>お客様の声</h2><p>プレビューの際に、お客様のようなお客様から頂いた素晴らしいフィードバックを以下にご紹介します。</p><p>“ マイクロソフト クラウド間のコラボレーションにより、いくつものアプリを AD FS から Azure AD に移行可能となりました。AD FS はこれまで、本社ユーザーと中国ユーザーの両方が必要とするアプリへの SSO を提供するためのソリューションでした。この移行が完了すれば、AD FS を廃止し、コストを大幅に削減するとともに、信頼性を高め、セキュリティの工数を最小化することができます。” - 金融サービス業のお客様</p><p>“連携機能の不足でユーザーを政府系テナントに移動させることができなかったのですが、この機能でスムーズに移動できるようになりました！” -エンジニアリングと建設業界のお客様 </p><p>皆様からのフィードバックをお待ちしております。本発表に対するフィードバックは Azure フォーラムか <a href="https://twitter.com/azuread">@AzureAD</a> のタグをつけて Twitter にお寄せください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 張替 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 2 月 23 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techco</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>テナント制限について</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/</id>
    <published>2023-03-01T15:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.703Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2018/09/13/tenant-restrictions/">https://blogs.technet.microsoft.com/jpazureid/2018/09/13/tenant-restrictions/</a> の内容を移行したものです。</p><p>また本記事は 2018 年に公開したものですが、サポートへのお問い合わせ状況ならびにエラー画面の変更などをふまえ、2023 年 3 月時点での最新の情報にアップデートいたしました。</p></div><p>こんにちは！ Azure &amp; Identity サポート チームの栗井です。</p><p>今回は Azure AD のテナント制限の機能に関して、よくあるお問い合わせと、その回答をご紹介いたします。</p><h2 id="テナント制限とは"><a href="#テナント制限とは" class="headerlink" title="テナント制限とは"></a>テナント制限とは</h2><p>テナント制限の機能では、ユーザーがアクセス可能な Azure AD テナントを制限することが可能です。</p><p>具体的には、クライアント端末から Azure AD に対する認証の通信をプロキシ経由させ、そのプロキシから送信されるデータに許可対象の Azure AD テナントの情報を付与します。その結果、それ以外の Azure AD テナントへのアクセスがブロックされる動作となります。</p><p>テナント制限の機能の詳細については、以下の公開情報をご参照ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/tenant-restrictions">公開情報: テナント制限を使用して SaaS アプリへのアクセスを管理する - Microsoft Entra | Microsoft Learn</a></li></ul><p>テナント制限によって許可されていないテナントへアクセスを試行すると、下記のように 「ネットワーク管理者によってアクセスがブロックされました」というエラーメッセージが表示されます (エラーコード: AADSTS500021)。</p><p><img src="/blog/azure-active-directory/tenant-restriction/AADSTS500021.png"></p><p>以下にて、テナント制限に関連する FAQ をまとめました。ぜひご参照ください！</p><h2 id="よくあるお問い合わせ"><a href="#よくあるお問い合わせ" class="headerlink" title="よくあるお問い合わせ"></a>よくあるお問い合わせ</h2><p><font color="DeepSkyBlue">Q</font> : テナント制限の機能のライセンス要件はありますか？</p><p><font color = "red">A</font> : テナント制限のご利用には、Azure AD Premium P1 もしくは P2 相当のライセンスが必要です。</p><p><font color="DeepSkyBlue">Q</font> : Microsoft アカウント (コンシューマー向けアカウント) によるアクセスを制限することは可能ですか。</p><p><font color = "red">A</font> : はい、可能です。この場合は login.live.com 宛への通信に対してヘッダーを設定しますが、 “Restrict-Access-To-Tenants” とは異なるヘッダーを利用します。</p><p>Microsoft アカウントによるアクセスを制限する場合は、”sec-Restrict-Tenant-Access-Policy” ヘッダーに “restrict-msa” という値が含まれるように構成ください。<br>この設定によって、 Microsoft アカウントの認証エンドポイント (login.live.com) へのアクセスがブロックされます。</p><p>アクセス ブロック時のメッセージとエラーコードは下記の通りです。</p><ul><li>メッセージ: “ここからアクセスすることはできません お客様の IT 部門によって承認されていない組織に属するリソースへのアクセスを試みているようです。” </li><li>エラーコード: 80045C4D</li></ul><p><img src="/blog/azure-active-directory/tenant-restriction/80045C4D.png"></p><p><font color="DeepSkyBlue">Q</font> : 制限されるのは Office 365 だけですか？</p><p><font color = "red">A</font>  : いいえ。以下の認証エンドポイントを使用する、すべてのサービス、言い換えますと Azure AD と連携するサービスが制限されます。</p><ul><li>login.microsoftonline.com  </li><li>login.windows.net  </li><li>login.microsoft.com</li></ul><p>例えば Azure ポータル、EA ポータルにアクセスする際も制限されます。また、ゲストユーザーの場合、招待されたテナントではなく、管理元のテナントで認証が行われるため、ゲストユーザーの招待元テナントも、テナント制限で許可する必要があります。</p><p><font color="DeepSkyBlue">Q</font> : (クライアントですが)、テナント制限によってアクセスできないテナントにアクセスできるようにしてほしい。</p><p><font color = "red">A</font> : 接続元のクライアントが利用するプロキシサーバーの設定変更が必要です。プロキシ サーバーを管理している IT 部門へ申請をあげるなどで、テナント制限の許可するリストに該当のテナントを追加してもらってください。</p><p>テナント制限は設定をおこなったプロキシ経由でのアクセスに制限を加えるものですので、プロキシサーバーによる制限を受けないネットワーク環境から接続することでもテナント制限による制御は回避できます。</p><p><font color="DeepSkyBlue">Q</font> : Azure AD 側での設定変更は必要ですか？</p><p><font color = "red">A</font> : いいえ。プロキシの設定のみで、テナント制限が機能します。</p><p><font color="DeepSkyBlue">Q</font> : “Restrict-Access-To-Tenants” に、ワイルドカードは利用できますか？</p><p><font color = "red">A</font> : いいえ。テナント名かテナント ID を不足なく、入力する必要があります。</p><p><font color="DeepSkyBlue">Q</font> : テナント制限で許可をすることができるテナント数に上限はありますか？</p><p><font color = "red">A</font> : テナント制限にて、許可をするテナント数自体には上限は設けられていません。しかし、ヘッダーの長さの上限 (MaxFieldLength) と、リクエストとヘッダーを含めた合計のサイズの上限 (MaxRequestBytes) があるため、多数のディレクトリを追加する場合、この上限を超えないように注意が必要です。</p><p>上記内容が、皆様のご参考になれば幸甚です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Tenant Restrictions" scheme="https://jpazureid.github.io/blog/tags/Tenant-Restrictions/"/>
    
    <category term="テナント制限" scheme="https://jpazureid.github.io/blog/tags/%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E5%88%B6%E9%99%90/"/>
    
  </entry>
  
  <entry>
    <title>オンプレミス アプリケーションのガバナンスと自動プロビジョニング</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/</id>
    <published>2023-03-01T00:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.151Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 高田 です。</p><p>本記事は、2023 年 2 月 8 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/automate-provisioning-and-governance-of-your-on-premises/ba-p/2466935">Automate provisioning and governance of your on-premises applications</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>この度、Microsoft Entra Identity Governance を使用したオンプレミス アプリケーションへのプロビジョニングの一般提供を発表いたします。カスタム コードを必要とせず、オンプレミス アプリケーションのプロビジョニングを自動化し、ユーザーのライフサイクルを管理することができるようになりました。</p><p>すでに多くの方が Microsoft Entra Identity Governance を使用し、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/saas-apps/tutorial-list">既定で提供されているコネクター</a> を活用して何百もの SaaS アプリケーションに <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/user-provisioning">簡単に ID をプロビジョニング</a> しています。<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/tutorial-ecma-sql-connector">SQL</a> データベースや <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/on-premises-ldap-connector-configure">LDAP</a> ディレクトリ (Active Directory Domain Services を除く) にユーザー ID を保存しているオンプレミス アプリや、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/on-premises-scim-provisioning">SCIM</a> 標準をサポートしているオンプレミス アプリに対し、Azure Active Directory (Azure AD) から ID を直接プロビジョニングすることができるようになりました。つまり、Microsoft Entra Identity Governance を使用すれば、すぐに使えるオンプレミス コネクターを活用して、カスタム コード無しにオンプレミス アプリケーションへのアクセスを管理できるのです。</p><p>ここで例として、Contoso という企業が <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/identity-governance-overview">Microsoft Entra Identity Governance</a> を使用して、重要な製造プロセスを管理するオンプレミス アプリケーションへのアクセスを提供する例を説明します。このアプリケーションは組織内に何年も前から存在しています。このアプリケーションは、ユーザー管理のための最新の SCIM API をサポートしていませんが、ユーザー アクセスの管理には OpenLDAP サーバーを利用しています。Microsoft Entra Identity Governance を使用することで、Contoso は以下のことが可能になります。 </p><ul><li>アプリケーションへのアクセス許可設定を自動化することで、従業員の生産性を向上させる。</li><li>クラウドベースのプロビジョニング ソリューションを導入し、コストを管理する。</li><li>定期的なアクセス権の確認と取り消しを行い、リスクを管理する。</li></ul><p><img src="/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/1.png" alt="Contoso 社は OpenLDAP をユーザーストアとして利用しているオンプレミスの製造管理アプリを所有しています"></p><p>Contoso の管理者は、以下の簡単な 3 つのステップで、ユーザーがオンプレミス アプリケーションにアクセスできるようにし、同時に必要な統制プロセスを実現できました。</p><h2 id="1-アプリケーション-アクセスの構成"><a href="#1-アプリケーション-アクセスの構成" class="headerlink" title="1. アプリケーション アクセスの構成"></a>1. アプリケーション アクセスの構成</h2><p>従業員が組織に参加すると、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/saas-apps/workday-inbound-cloud-only-tutorial">Workday</a> で採用済みとしてマークされ、Azure AD にてアカウントが自動的にプロビジョニングされます。管理者はエンタイトルメント管理で <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/entitlement-management-access-package-create">アクセス パッケージ</a> を構成しています。製造部門で新しい従業員が採用されると、アクセス パッケージを通じて製造アプリへのアクセス権が　<a href="https://jpazureid.github.io/blog/azure-active-directory/dynamic-automated-access-with-entitlment-management/">自動的に</a> 割り当てられます。従業員が退職したり、転職したりすると、その割り当てが自動的に削除され、そのアプリケーションにアクセスできなくなります。</p><p>製造部門に所属していないユーザーで、製造アプリに期間限定でアクセスする必要がある人もいます。この要件に対応するため、Contoso の管理者はもう一つ別のポリシーを構成しており、それにより他の従業員がアクセス パッケージを介してアプリケーションへのアクセスを要求できるようにしています。</p><p>アクセスが必要なすべてのユーザーは、自動的にアクセス権を付与されるか、セルフ サービスで必要なアクセス権を要求することができます。</p><p><img src="/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/2.png"></p><h2 id="2-アカウントのプロビジョニングを自動化"><a href="#2-アカウントのプロビジョニングを自動化" class="headerlink" title="2. アカウントのプロビジョニングを自動化"></a>2. アカウントのプロビジョニングを自動化</h2><p>製造業アプリはオンプレミスに存在し、SCIM などの最新規格には対応していませんが、アクセス制御に OpenLDAP サーバーを使用しています。管理者は Azure AD が提供する <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/on-premises-ldap-connector-configure">汎用的な LDAP コネクター</a> を使用し、プロビジョニングを設定します。アクセス パッケージを通じて製造アプリケーションへのアクセスを許可されたユーザーは、自動的にアカウントがプロビジョニングされます。  </p><p>Contoso の管理者は、アプリケーションを改変することなく、すぐに使える LDAP コネクタを利用し、プロビジョニングを自動化することができるのです。</p><p><img src="/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/3.png"></p><h2 id="3-定期的なアクセス権のレビューと承認"><a href="#3-定期的なアクセス権のレビューと承認" class="headerlink" title="3. 定期的なアクセス権のレビューと承認"></a>3. 定期的なアクセス権のレビューと承認</h2><p>製造アプリにはビジネス クリティカルなデータがあり、Contoso 社はコンプライアンス プロセスの一環として、製造部門以外の従業員に定期的にアクセスの必要性の確認と正当な理由の提示を求めることが必要とされています。Contoso の管理者は、アプリにアクセスできる製造部門以外のユーザーに対して、多段階のアクセス レビューを設定しました。まず、従業員がアクセスが必要であることを自身で確認し、その後、最終承認のためにアプリケーションの所有者にレビューが転送されます。 アクセス レビューが完了しないユーザーは、自動的にアプリケーションから削除されます。</p><p>適切なアクセス制御とレビューが実施され、「なぜ」アクセス許可が存在するのかが証明できるため、これにより内部および外部の監査要件が満たされます。</p><p><img src="/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/4.png"></p><p>Azure AD の <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/entitlement-management-overview">エンタイトルメント管理</a>、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/what-is-provisioning">プロビジョニング</a>、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/access-reviews-overview">アクセス レビュー</a> 機能を併用することで、SaaS とオンプレミスの両方のアプリケーションへのアクセスを提供しながら、統制とセキュリティの要件を同時に満たすことが可能になります。今すぐこの新機能を有効にし、SaaS アプリケーションと同じ方法でオンプレミス アプリケーションへのアクセスを管理ください。</p><p>これは、Microsoft Entra Identity Governance のオンプレミス サポートの始まりに過ぎません。PowerShell、Web サービス、その他のビジネス アプリケーションへのカスタム コネクタを使用したプロビジョニング機能など、さらに投資を続け、Microsoft Identity Manager (MIM) を使用しているお客様がプロビジョニング機能を Microsoft Entra Identity Governance に移行できるようにしてまいります。</p><p>これらの新機能に関するご意見は、<a href="https://aka.ms/AzureADFeedback">Azure フォーラム</a> または Twitter で <a href="https://twitter.com/azuread">@AzureAD</a> のタグを付けてお寄せください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 高田 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 2 月 8 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techcom</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>管理者の同意を実施したにも関わらず「管理者の承認が必要です」の画面が表示される</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-consent-framework-advance/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azure-ad-consent-framework-advance/</id>
    <published>2023-02-26T15:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.163Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Identity チームの埴山です。<br>不正なアプリを利用した攻撃を防ぐ目的で、一般ユーザーによる同意を制限しているお客様から、管理者同意に関するお問合せを多く頂いております。</p><p>そこで以前、<a href="/blog/azure-active-directory/azure-ad-consent-framework/">「管理者の承認が必要」のメッセージが表示された場合の対処法</a> という記事を書きました。<br>しかしながら記事を参考に管理者同意を実施したにもかかわらず、一般ユーザーがアプリにアクセスすると「管理者の承認が必要です」の画面が表示されるというお問合せをいただくことがございます。</p><p>アプリから想定外に同意要求がなされるのにはいくつかのパターンがあるのですが、いずれも「同意のフレームワーク」の仕組みについて理解が必要になります。<br>そこで今回の記事では、より技術的な視点で「同意のフレームワーク」がどのように動作するのか、想定外の同意要求はどのようにして発生するのか解説し、その対処方法をご案内します。</p><h2 id="アプリが権限を要求する際の流れ"><a href="#アプリが権限を要求する際の流れ" class="headerlink" title="アプリが権限を要求する際の流れ"></a>アプリが権限を要求する際の流れ</h2><p>具体的なパターンを説明する前に、まずはアプリが実際にリソースへの権限を取得する流れを説明します。</p><h3 id="同意の流れ"><a href="#同意の流れ" class="headerlink" title="同意の流れ"></a>同意の流れ</h3><p>サードパーティー製のアプリが、Azure AD で保護されたリソースにアクセスを行う場合、概ね以下のような流れになります。</p><ol><li>アプリが Azure AD の認可 (authorize) エンドポイントにアクセスし、ユーザーの同意を得る</li><li>同意を得た結果 (authorize code) を元にリソースアクセスに必要なトークン (access token) を取得する</li><li>トークンを利用し、保護されたリソース (API) の呼び出しを実施する</li></ol><p><img src="/blog/azure-active-directory/azure-ad-consent-framework-advance/consent-flow.png" alt="consent flow"></p><div class="alert is-info"><p class="alert-title">Note</p><p>認証部分は省略しており、サインイン済みの状態を想定しています</p></div><p>アプリは 1 の Step で動作に必要な権限を指定します。以前の記事で説明した通り、権限は scope と呼ばれる単位で管理されており、たとえばメール データを取得するアプリであれば <code>Mail.Read</code> を scope に指定しユーザー同意を得る必要があります。</p><h2 id="認可リクエストの詳細"><a href="#認可リクエストの詳細" class="headerlink" title="認可リクエストの詳細"></a>認可リクエストの詳細</h2><p>同意要求は Azure AD の認可 (authorize) エンドポイントを介して実施されます。具体的には、以下のエンドポイントに対し GET リクエストを送信することで、サインイン ユーザーに対し同意要求を実施することが可能です。</p><ul><li><code>https://login.microsoftonline.com/&#123;tenant&#125;/oauth2/v2.0/authorize</code></li></ul><p>実際には上記の URL にアクセスするだけでは、「どのアプリ」が「どのような権限」を求めているか分かりません。オプショナルなパラメーターを除き、最低限必要なパラメーターを含めたリクエストの例は以下の通りです。</p><ul><li><code>https://login.microsoftonline.com/organizations/oauth2/v2.0/authorize?client_id=d6a9ba66-7c70-4c46-a221-39777901836c&amp;scope=Mail.Read&amp;redirect_uri=https%3A%2F%2Fjwt.ms&amp;response_type=code&amp;etc...</code></li></ul><p>URL の末尾 ? から後のクエリ パラメーターは、<code>=</code> で繋がれた Key, Value 形式になっていますが、同意のフレームワークで重要なのは特に以下パラメーターです。</p><table><thead><tr><th align="left">パラメーター</th><th align="left">意味</th><th align="left">例</th></tr></thead><tbody><tr><td align="left">client_id</td><td align="left">アクセス権を要求しているアプリのアプリケーション ID</td><td align="left">d6a9ba66-7c70-4c46-a221-39777901836c</td></tr><tr><td align="left">scope</td><td align="left">アプリが要求している権限</td><td align="left">Mail.Read</td></tr></tbody></table><p>ここでは <code>d6a9ba66-7c70-4c46-a221-39777901836c</code> のアプリが <code>Mail.Read</code> の権限を求めていることが分かります。</p><h2 id="要求を受け取ったユーザーが出来ること"><a href="#要求を受け取ったユーザーが出来ること" class="headerlink" title="要求を受け取ったユーザーが出来ること"></a>要求を受け取ったユーザーが出来ること</h2><p>ユーザーが自身で同意が出来る場合には、同意画面が表示されます。ユーザーの同意が完了するとアプリは同意された API のアクセス許可の範囲で、ユーザーの代わりに API アクセスが出来るようになります。</p><p><img src="/blog/azure-active-directory/azure-ad-consent-framework-advance/user-can-consent.png"></p><p>一方で、ユーザーが自身で同意できない場合には、管理者の承認が必要の画面が表示され、アプリへのアクセスがブロックされます。ユーザーがどのような条件で同意できるかについては、<a href="/blog/azure-active-directory/azure-ad-consent-framework/">以前の記事</a>で解説をしていますので、そちらを確認してください。</p><p>ポイントとして押さえておいていただきたい点としては、ユーザーが <code>Mail.Read</code> に同意済み、あるいは管理者がユーザーの代わりに同意済みの場合には、同意画面は<strong>再度現れることは無く</strong>、トークンの発行まで完了する点です。</p><p><img src="/blog/azure-active-directory/azure-ad-consent-framework-advance/user-already-consented.png"></p><p>つまり、ユーザー同意を制限している環境においても、管理者同意が完了しているアプリに対しては、同意画面は二度と表示がされないはずです。<br>しかしいくつかのシナリオにおいては、ユーザー同意が要求され「管理者の承認が必要です」の画面が表示されてしまいます。</p><h2 id="管理者の同意を実施したのにユーザー同意が要求される-3-つのパターン"><a href="#管理者の同意を実施したのにユーザー同意が要求される-3-つのパターン" class="headerlink" title="管理者の同意を実施したのにユーザー同意が要求される 3 つのパターン"></a>管理者の同意を実施したのにユーザー同意が要求される 3 つのパターン</h2><p>では、どのようなパターンでユーザー同意が要求されてしまうのでしょうか。結論から言うと、以下の 3 つのパターンが挙げられます。</p><ol><li>アプリが同意要求に <code>prompt=consent</code> クエリ パラメーターを付与している</li><li>アプリがすでに同意済みの権限以外の API のアクセス許可を要求している</li><li>静的な同意と動的な同意の差異により、必要な権限に同意が出来ていない</li></ol><p>それぞれのパターンについて説明します。 </p><h3 id="1-アプリが同意要求に-prompt-consent-クエリ-パラメーターを付与している"><a href="#1-アプリが同意要求に-prompt-consent-クエリ-パラメーターを付与している" class="headerlink" title="1. アプリが同意要求に prompt=consent クエリ パラメーターを付与している"></a>1. アプリが同意要求に <code>prompt=consent</code> クエリ パラメーターを付与している</h3><p>ユーザーまたは管理者が同意済みにも関わらず、毎回同意画面が出てしまう要因として考えられるのが、<code>prompt=consent</code> パラメーターです。<br>アプリは認可エンドポイントへのアクセス時に様々な<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-auth-code-flow#request-an-authorization-code">オプション パラメーター</a>を付与することができますが、<code>prompt</code> パラメーターは認可リクエスト時に表示される対話画面を指定します。</p><p><code>prompt</code> パラメーターにより、資格情報の再入力を強制したり、対話的なサインイン画面を省略することを試みたりすることができますが <code>prompt=consent</code> パラメーターはユーザー同意を再度実施するよう強制します。<br>管理者の同意が実施済みであっても、<code>prompt=consent</code> パラメーターが付与されている場合には、必ず同意画面を表示しようと試みるため、ユーザー同意が制限されている環境では「管理者の承認が必要です」のエラー画面が表示されることになります。</p><p>ユーザー同意が制限された環境では <code>prompt=consent</code> パラメーターが付与された同意要求をユーザーが処理することは不可能ですので、ユーザー同意を許可するようテナントの構成を変更するか、アプリが <code>prompt=consent</code> パラメーターを送信しないように改修する必要があります。サードパーティー製アプリの場合には、アプリの開発元にご確認ください。</p><p>パラメーターにより同意画面が表示されているかは、アプリへのアクセス時の通信トレースを確認することで判別できます。Web アプリの場合にはアクセス時にブラウザーの開発者ツール (F12 トレース) を確認することで、authorize エンドポイントへの要求を確認することが可能です。</p><p>開発者ツールの簡単な使い方と同意要求の解析方法は本ブログの<a href="#%E4%BB%98%E9%8C%B2">付録</a>にまとめましたので参考にしてください。</p><h3 id="2-アプリがすでに同意済みの権限以外の-API-のアクセス許可を要求している"><a href="#2-アプリがすでに同意済みの権限以外の-API-のアクセス許可を要求している" class="headerlink" title="2. アプリがすでに同意済みの権限以外の API のアクセス許可を要求している"></a>2. アプリがすでに同意済みの権限以外の API のアクセス許可を要求している</h3><p>Azure AD の同意フレームワークでは「増分および動的な同意」がサポートされています。これは、アプリが必要なタイミングで、必要な権限を要求できるようになる仕組みで、例えば以下のような実装が考えられます。</p><p>アプリは基本的にユーザーのメールボックスと連携するため <code>Mail.Read</code> の権限を要求するが、追加の機能を有効化することで取得したメールの添付ファイルを SharePoint Online に保存が出来る。機能を有効化する際には追加で <code>Files.ReadWrite</code> の権限を要求する。</p><p>このように「増分および動的な同意」の機能により、アプリは必要に応じて、必要なタイミングで同意を要求することが可能です。アプリが最初に要求し同意済みの権限とは別に、追加の権限を要求した場合、そのタイミングでユーザー同意が要求されます。ユーザー同意が制限されている場合には、「管理者の承認が必要です」の画面が表示されます。</p><p>対処方法は 「3. 静的な同意と動的な同意の差異により、必要な権限に同意が出来ていない」のシナリオと同様なので、<a href="#%E5%8B%95%E7%9A%84%E3%81%AA%E6%A8%A9%E9%99%90%E8%A6%81%E6%B1%82%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E5%90%8C%E6%84%8F%E3%82%92%E5%AE%9F%E6%96%BD%E3%81%99%E3%82%8B">動的な権限要求に対して同意を実施する</a> を確認ください。</p><h3 id="3-静的な同意と動的な同意の差異により、必要な権限に同意が出来ていない"><a href="#3-静的な同意と動的な同意の差異により、必要な権限に同意が出来ていない" class="headerlink" title="3. 静的な同意と動的な同意の差異により、必要な権限に同意が出来ていない"></a>3. 静的な同意と動的な同意の差異により、必要な権限に同意が出来ていない</h3><p>本パターンは、本質的には「アプリがすでに同意済みの権限以外の API のアクセス許可を要求している」と同じ要因ですが、特にお問合せを頂くことが多いため、個別に説明します。</p><p>ここまで説明した「増分および動的な同意」機能は柔軟な権限要求を実装でき、アプリの機能拡張などをしやすくするメリットがあります。ただ動的な要求が出来る性質上、<strong>同意を実施するまでは本当にアプリの動作に必要な権限が分かりません。</strong><br>これは実際に<strong>アプリを利用するタイミングでしか必要な権限が何か分からない</strong>ことを意味しています。</p><div class="alert is-info"><p class="alert-title">Note</p><p>正確にはアプリが authorize エンドポイントに認可リクエストを送信する際、必要な API のアクセス許可として指定する scope パラメーターを確認するまで、動的なアクセス許可が特定できません</p></div><p>この性質により、<strong>実際のアプリの利用時</strong>以外に同意を実施した際に、本当に必要な権限に同意が出来ないことがあります。より具体的には、エンタープライズ アプリケーションのアクセス許可から管理者の同意を付与するパターンでは動的に要求される権限に同意が出来ずに問題となる場合があります。</p><h4 id="Azure-ポータル上から実施するアクセス許可への同意"><a href="#Azure-ポータル上から実施するアクセス許可への同意" class="headerlink" title="Azure ポータル上から実施するアクセス許可への同意"></a>Azure ポータル上から実施するアクセス許可への同意</h4><p>Azure ポータルのエンタープライズ アプリケーションから、登録されたアプリを選択し [アクセス許可] ブレードに移動すると、管理者同意を実施するボタンがあります。</p><p><a href="../azure-active-directory/azure-ad-consent-framework/#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-1-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E7%AE%A1%E7%90%86%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%A7%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%82%92%E8%A1%8C%E3%81%84%E3%80%81%E7%B5%84%E7%B9%94%E3%81%AE%E4%BB%A3%E7%90%86%E3%81%A8%E3%81%97%E3%81%A6%E5%90%8C%E6%84%8F%E3%81%99%E3%82%8B%E3%81%AB%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%82%92%E3%81%84%E3%82%8C%E3%81%A6%E5%90%8C%E6%84%8F%E3%82%92%E4%BB%98%E4%B8%8E%E3%81%99%E3%82%8B">「管理者の承認が必要」のメッセージが表示された場合の対処法</a> では、実際にグローバル管理者権限でアプリにサインインを実施し、同意画面で要求された権限に対し [組織の代理として同意する] 方法をお勧めしました。<br>しかし [組織の代理として同意する] にチェックをつけ忘れて承諾した場合、グローバル管理者はユーザー同意を完了させますので、その後アプリが同じ権限のみを求める限り、二度と同意画面が表示されることはありません。</p><p>その際の代替方法として、エンタープライズ アプリケーションの [アクセス許可] ブレードから管理者の同意を付与する方法を紹介しました。</p><p><img src="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-consent-framework/consent-to-enterprise-application.png" alt="アクセス許可"></p><p>上記の [Contoso に管理者の同意を与えます] ボタンをクリックすることで、要求された権限が表示され管理者同意を実施できます。</p><p>前述の通り、アプリが要求している権限はアプリへのアクセス時にしか分かりません。しかし、エンタープライズ アプリケーションの [アクセス許可] ブレードからの同意ではアプリにアクセスせず Azure ポータル上で処理が完結します。<br>Azure ポータル上では一体何の権限に同意しているのでしょうか。</p><h4 id="静的なアクセス許可"><a href="#静的なアクセス許可" class="headerlink" title="静的なアクセス許可"></a>静的なアクセス許可</h4><p>結論から言うと、エンタープライズ アプリケーションの [アクセス許可] ブレードの同意ボタンでは、アプリケーション開発者が設定した [静的なアクセス許可] に同意します。</p><p>アプリの開発者はアプリの開発テナントに登録されたアプリケーション オブジェクトに、あらかじめ必要と考えられる API のアクセス許可、静的なアクセス許可 (構成されたアクセス許可) を定義しておくことが可能です。</p><p><img src="/blog/azure-active-directory/azure-ad-consent-framework-advance/configured-permissions.png" alt="アプリ開発者が設定する静的なアクセス許可"></p><p>事前定義された API のアクセス許可は、以前のバージョンである Azure AD の v1.0 エンドポイントを利用する際に利用されますが、現在主流の v2.0 エンドポイントではほとんど利用されません。</p><p>しかしながら Azure ポータルからアプリに同意を付与する場合には、何の権限に同意すれば良いのかの情報がないため、v1.0 エンドポイントで利用されていた  [静的なアクセス許可] に同意が付与されます。</p><p>結果として、アプリの開発者がアプリの実装時に動的に求める権限 (scope パラメーター) と、Azure AD にあらかじめ登録された [静的なアクセス許可] に差異が生じることがあります。</p><p>例えばアプリ上では <code>Mail.Read</code> の権限を動的に要求しているのにもかかわらず、[静的なアクセス許可] には <code>User.Read</code> のみが設定されていた場合、いくら Azure ポータル上で管理者同意を実施しても <code>User.Read</code> にしか管理者同意が付与されません。そのため、一般ユーザーが <code>Mail.Read</code> の権限を動的に要求しているアプリにアクセスした際には、ユーザー同意が求められ、ユーザー同意が制限された環境では「管理者の承認が必要です」のエラーが表示されることが想定されます。</p><div class="alert is-info"><p class="alert-title">Note</p><p>現在 Azure AD の同意フレームワークでは「増分および動的な同意」がサポートされていますが、以前からサポートされていたわけではありません。</p><p>現在 Azure AD の同意エンドポイントは、MSAL ライブラリでも利用され、主流の v2.0 エンドポイントと、ADAL ライブラリで利用されていた旧来の v1.0 エンドポイントの 2 種類があります。</p><p>v1.0 のエンドポイントではあらかじめアプリの動作に必要な API の権限を定義しておき、定義された権限にのみ同意を実施する「静的な同意」のみをサポートしていました。</p></div><h3 id="動的な権限要求に対して同意を実施する"><a href="#動的な権限要求に対して同意を実施する" class="headerlink" title="動的な権限要求に対して同意を実施する"></a>動的な権限要求に対して同意を実施する</h3><p>2, 3 で紹介した差分同意や動的な権限要求を実施するアプリに対しては、<strong>実際にアプリを利用する</strong>タイミングで求められた権限に同意を実施する必要があります。一つの方法が前回のブログで紹介したグローバル管理者でサインインを実施し [組織の代理として同意する] オプションにチェックを付けたうえで同意を行う方法です。[組織の代理として同意する] にチェックを付け忘れて同意を実施した場合には、エンタープライズ アプリを削除するなどして同意を取り消し、再度同意画面を表示させるという方法が考えられます。</p><p>他の方法としては <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/configure-admin-consent-workflow">管理者の同意ワークフロー</a> を構成いただくことで<strong>ユーザーがアプリ利用時に求められた権限</strong>を把握し、管理者が同意することが可能です。管理者の同意ワークフローではグローバル管理者以外のユーザーでも同意が可能なため、柔軟な運用が可能になります。</p><p>さらに細かい制御を実施したり、特定の権限にのみ同意を実施する方法は、後述の付録をご確認ください。</p><h2 id="付録"><a href="#付録" class="headerlink" title="付録"></a>付録</h2><p>[組織の代理として同意する] チェックボックスでの同意や、管理者の同意ワークフローを利用できない場合、あるいは管理者の同意ではなく特定ユーザーにのみ同意を付与したい、といったシナリオではアプリが求めている API のアクセス許可を正確に把握する必要が出てきます。その際に有効なツールがブラウザーの開発者ツール (F12 トレース) です。</p><h3 id="F12-トレースの確認方法"><a href="#F12-トレースの確認方法" class="headerlink" title="F12 トレースの確認方法"></a>F12 トレースの確認方法</h3><p>採取の仕方はブラウザーによって細かな違いがありますが、概ね以下の通りです。</p><ol><li>ブラウザーを開きます。</li><li>F12 を押し、開発者ツールを起動します。</li><li>[ネットワーク タブ] を選択します。</li><li>“ログの保持” にチェックが入った状態 (有効) にします。</li><li>同意を行うアプリにアクセスし組織アカウントでのサインインを実施します。</li></ol><p><img src="/blog/azure-active-directory/azure-ad-consent-framework-advance/developer-tools.png" alt="Edge の開発者ツール"></p><p>採取した通信のうち、<code>https://login.microsoftonline.com/organizations/oauth2/v2.0/authorize</code> へのアクセスを探し、ペイロードのクエリ文字列パラメーターを確認することで、authorize エンドポイントに対するリクエストの内容が分かります。</p><p>上記の例では <code>client_id</code> (アプリケーション ID) が <code>d6a9ba66-7c70-4c46-a221-39777901836c</code> のアプリが権限を要求していること、<code>scope</code> として <code>User.Read offline_access</code> が要求されていること、<code>prompt</code> として <code>consent</code> が指定されているため、明示的な再同意が求められていることが確認できます。</p><p>なお上記のログは、ダウンロード ボタン (↓) を選択することで har ファイルとしてダウンロード頂けます。サポート サービスをご利用いただく場合には、調査に有用な情報となりますので、問い合わせの際には添付いただくことをお勧めします。</p><h3 id="管理者の同意エンドポイント"><a href="#管理者の同意エンドポイント" class="headerlink" title="管理者の同意エンドポイント"></a>管理者の同意エンドポイント</h3><p>具体的なアプリケーション ID と求められている権限が分かれば、管理者の同意を付与するためのリンクを作成することが可能です。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/v2-admin-consent">管理者の同意エンドポイント (v2.0)</a> は、以下のような形式の URL です。</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET https://login.microsoftonline.com/&#123;tenant&#125;/v2.0/adminconsent</span><br><span class="line">        ?client_id=&#123;client_id&#125;</span><br><span class="line">        &amp;scope=&#123;scope&#125;</span><br><span class="line">        &amp;redirect_uri=&#123;redirect_uri&#125;</span><br><span class="line">        &amp;state=12345</span><br></pre></td></tr></table></figure><p><code>client_id</code> と <code>scope</code> は <code>redirect_uri</code> はトレースなどで得られた値を指定します。<code>tenent</code> は GUID または &lt;初期ドメイン&gt;.onmicrosoft.com などのドメイン名を指定します。<br>たとえば、先ほどの F12 トレースで解析したアプリに対し、管理者同意を実施するには以下のような URL を組み立ててクラウド アプリケーション管理者などの管理者アカウントでアクセスします。</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET https://login.microsoftonline.com/oauth2beginner.onmicrosoft.com/v2.0/adminconsent</span><br><span class="line">        ?client_id=d6a9ba66-7c70-4c46-a221-39777901836c</span><br><span class="line">        &amp;scope=User.Read%20offline_access</span><br><span class="line">        &amp;redirect_uri=https%3A%2F%2Fjwt.ms</span><br><span class="line">        &amp;state=12345</span><br></pre></td></tr></table></figure><p>管理者アカウントでアクセスした場合には、以下のような同意画面が表示され管理者の同意を実施できます。</p><p><img src="/blog/azure-active-directory/azure-ad-consent-framework-advance/admin-consent-review.png" alt="管理者の同意エンドポイント"></p><p>同意が正常に完了すると、redirect_uri に指定した URL に以下のような応答が返却されます。</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line">https://jwt.ms</span><br><span class="line">    ?admin_consent=True</span><br><span class="line">    &amp;tenant=&#123;tenant-gui&#125;</span><br><span class="line">    &amp;scope=&#123;scope&#125;</span><br><span class="line">    &amp;state=12345</span><br></pre></td></tr></table></figure><p>リダイレクト URI には Azure ポータルの同意ボタンで利用される <code>https://portal.azure.com/TokenAuthorize</code> を指定しても構いません。</p><h3 id="特定のユーザーに対しての同意を管理者が実施する"><a href="#特定のユーザーに対しての同意を管理者が実施する" class="headerlink" title="特定のユーザーに対しての同意を管理者が実施する"></a>特定のユーザーに対しての同意を管理者が実施する</h3><p>アプリが求めている権限が分かれば、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/grant-consent-single-user?pivots=msgraph-powershell">PowerShell を使用して 1 人のユーザーに代わって同意を許可する</a> のように、特定のユーザーの代わりに管理者が同意することも可能です。<br>通常アプリに対するユーザーの制限は <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/howto-restrict-your-app-to-a-set-of-users">ユーザーの割り当てが必要ですか？</a> のオプションを [はい] に設定し、アクセスを許可するユーザーを割り当てることが適切です。</p><p>一方で、ユーザーにより付与したい権限が変わるようなシナリオでは個別のユーザー同意を付与する API を利用できます。たとえば Microsoft Graph SDK や Microsoft Graph Explorer など、付与する権限によって出来ることが変わるアプリに対し、特定のユーザーにはサインイン ログが見れるアクセス許可を、特定のユーザーにはユーザー一覧が取得できるアクセス許可を付与するといったことが可能です。</p><h3 id="Microsoft-Graph-SDK-のサンプル"><a href="#Microsoft-Graph-SDK-のサンプル" class="headerlink" title="Microsoft Graph SDK のサンプル"></a>Microsoft Graph SDK のサンプル</h3><p>以下にユーザー委任のアクセス許可に関する PowerShell のサンプルを記載します。</p><h4 id="特定アプリに実施した同意情報を取得"><a href="#特定アプリに実施した同意情報を取得" class="headerlink" title="特定アプリに実施した同意情報を取得"></a>特定アプリに実施した同意情報を取得</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># クラウド アプリケーション管理者権限でサインイン</span></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scope</span> <span class="string">&quot;Application.Read.All,DelegatedPermissionGrant.ReadWrite.All&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 権限を割り当てたアプリのサービス プリンシパル オブジェクトの取得</span></span><br><span class="line"><span class="variable">$sp</span> = <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-Filter</span> <span class="string">&quot;appId eq &#x27;&lt;AppId&gt;&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 付与された同意情報を取得</span></span><br><span class="line"><span class="variable">$delegatedPermissions</span> = <span class="built_in">Get-MgOauth2PermissionGrant</span> <span class="literal">-Filter</span> <span class="string">&quot;clientId eq &#x27;<span class="variable">$</span>(<span class="variable">$sp</span>.Id)&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$delegatedPermissions</span> | <span class="built_in">Format-List</span> Id, ConsentType, PrincipalId, ResourceId, Scope</span><br><span class="line"></span><br><span class="line"><span class="comment"># ClientId             : クライアント アプリの &quot;オブジェクト ID&quot; (ClientID ではない)</span></span><br><span class="line"><span class="comment"># Id                   : Oauth2PermissionGrant オブジェクトの ID</span></span><br><span class="line"><span class="comment"># ConsentType          : 管理者同意の場合 AllPrincipals, ユーザー同意は Principal</span></span><br><span class="line"><span class="comment"># PrincipalId          : ユーザー同意の場合のユーザー オブジェクト ID</span></span><br><span class="line"><span class="comment"># ResourceId           : リソースのオブジェクト ID</span></span><br><span class="line"><span class="comment"># Scope                : 同意済みの API のアクセス許可のリスト</span></span><br></pre></td></tr></table></figure><h4 id="特定アプリに対するすべてのユーザー委任の同意を削除"><a href="#特定アプリに対するすべてのユーザー委任の同意を削除" class="headerlink" title="特定アプリに対するすべてのユーザー委任の同意を削除"></a>特定アプリに対するすべてのユーザー委任の同意を削除</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># クラウド アプリケーション管理者権限でサインイン</span></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scope</span> <span class="string">&quot;Application.ReadWrite.All,DelegatedPermissionGrant.ReadWrite.All&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 権限を割り当てたアプリのサービス プリンシパル オブジェクトの取得</span></span><br><span class="line"><span class="variable">$sp</span> = <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-Filter</span> <span class="string">&quot;appId eq &#x27;&lt;AppId&gt;&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 付与された同意を取得</span></span><br><span class="line"><span class="variable">$delegatedPermissions</span> = <span class="built_in">Get-MgOauth2PermissionGrant</span> <span class="literal">-Filter</span> <span class="string">&quot;clientId eq &#x27;<span class="variable">$</span>(<span class="variable">$sp</span>.Id)&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 付与された同意を削除</span></span><br><span class="line"><span class="variable">$delegatedPermissions</span> | <span class="built_in">ForEach-Object</span>&#123; <span class="built_in">Remove-MgOauth2PermissionGrant</span> <span class="literal">-OAuth2PermissionGrantId</span> <span class="variable">$_</span>.Id &#125; </span><br></pre></td></tr></table></figure><h5 id="特定アプリに対する管理者の同意のみを削除"><a href="#特定アプリに対する管理者の同意のみを削除" class="headerlink" title="特定アプリに対する管理者の同意のみを削除"></a>特定アプリに対する管理者の同意のみを削除</h5><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># クラウド アプリケーション管理者権限でサインイン</span></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scope</span> <span class="string">&quot;Application.ReadWrite.All,DelegatedPermissionGrant.ReadWrite.All&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 権限を割り当てたアプリのサービス プリンシパル オブジェクトの取得</span></span><br><span class="line"><span class="variable">$sp</span> = <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-Filter</span> <span class="string">&quot;appId eq &#x27;&lt;AppId&gt;&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 付与された管理者同意を取得</span></span><br><span class="line"><span class="variable">$adminConsents</span> = <span class="built_in">Get-MgOauth2PermissionGrant</span> <span class="literal">-Filter</span> <span class="string">&quot;clientId eq &#x27;<span class="variable">$</span>(<span class="variable">$sp</span>.Id)&#x27; and consentType eq &#x27;AllPrincipals&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 付与された管理者同意を削除</span></span><br><span class="line"><span class="variable">$adminConsents</span> | <span class="built_in">ForEach-Object</span>&#123; <span class="built_in">Remove-MgOauth2PermissionGrant</span> <span class="literal">-OAuth2PermissionGrantId</span> <span class="variable">$_</span>.Id &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Identity チームの埴山です。&lt;br&gt;不正なアプリを利用した攻撃を防ぐ目的で、一般ユーザーによる同意を制限しているお客様から、管理者同意に関するお問合せを多く頂いております。&lt;/p&gt;
&lt;p&gt;そこで以前、&lt;a href=&quot;/blog/azure-</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="OAuth" scheme="https://jpazureid.github.io/blog/tags/OAuth/"/>
    
    <category term="Application" scheme="https://jpazureid.github.io/blog/tags/Application/"/>
    
  </entry>
  
  <entry>
    <title>よくわかるアカウント ロックアウトとよくある質問</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/comprehend-account-lockout/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/comprehend-account-lockout/</id>
    <published>2023-02-22T00:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.279Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、 Azure Identity サポート チームの小出です。</p><p>今回は、スマート ロックアウトの機能とアカウントがロックアウトしてしまったときの対処策について、シナリオ別にご案内します。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Azure AD や Microsoft 365 サービスをご利用いただくなかで、利用者様より、”サインインできません” や “アカウントがロックアウトされてしまいました” といった連絡をもらうことがあると思います。これは Azure AD では総当たり攻撃などを防ぐために、パスワードを一定の回数連続して間違えると、しばらくの間アカウントがロックされる機能があるためです。これによりサインインできない状況が考えられます。</p><p>マイクロソフトではパスワードレスへの移行を推奨していますが、ほとんどのお客様はパスワードを使用してサインインしている状況かと思います。そのような中、パスワードの設定や機能について、どのようなことができるのかについてお問い合わせいただくことがあります。Azure AD ではパスワードに対する保護機能として、スマート ロックアウトと呼ばれるものが提供されています。今回は、以前ブログとして公開しました <a href="https://jpazureid.github.io/blog/azure-active-directory/comprehend-password-policy/">パスワード ポリシーの機能</a> と併せて、Azure AD のスマート ロックアウトに関する内容についてご案内します。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ol><li><p><a href="#idx1">ロックアウトの概要</a></p></li><li><p><a href="#idx2">スマート ロックアウトの確認方法</a></p></li><li><p><a href="#idx3">シナリオ別の対処方法</a></p><ul><li><a href="#idx3-1">同期ユーザーがオンプレミス側でロックアウトしたとき</a></li><li><a href="#idx3-2">パスワード ハッシュ同期環境で、同期ユーザーが Azure AD 側でロックアウトしたとき</a></li><li><a href="#idx3-3">パススルー認証環境の同期ユーザーが、 Azure AD 側でロックアウトした時</a></li><li><a href="#idx3-4">AD FS 環境の同期ユーザーが、 Azure AD 側でロックアウトした時</a></li><li><a href="#idx3-5">クラウド ユーザーがロックアウトしたとき</a></li><li><a href="#idx3-6">ゲスト ユーザーからロックアウトの連絡があったとき</a></li></ul></li><li><p><a href="#idx4">攻撃されていると思ったら</a></p></li><li><p><a href="#idx5">補足情報（よくある質問）</a></p></li></ol><hr><h2 id="idx2">1. ロックアウトの概要</h2><p>サインイン時にパスワードを複数回間違えると、アカウントを一時的にロックする機能が用意されています。オンプレミス AD 環境でコンピューターにサインインするときには、以下のようなメッセージを目にすることがあると思います。</p><p><img src="/blog/azure-active-directory/comprehend-account-lockout/comprehend-account-lockout1.png"></p><p>このメッセージが表示されたときは、一般的にヘルプデスクなどに依頼し、オンプレミス AD からロックアウトを解除してもらう、または ロックアウトが解除されるまで待つといった対処となりますが、Azure AD にも同様の機能が用意されており、Azure AD ではスマート ロックアウトと呼ばれています。</p><p>スマート ロックアウトの機能は、オンプレミス AD のロックアウト機能と似たものと考えていただいてよいですが、いくつかの点でより改善されています。例えば、攻撃者と正規ユーザーを分別し、ロックアウト ウンターを別々に管理することで、仮にアカウントが攻撃を受けたとしても、正規ユーザーがロックアウトされないようにするなど、より賢くロックアウトを行うよう改善されています。その他にもポリシーとしてマイクロソフトのセキュリティのベストプラクティスが適用されています。</p><p>一方で、オンプレミス AD のロックアウト機能のように、”ロックアウトされたら必ず管理者が解除する” ように構成することはできないなど、オンプレミス AD と比べてカスタマイズ可能な点が限られている部分はあります。しかし、これはマイクロソフトのベストプラクティスを適用し、お客様独自のカスタマイズを行うことで逆にセキュリティが低下することを防ぐことにもつながっています。</p><h2 id="idx1">2. スマート ロックアウトの確認方法</h2><p>次に、スマート ロックアウトの機能でアカウントがロックされると、どのような動作となるかご案内します。</p><p>通常、間違ったパスワードを入力すると、以下のようなメッセージが表示されます。</p><p><img src="/blog/azure-active-directory/comprehend-account-lockout/comprehend-account-lockout2.png"></p><p>このときのサインイン ログには、上記のメッセージと同様に、誤ったユーザー名もしくはパスワードが使用されているエラーであることが分かります。</p><p><img src="/blog/azure-active-directory/comprehend-account-lockout/comprehend-account-lockout3.png"></p><p>一方、スマート ロックアウトによって一時的にロックアウトされているときは、以下のようなメッセージに変わります。ロックアウトされている間は、正しいパスワードを入力してもサインインできません。</p><p><img src="/blog/azure-active-directory/comprehend-account-lockout/comprehend-account-lockout4.png"></p><p>このとき、サインイン ログには、エラーの理由に “The account is locked (アカウントがロックされています)” と記載されます。</p><p><img src="/blog/azure-active-directory/comprehend-account-lockout/comprehend-account-lockout5.png"></p><h2 id="idx3">3. シナリオ別の対処方法</h2><p>テナントには同期ユーザーおよびクラウド ユーザー、ゲスト ユーザーなど様々な種類のユーザーが存在するため、ロックアウトしたときの対処策はそれぞれ異なります。特に、Azure AD 側とオンプレミス AD 側のどちらでロックアウトされているかという点は混乱しやすい点です。</p><p>対処策を確認する際には、”ユーザーがどこにサインインしようとしていて、その認証はどこで行われるか” という点が重要です。それぞれシナリオごとに対処方法を記載しておりますのでご確認ください。</p><h3 id="idx3-1">シナリオ 1: 同期ユーザーがオンプレミス AD 側でロックアウトされた場合</h3><p>ユーザーがドメイン コントローラーやオンプレミスのコンピューターにサインインする際にロックアウトされるシナリオです。この場合、オンプレミス AD 側のロックアウト ポリシーでアカウントがロックアウトされています。そして通常、このシナリオの場合は、ヘルプデスクなどに依頼してオンプレミス側でアカウント ロックを解除してもらうことも多いと思います。このシナリオの場合、オンプレミス環境内での認証のため、Azure AD のスマート ロックアウトは動作しません。</p><p>管理者はドメイン コントローラーにサインインし、以下の手順にてアカウント ロックを解除できます。</p><ol><li><p>ドメイン コントローラーにサインインします。</p></li><li><p>[Active Directory ユーザーとコンピューター] を開きます。</p></li><li><p>ロックアウト状態を解除させたいユーザーを検索し、右クリック - [プロパティ] を選択します。</p></li><li><p>[アカウント] タブ内、下記アカウント ロックアウトを解除するためのチェックをオンにして、変更を反映させます。</p><p> <img src="/blog/azure-active-directory/comprehend-account-lockout/comprehend-account-lockout6.png"></p></li></ol><p>管理者は、例えば Default Domain Policy 内、 [アカウント ポリシー] - [アカウント ロックアウトのポリシー] にて、アカウントのロックアウトのしきい値やロックアウト期間を設定することができます。</p><p><img src="/blog/azure-active-directory/comprehend-account-lockout/comprehend-account-lockout7.png"></p><h3 id="idx3-2">シナリオ 2: パスワード ハッシュ同期環境の同期ユーザーが Azure AD 側でロックアウトされた場合</h3><p>パスワード ハッシュ同期の環境では、 Azure ポータルや Microsoft 365 サービスにサインインする際、同期ユーザーであっても Azure AD 側で認証されます。そのため、この場合は、スマート ロックアウトの機能でアカウントがロックアウトされます。既定ではロックアウト時間は 1 分のため、オンプレミス AD のロックアウトのように管理者に依頼する間もなく、ロックアウト状態が解除されます。</p><p>なお、公開情報にも記載がありますが、ロックアウトの最中に管理者がロックアウトを解除することはできません。代わりに、ユーザーが SSPR にてパスワードをリセットすることでロックを解除することが可能ですので、以下に手順を記載します。</p><ol><li><p><a href="http://aka.ms/sspr">http://aka.ms/sspr</a> へアクセスします。</p></li><li><p><a href="https://passwordreset.microsoftonline.com/">https://passwordreset.microsoftonline.com/</a> の画面に遷移し、下記の画面が表示されるので、UPN と文字列を入力します。</p><p> <img src="/blog/azure-active-directory/comprehend-account-lockout/comprehend-account-lockout8.png"></p></li><li><p>パスワード リセットを行うために、事前に登録した電話番号などを入力して認証します。</p><p> <img src="/blog/azure-active-directory/comprehend-account-lockout/comprehend-account-lockout9.png"></p></li><li><p>新しいパスワードを入力します。</p><p> <img src="/blog/azure-active-directory/comprehend-account-lockout/comprehend-account-lockout10.png"></p></li><li><p>下記画面が表示されたら、パスワードのリセットは完了です。</p><p> <img src="/blog/azure-active-directory/comprehend-account-lockout/comprehend-account-lockout11.png"></p></li></ol><p>なお、時間が経過してロックアウトが解除された場合（既定では、ロックアウトから 1 分経過した場合）、次のサインイン時にもパスワードを間違えると、アカウントは即座にロックアウトされます。<br>このときは、1 分より長い時間アカウントがロックアウトされるような動作となります。具体的に何分ロックアウトされるかなどの詳細はセキュリティ上公開しておりませんが、ロックアウト回数が増加するたびにロックアウト時間を延長するため、攻撃者がパスワードの総当たりを行うことを抑止することに役立ちます。</p><h3 id="idx3-3">シナリオ 3: パススルー認証環境の同期ユーザーが Azure AD 側でロックアウトされた場合</h3><p>パススルー認証 (PTA) をご利用いただいている場合、Azure AD 側とオンプレミス AD 側のロックアウト ポリシーの両方を考慮する必要があります。これは、このシナリオでサインインしようとする場合、下記のようなフローを辿るためです。</p><ol><li>利用者がユーザー名とパスワードを入力します。</li><li>Azure AD は「今 Azure AD 側でロックアウトしているのか？」を判断します。</li><li>Azure AD が「今 Azure AD 側でロックアウトしている」と判断した場合、オンプレミス AD 側に認証を要求せず、Azure AD 側でロックアウトされている旨が表示され、以降の処理が行われません。</li><li>Azure AD が「今 Azure AD 側でロックアウトしていない」と判断した場合、オンプレミス AD 側に認証要求を転送します。</li><li>オンプレミス AD 側のロックアウト ポリシーに抵触していなければ、 認証結果が Azure AD に返されます。</li><li>認証結果に応じて Azure AD へのサインインの可否が判断されます。</li></ol><p>上記のようなフローを辿るため、Azure AD のスマート ロックアウトの機能と、オンプレミス AD のロックアウトの機能が両方関連します。パススルー認証をご利用の場合、スマート ロックアウトを構成するときの「ロックアウト回数のしきい値」に着目ください。</p><p>具体的には、 Azure AD のスマート ロックアウトのしきい値が 10 回、オンプレミス AD のアカウントのロックアウトのしきい値が 20 回など、オンプレミス AD の回数の方が 2 から 3 倍程度多くなるように設定します。これは、仮にクラウド側で攻撃を受けた場合に、同じ回数でロックアウトしてしまうと、利用者がオンプレミス AD 側のリソースへもアクセスできなくなってしまうことを防ぐためです。</p><p>攻撃を受けた場合に先に Azure  AD 側のアカウントをロックアウトしておけば、上記 3 にて「今 AzureAD 側でロックアウトしている」と判断されるため、オンプレミス AD 側に認証が要求されず、オンプレミス AD 側の影響を少なくすることができます。</p><h3 id="idx3-4">シナリオ 4: フェデレーション (AD FS) 環境の同期ユーザーが AD FS 側でロックアウトされた場合</h3><p>AD FS を利用している場合、Azure AD へサインインしようとすると、AD FS に誘導され、AD FS を介してオンプレミス AD に対して認証が行われます。</p><p>例えばこの場合、AD FS の認証画面でパスワードを 10 回間違えると、オンプレミス AD 側のロックアウトカウンターが 10 上昇します。このため、オンプレミス AD 側のロックアウト ポリシーを適用することが可能ですが、攻撃を受けて繰り返しサインインに失敗すると、オンプレミス AD 側でロックアウトが発生し、オンプレミスのリソースへもアクセスできなくなってしまう可能性があります。</p><p>一般的な要望として「クラウド側から攻撃を受けたとしても、オンプレミス AD 側はロックアウトさせたくない」という場合、パススルー認証の場合と同様にロックアウトのしきい値の考慮が必要です。AD FS の場合、下記 AD FS エクストラネット スマートロックアウトの機能を利用することになります。エクストラネット スマートロックアウトは、外部から (WAP 経由) のサインインに対してロックアウトを行う機能です。外部から (WAP 経由) のサインインを AD FS が判別して、必要に応じてロックアウトを行います。</p><p><a href="https://learn.microsoft.com/ja-jp/windows-server/identity/ad-fs/operations/configure-ad-fs-extranet-smart-lockout-protection">https://learn.microsoft.com/ja-jp/windows-server/identity/ad-fs/operations/configure-ad-fs-extranet-smart-lockout-protection</a></p><p>事前に AD FS のエクストラネット スマートロックアウトのしきい値を 10 回、オンプレミス AD 側のロックアウトのしきい値は 20 回などと設定しておくと、アカウントが外部から (WAP 経由で) 攻撃された場合でも、先に AD FS 側でアカウントをロックアウト (それ以上のオンプレミス AD への認証をブロック) することが可能です。先に AD FS 側でロックアウトさせることができると、「AD FS 側はロックアウトされてしまったが、オンプレミス AD 側のリソースにはアクセスできる」状態となるため、攻撃によりオンプレミス AD 側のリソースへもアクセスできなくなることを防ぐことが可能です。 </p><h3 id="idx3-5">シナリオ 5: Azure AD に直接作成したクラウド ユーザーがロックアウトされた場合</h3><p>同期ユーザーと異なり、クラウド ユーザーはオンプレミス AD 側にアカウントがないため、オンプレミス AD 側でロックアウトされることはありません。そのため、このシナリオの場合、 シナリオ 2 のパスワード ハッシュ同期のユーザーと同様に、Azure AD のスマート ロックアウトの機能でロックアウトされます。対処策もシナリオ 2 と同様です。</p><p>なお、ロックアウトのしきい値やロックアウト期間は、 Azure ポータル上より、以下の手順で変更することができます。カスタマイズには Azure AD Premium P1 ライセンス以上が必要です。</p><ol><li>Azure ポータルにサインインします。</li><li>[Azure Active Directory] - [セキュリティ] - [認証方法] - [パスワード保護] を選択します。</li><li>以下のような画面が表示されることを確認します。 <img src="/blog/azure-active-directory/comprehend-account-lockout/comprehend-account-lockout12.png"></li><li>“ロックアウトのしきい値” と、 “ロックアウト期間（秒単位）” の値をカスタマイズします。</li></ol><table><thead><tr><th>項目</th><th>設定可能な値</th><th>説明</th></tr></thead><tbody><tr><td>ロックアウトのしきい値</td><td>1 - 50 (回数)</td><td>何回パスワードを間違えたときにロックアウトするか設定します。上記では、 3 回パスワードを間違えるとロックアウトするよう設定しています。</td></tr><tr><td>ロックアウト時間 (秒単位)</td><td>5-18000 (秒単位)</td><td>ロックアウトされたときに、どれくらいの時間ロックアウトを行うのか秒単位で指定します。上記では 60 秒 (= 1 分) ロックアウトされる設定となります。</td></tr></tbody></table><h3 id="idx3-6">シナリオ 6: ゲスト ユーザーからアカウントがロックアウトされた旨の連絡が来た場合</h3><p>ゲスト ユーザーのパスワード管理や認証は、ゲストがもともと登録されているホーム テナント側で行われています。そのため、ゲスト ユーザーの場合は、そのユーザーがメンバーとして登録されているテナントの管理者に別途対応を依頼ください。</p><h2 id="idx4">5. 攻撃されていると思ったら</h2><p>Azure AD のスマートロックアウトでは、正規ユーザーと攻撃者用に二つのロックアウト カウンターが用意されています。サインインの場所などを考慮してスマートロックアウトはこれらのカウンターを使い分け、仮に攻撃者がアカウントに繰り返し認証を仕掛けても、攻撃者のみをロックアウトし正規ユーザーは影響を受けないよう、その名のとおりスマートにロックアウト動作を行います。この場合、ユーザーは攻撃されていたとしても、通常どおりサインインが行えますので、利便性とセキュリティの両方が確保できるという状態になります。</p><p>しかしながら、このロックアウト動作も完ぺきではないため、Azure AD 側で攻撃者と正規ユーザーの見分けがつかない場合は、攻撃を受けた正規ユーザーがロックアウトされ、一時的にサインインできなくなる可能性もあります。管理者の皆様におかれましては、まずは Azure AD のサインインログを確認し、攻撃がどの程度の頻度で行われているか、通常使用していない場所からのサインインが成功となっていないかなどを確認ください。</p><p>また、スマート ロックアウトは、攻撃からアカウントを保護するための 1 つの方法でしかありません。攻撃を受け続けている場合、パスワードのみの保護ではいつか突破される可能性もありますので、下記のような対処を実施いただければと思います。</p><ul><li>推測されやすいパスワードであれば、パスワードを推測されにくいものに変更またはリセットする</li><li>MFA を設定し、パスワードのみではサインインできないようにする</li><li>いったんアカウント自体を無効化し、パスワードが合っていてもサインインできないようにする（攻撃を受け続けている場合の一時的な対応です）</li><li>パスワードそのものを利用しない、より安全なパスワードレス認証に移行する。</li></ul><h2 id="idx5">6. 補足情報（よくある質問）</h2><p>最近よくお問い合わせいただく内容を以下に補足します。</p><p><strong>Q. 設定されたしきい値以上に連続でパスワードを間違えました。 10 回連続で間違えたのに、11 回目でロックアウトされません。</strong></p><p>A. 間違ったパスワードを入力する際、同一のパスワードを複数回入力していると、カウントが増えません。毎回異なる誤ったパスワードを入力した場合にカウントが増えます。なお、毎回異なる誤ったパスワードを入力してもロックアウトされない場合は、以下もご確認ください。</p><p><strong>Q. ロックアウトの検証をしています。実行するタイミングによって、ロックアウトされたりされなかったりします。確実にロックアウトされないのはなぜですか。</strong></p><p>A. ロックアウトのカウントは、以前は各データーセンターごとに個別に管理していたため、別のデータセンターでカウントされた分はロックアウト状態に反映されませんでした。現在はデータセンター間でロックアウトのカウントが同期が行われるようになっていますが、サインインのタイミングによってはロックアウトに時間を要することがあります。これは Azure AD のデータセンターが世界中に分散しており、世界中で一瞬にロックアウトカウントを同期することが論理的に難しいためです。そのため、 10 回でロックアウトするよう設定していても、必ず 11 回目にロックアウトするとは限りません。数回程度のズレについては許容くださいますようお願い申し上げます。</p><p><strong>Q. 上記の動作は確認しましたが、どうしても 10 回で確実にロックアウトする必要があります。方法はありませんか？</strong></p><p>A. いいえ、確実に 10 回でロックアウトするという方法はありません。スマート ロックアウトの機能は、ユーザーがパスワード入力を間違えたシナリオよりも、「攻撃から保護する」ことに重点を置いて実装された機能であるため、例えば同じパスワードで間違えたときはカウントしないなど、厳密な回数を重視するよりもアカウントを保護することに重点を置いています。スマート ロックアウトはアカウントを保護するための 1 つの機能でしかないため、セキュリティをより高めたい場合は回数のカウントよりも MFA を併用ください。</p><p><strong>Q. ロックアウトのしきい値を 10 回に設定しています。 5 回パスワードを間違えました。時間をおいて再度サインインを試行した際は、 6 回目のカウントとなりますか？それとも時間をおくと、試行回数がリセットされて 1 回目のカウントになりますか？</strong></p><p>A. 誠に恐れ入りますが、セキュリティの観点より詳細な情報をお伝えすることができません。仮にこのような動作をお伝えすると、「特定の時間を置いてから再度攻撃しよう」などと、攻撃者への参考情報となってしまいます。スマート ロックアウトは、攻撃者に対してのセキュリティ保護の機能となりますため、詳細な情報を公開していない点をご了承ください。</p><p><strong>Q. スマート ロックアウト機能を無効にしたいです。可能ですか？</strong></p><p>A. いいえ、スマート ロックアウト機能を無効にすることはできません。</p><p><strong>Q. スマート ロックアウトのしきい値やロックアウト期間をカスタマイズしたいです。設定がグレーアウトされてしまっています。</strong></p><p>A. スマート ロックアウト設定のカスタマイズを行いたい場合、 Azure AD Premium P1 以上のライセンスが必要です。対象テナントのライセンスの保有状況をご確認ください。なお、カスタマイズする場合、テナントに存在する全員分のライセンスが必要となるためご留意ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、 Azure Identity サポート チームの小出です。&lt;/p&gt;
&lt;p&gt;今回は、スマート ロックアウトの機能とアカウントがロックアウトしてしまったときの対処策について、シナリオ別にご案内します。&lt;/p&gt;
&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめ</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>AD FS 2016 以降の証明書更新手順 (SSLサーバー証明書)</title>
    <link href="https://jpazureid.github.io/blog/active-directory-federation-service/update-ssl-server-certificate-2016+/"/>
    <id>https://jpazureid.github.io/blog/active-directory-federation-service/update-ssl-server-certificate-2016+/</id>
    <published>2023-02-19T15:00:00.000Z</published>
    <updated>2023-03-05T14:02:05.891Z</updated>
    
    <content type="html"><![CDATA[<p>皆様、こんにちは。Azure &amp; Identity サポート担当の竹村です。</p><p>本ブログでは、Windows Server 2016 以降の AD FS における SSL サーバー証明書の更新手順をご案内します。<br>Windows Server 2012 R2 に関しては、<a href="https://jpazureid.github.io/blog/active-directory-federation-service/update-ssl-server-certificate/">こちら</a>をご覧ください。</p><p>また、Powershell のコマンドが失敗する場合には、<a href="https://jpazureid.github.io/blog/active-directory-federation-service/update-ssl-server-certificate-netsh/">こちら</a>の手順でも更新できますので、必要に応じて参照ください。</p><p>対象リリース: Windows Server 2016 以降</p><p>以下の流れで更新作業を行います。</p><h2 id="手順の概要"><a href="#手順の概要" class="headerlink" title="手順の概要"></a>手順の概要</h2><ol><li>証明書の取得</li><li>SSL サーバー証明書、ルート証明書、中間証明書のインストール</li><li>SSL サーバー証明書のアクセス権設定</li><li>AD FS のサービス通信証明書へ SSL サーバー証明書を設定</li><li>AD FS の SSL サーバー証明書を更新</li><li>WAP サーバーを再構成</li></ol><p>それぞれの詳細を紹介します。</p><h2 id="1-証明書の取得"><a href="#1-証明書の取得" class="headerlink" title="1. 証明書の取得"></a>1. 証明書の取得</h2><p>ご利用になる認証機関から SSL サーバー証明書とルート証明書、中間証明書を取得します。<br>認証機関によって CSR 作成・送信、証明書受領手順が異なるため、手順は省略します。</p><h2 id="2-SSL-サーバー証明書、ルート証明書、中間証明書のインストール"><a href="#2-SSL-サーバー証明書、ルート証明書、中間証明書のインストール" class="headerlink" title="2. SSL サーバー証明書、ルート証明書、中間証明書のインストール"></a>2. SSL サーバー証明書、ルート証明書、中間証明書のインストール</h2><p>ご利用になる認証機関から取得した SSL サーバー証明書、ルート証明書、中間証明書を以下手順でインストールします。</p><p>※ インポートする中間証明書の有無や数は、ご利用の認証機関によって異なります。</p><p>全 AD FS サーバー、全 WAP サーバーにて以下を実施します。</p><ol><li><p>[スタート] - [ファイル名を指定して実行] から certlm.msc と入力し、[OK] をクリックします。</p></li><li><p>画面左側から以下のストアを展開します。</p><p> [証明書 (ローカル コンピューター)] - [信頼されたルート証明機関] - [証明書]</p></li><li><p>[証明書] を右クリックし、[すべてのタスク] - [インポート] を選択し、ウィザードに従って SSL サーバー証明書の発行元証明機関のルート証明書をインストールします。</p></li><li><p>続けて、画面左側から以下のストアを展開します。</p><p> [証明書 (ローカル コンピューター)] - [中間証明機関] - [証明書]</p></li><li><p>[証明書] を右クリックし、[すべてのタスク] - [インポート] を選択し、ウィザードに従って SSL サーバー証明書の発行元証明機関の中間証明書をインストールします。</p></li><li><p>続けて、画面左側から以下のストアを展開します。<br>[証明書 (ローカル コンピューター)] - [個人] - [証明書]</p></li><li><p>[証明書] を右クリックし、[すべてのタスク] - [インポート] を選択し、ウィザードに従って SSL サーバー証明書 (秘密鍵付き) をインストールします。</p></li></ol><h2 id="3-SSL-サーバー証明書のアクセス権設定"><a href="#3-SSL-サーバー証明書のアクセス権設定" class="headerlink" title="3. SSL サーバー証明書のアクセス権設定"></a>3. SSL サーバー証明書のアクセス権設定</h2><p>証明書に、AD FS サービス アカウントに必要なアクセス許可を付与します。<br>全 AD FS サーバーにて以下を実施します。</p><ol><li><p>[スタート] - [ファイル名を指定して実行] から certlm.msc と入力し、[OK] をクリックします。</p></li><li><p>画面左側から以下のストアを展開します。</p><p> [証明書 (ローカル コンピューター)] - [個人] - [証明書]</p></li><li><p>中央から、手順 2. でインストールした SSL サーバー証明書を右クリックして、[すべてのタスク] - [秘密キーの管理] をクリックします。</p><p> ※ もし [秘密キーの管理] を実行できない場合は、次のコマンドを実行してください。    このコマンドを実行することにより、個人ストアのすべての証明書のキーの関連付けの修復、または証明書プロパティやキーのセキュリティ記述子の更新を行います。</p> <figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">certutil -repairstore my *</span><br></pre></td></tr></table></figure></li><li><p>NT SERVICE\ADFSSRV (場所はローカルを指定します) を [追加] して、読み取りアクセス許可を付与します。</p></li></ol><h2 id="4-AD-FS-のサービス通信証明書へ-SSL-サーバー証明書を設定"><a href="#4-AD-FS-のサービス通信証明書へ-SSL-サーバー証明書を設定" class="headerlink" title="4. AD FS のサービス通信証明書へ SSL サーバー証明書を設定"></a>4. AD FS のサービス通信証明書へ SSL サーバー証明書を設定</h2><p>AD FS のサービス通信証明書として、SSL サーバー証明書を設定します。<br>プライマリ AD FS サーバーにて以下を実施します。</p><ol><li><p>スタート画面などから [AD FS の管理] コンソールを開きます。</p></li><li><p>画面左側から [AD FS] - [サービス] - [証明書] を右クリックし、 [サービス通信証明書の設定] をクリックします。</p></li><li><p>証明書の選択画面から手順 2. でインストールした SSL サーバー証明書を選択します。</p></li><li><p>[OK] をクリックします。</p><p> ※ 警告が表示されましたら、[OK] をクリックします。</p></li></ol><h2 id="5-AD-FS-の-SSL-サーバー証明書を更新"><a href="#5-AD-FS-の-SSL-サーバー証明書を更新" class="headerlink" title="5. AD FS の SSL サーバー証明書を更新"></a>5. AD FS の SSL サーバー証明書を更新</h2><p>AD FS の SSL サーバー証明書を更新します。AD FS プライマリサーバーにて以下を実施します。</p><p>バージョン 2016 以降では、プライマリサーバーでコマンドを実行しますと、自動的にセカンダリサーバーに接続し、ファーム内すべての AD FS サーバーの SSL 証明書を更新する動作となります。</p><p>また、バージョン 2016 以降では、証明書認証で従来の 49443 ポートを利用しているか、新しい機能である代替 TLS バインドモード (certauth を付与したホスト名の 443 ポート) を利用しているかによって、実行するコマンドが異なります。<br>どちらを利用しているかは、Powershell で以下のように実行して確認できます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-AdfsProperties</span> | findstr TlsClientPort</span><br></pre></td></tr></table></figure><p>49443 と表示される場合には、従来の 49443 ポートを利用する構成です。<br>443 と表示される場合には、代替 TLS バインドモードを利用している構成です。</p><p>以下の手順に従って、確認された構成のコマンドを選択して更新を行います。</p><ol><li><p>ドメイン管理者 (Domain Admins) でプライマリサーバーにログインし、PowerShell を管理者として起動します。</p></li><li><p>起動した PowerShell で、お客さまの環境構成に応じたコマンドを実行して SSL サーバー証明書を更新します。<br><br> 従来の 49443 ポートを利用する場合</p> <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Set-AdfsSslCertificate</span> <span class="literal">-Thumbprint</span> [新しい証明書の拇印]</span><br></pre></td></tr></table></figure><p> 代替 TLS バインドモード (certauth を付与したホスト名の 443 ポート) を利用する場合</p> <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Set-AdfsAlternateTlsClientBinding</span> <span class="literal">-Thumbprint</span> [新しい証明書の拇印]</span><br></pre></td></tr></table></figure><p> ※ 証明書の拇印 (Thumbprint) は、以下のコマンドでご確認頂けます。</p> <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dir</span> Cert:\LocalMachine\My\ | <span class="built_in">FL</span> Thumbprint, Subject, NotBefore, NotAfter</span><br></pre></td></tr></table></figure><p> コンピューターの個人ストアにインポートされている証明書が表示されますので、新しい SSL 証明書の Thumbprint に表示されている文字列をコピーしてご利用ください。<br><br> なお、証明書認証で利用するポートを変更したい場合には、変更先のコマンドを実行します。<br> 例えば、49443 ポートから 443 ポートに変更したい場合には <em>Set-AdfsAlternateTlsClientBinding</em> を実行し、443 ポートから 49443 ポートに変更するには <em>Set-AdfsSslCertificate</em> を実行します。</p></li></ol><h4 id="コマンドでエラーが発生する場合には、以下をご確認ください。"><a href="#コマンドでエラーが発生する場合には、以下をご確認ください。" class="headerlink" title="コマンドでエラーが発生する場合には、以下をご確認ください。"></a>コマンドでエラーが発生する場合には、以下をご確認ください。</h4><p>(お急ぎの場合には、<a href="https://jpazureid.github.io/blog/active-directory-federation-service/update-ssl-server-certificate-netsh/">こちら</a>の手順で更新を行ってください。)</p><h4 id="a-AD-FS-ファーム内のサーバーが正しいかどうかをご確認ください。"><a href="#a-AD-FS-ファーム内のサーバーが正しいかどうかをご確認ください。" class="headerlink" title="(a) AD FS ファーム内のサーバーが正しいかどうかをご確認ください。"></a>(a) AD FS ファーム内のサーバーが正しいかどうかをご確認ください。</h4><p>AD FS プライマリサーバーで、Get-AdfsFarmInformation コマンドレットを実行することで、ファームの FBL (FarmBehaviorLevel) とファームに所属するノードが表示されます。</p><p>(実行例)</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-AdfsFarmInformation</span></span><br><span class="line"></span><br><span class="line">CurrentFarmBehavior FarmNodes</span><br><span class="line">------------------- ---------</span><br><span class="line">                  <span class="number">3</span> &#123;ADFS01.test.com, ADFS02.test.com&#125;</span><br></pre></td></tr></table></figure><p>CurrentFarmBehavior が 3 以上であり、FarmNodes にファーム内に存在する正しいノードが出力されることをご確認ください。</p><h4 id="b-WinHTTP-Proxy-のバイパス設定が正しく設定されているかどうかをご確認ください。"><a href="#b-WinHTTP-Proxy-のバイパス設定が正しく設定されているかどうかをご確認ください。" class="headerlink" title="(b) WinHTTP Proxy のバイパス設定が正しく設定されているかどうかをご確認ください。"></a>(b) WinHTTP Proxy のバイパス設定が正しく設定されているかどうかをご確認ください。</h4><p>AD FS サーバーで、WinHTTP Proxy を利用している場合、AD FS の各ノード、およびフェデレーションサービス名が適切にバイパスされていることをご確認ください。<br>WinHTTP の Proxy は、以下のコマンドで確認可能です。</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">netsh winhttp show proxy</span><br></pre></td></tr></table></figure><p>※ (a) の Get-AdfsFarmInformation コマンドで表示されるノード、およびフェデレーションサービス名がバイパスされていることをご確認ください。</p><h4 id="c-WinRM-が各ノードで利用できることをご確認ください。"><a href="#c-WinRM-が各ノードで利用できることをご確認ください。" class="headerlink" title="(c) WinRM が各ノードで利用できることをご確認ください。"></a>(c) WinRM が各ノードで利用できることをご確認ください。</h4><p>該当のコマンドは、各ノードに WinRM で接続します。<br>以下の観点で、それぞれのサーバーでご確認ください。</p><p>c-1). リモート管理<br><br>[サーバーマネージャー] - [ローカルサーバー] と遷移し、[リモート管理] が “有効” となっていることをご確認ください。</p><p>c-2). Windows Remote Management<br><br>[サーバーマネージャー] - [ツール] から [サービス] を起動し、Windows Remote Managementサービスが開始していることをご確認ください。</p><p>c-3). 5985 番ポートの開放<br><br>リモートアクセスの際に、ポート番号 5985 番を使用した通信が発生いたします。<br>ファイアウォールなどで該当のポートがブロックされていないかどうか、ご確認ください。</p><h4 id="d-ドメインの管理者アカウントでログインし、コマンドを実行しているかどうかをご確認ください。"><a href="#d-ドメインの管理者アカウントでログインし、コマンドを実行しているかどうかをご確認ください。" class="headerlink" title="(d) ドメインの管理者アカウントでログインし、コマンドを実行しているかどうかをご確認ください。"></a>(d) ドメインの管理者アカウントでログインし、コマンドを実行しているかどうかをご確認ください。</h4><p>WinRM への接続時に Kerberos 認証を行いますので、ドメインユーザーである必要があります。<br>また、AD FS サーバーローカルの管理者権限も必要です。<br>Domain Admins グループに所属しているアカウントであればこれらの要件を満たします。</p><p>コマンドの実行に成功いたしましたら、次の WAP の再構成に進みます。</p><h2 id="6-WAP-サーバーを再構成"><a href="#6-WAP-サーバーを再構成" class="headerlink" title="6. WAP サーバーを再構成"></a>6. WAP サーバーを再構成</h2><p>WAP サーバーを再構成します。全 WAP サーバーにて以下を実施します。</p><ol><li><p>レジストリ エディターを開きます。</p></li><li><p>[HKEY_LOCAL_MACHINE\Software\Microsoft\ADFS] を選択します。</p></li><li><p>[ProxyConfigurationStatus] をダブル クリックします。</p></li><li><p>[値のデータ] を 1 にして [OK] をクリックします。</p></li><li><p>スタート画面などから [リモート アクセス管理] コンソールを開きます。</p></li><li><p>画面左側から [構成] - [Web Application Proxy] をクリックします。</p></li><li><p>画面中央から [Web アプリケーション プロキシ構成ウィザードの実行] をクリックします。</p></li><li><p>初期構成時と同様に、WAP サーバーを構成します。</p><p> ※ [AD FS プロキシの証明書] 画面では、手順 2. でインストールした SSL サーバー証明書を選択します。</p></li></ol><blockquote><p>(注意) WAP サーバーの再構成を行う際には、hosts ファイルでフェデレーションサービス名がプライマリ AD FS サーバーに名前解決されるように設定ください。<br>AD FS サーバーと WAP サーバーとの間にロードバランサーが存在する環境の場合、明示的にプライマリ AD FS サーバーに対して接続されるように設定しないと、再構成に失敗することがございます。</p></blockquote><p>手順は以上の通りとなります。上記手順は過去にも同様のお問い合わせをお受けした際、多くのお客様にご案内しております実績のある手順ですが、一度検証環境で一連の動作を確認されることをお勧めいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;皆様、こんにちは。Azure &amp;amp; Identity サポート担当の竹村です。&lt;/p&gt;
&lt;p&gt;本ブログでは、Windows Server 2016 以降の AD FS における SSL サーバー証明書の更新手順をご案内します。&lt;br&gt;Windows Server 20</summary>
      
    
    
    
    
    <category term="AD FS" scheme="https://jpazureid.github.io/blog/tags/AD-FS/"/>
    
  </entry>
  
  <entry>
    <title>netsh コマンドで AD FS サーバーの SSL 証明書を更新する手順</title>
    <link href="https://jpazureid.github.io/blog/active-directory-federation-service/update-ssl-server-certificate-netsh/"/>
    <id>https://jpazureid.github.io/blog/active-directory-federation-service/update-ssl-server-certificate-netsh/</id>
    <published>2023-02-19T15:00:00.000Z</published>
    <updated>2023-03-05T14:02:05.891Z</updated>
    
    <content type="html"><![CDATA[<p>皆様、こんにちは。Azure &amp; Identity サポート担当の竹村です。</p><p>本ブログでは、netsh コマンドで AD FS サーバーの SSL 証明書を更新する手順をご案内します。<br>AD FS サーバーのバージョンに依らず、汎用的に利用できる手順ですので、Powershell のコマンドによる更新がエラーで失敗する場合などにご利用ください。</p><p>以下の流れで更新作業を行います。</p><h2 id="手順の概要"><a href="#手順の概要" class="headerlink" title="手順の概要"></a>手順の概要</h2><ol><li>証明書の取得</li><li>SSL サーバー証明書、ルート証明書、中間証明書のインストール</li><li>SSL サーバー証明書のアクセス権設定</li><li>AD FS のサービス通信証明書へ SSL サーバー証明書を設定</li><li>AD FS の SSL サーバー証明書を更新</li><li>WAP サーバーを再構成</li></ol><p>それぞれの手順の詳細を紹介します。</p><h2 id="1-証明書の取得"><a href="#1-証明書の取得" class="headerlink" title="1. 証明書の取得"></a>1. 証明書の取得</h2><p>ご利用になる認証機関から SSL サーバー証明書とルート証明書、中間証明書を取得します。<br>認証機関によって CSR 作成・送信、証明書受領手順が異なるため、手順は省略します。</p><h2 id="2-SSL-サーバー証明書、ルート証明書、中間証明書のインストール"><a href="#2-SSL-サーバー証明書、ルート証明書、中間証明書のインストール" class="headerlink" title="2. SSL サーバー証明書、ルート証明書、中間証明書のインストール"></a>2. SSL サーバー証明書、ルート証明書、中間証明書のインストール</h2><p>ご利用になる認証機関から取得した SSL サーバー証明書、ルート証明書、中間証明書を以下手順でインストールします。</p><p>※ インポートする中間証明書の有無や数は、ご利用の認証機関によって異なります。</p><p>全 AD FS サーバー、全 WAP サーバーにて以下を実施します。</p><ol><li><p>[スタート] - [ファイル名を指定して実行] から certlm.msc と入力し、[OK] をクリックします。</p></li><li><p>画面左側から以下のストアを展開します。</p><p> [証明書 (ローカル コンピューター)] - [信頼されたルート証明機関] - [証明書]</p></li><li><p>[証明書] を右クリックし、[すべてのタスク] - [インポート] を選択し、ウィザードに従って SSL サーバー証明書の発行元証明機関のルート証明書をインストールします。</p></li><li><p>続けて、画面左側から以下のストアを展開します。</p><p> [証明書 (ローカル コンピューター)] - [中間証明機関] - [証明書]</p></li><li><p>[証明書] を右クリックし、[すべてのタスク] - [インポート] を選択し、ウィザードに従って SSL サーバー証明書の発行元証明機関の中間証明書をインストールします。</p></li><li><p>続けて、画面左側から以下のストアを展開します。<br>[証明書 (ローカル コンピューター)] - [個人] - [証明書]</p></li><li><p>[証明書] を右クリックし、[すべてのタスク] - [インポート] を選択し、ウィザードに従って SSL サーバー証明書 (秘密鍵付き) をインストールします。</p></li></ol><h2 id="3-SSL-サーバー証明書のアクセス権設定"><a href="#3-SSL-サーバー証明書のアクセス権設定" class="headerlink" title="3. SSL サーバー証明書のアクセス権設定"></a>3. SSL サーバー証明書のアクセス権設定</h2><p>証明書に、AD FS サービス アカウントに必要なアクセス許可を付与します。<br>全 AD FS サーバーにて以下を実施します。</p><ol><li><p>[スタート] - [ファイル名を指定して実行] から certlm.msc と入力し、[OK] をクリックします。</p></li><li><p>画面左側から以下のストアを展開します。</p><p> [証明書 (ローカル コンピューター)] - [個人] - [証明書]</p></li><li><p>中央から、手順 2. でインストールした SSL サーバー証明書を右クリックして、[すべてのタスク] - [秘密キーの管理] をクリックします。</p><p> ※ もし [秘密キーの管理] を実行できない場合は、次のコマンドを実行してください。このコマンドを実行することにより、個人ストアのすべての証明書のキーの関連付けの修復、または証明書プロパティやキーのセキュリティ記述子の更新を行います。</p> <figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">certutil -repairstore my *</span><br></pre></td></tr></table></figure></li><li><p>NT SERVICE\ADFSSRV と NT SERVICE\DRS (場所はローカルを指定します) を [追加] して、各アカウントに読み取りアクセス許可を付与します。</p><p> ※ NT SERVICE\DRS アカウントが存在しない場合には、NT SERVICE\ADFSSRV のみにアクセス許可を付与します。<br><br> ※ バージョン 2016 以降の場合、NT SERVICE\DRS アカウントは存在しないため、NT SERVICE\ADFSSRV のみにアクセス許可を付与します。</p></li></ol><h2 id="4-AD-FS-のサービス通信証明書へ-SSL-サーバー証明書を設定"><a href="#4-AD-FS-のサービス通信証明書へ-SSL-サーバー証明書を設定" class="headerlink" title="4. AD FS のサービス通信証明書へ SSL サーバー証明書を設定"></a>4. AD FS のサービス通信証明書へ SSL サーバー証明書を設定</h2><p>AD FS のサービス通信証明書として SSL サーバー証明書を設定します。<br>プライマリ AD FS サーバーにて以下を実施します。</p><ol><li><p>スタート画面などから [AD FS の管理] コンソールを開きます。</p></li><li><p>画面左側から [AD FS] - [サービス] - [証明書] を右クリックし、 [サービス通信証明書の設定] をクリックします。</p></li><li><p>証明書の選択画面から手順 2. でインストールした SSL サーバー証明書を選択します。</p></li><li><p>[OK] をクリックします。</p><p> ※ 警告が表示されましたら、[OK] をクリックします。</p></li></ol><h2 id="5-AD-FS-の-SSL-サーバー証明書を更新"><a href="#5-AD-FS-の-SSL-サーバー証明書を更新" class="headerlink" title="5. AD FS の SSL サーバー証明書を更新"></a>5. AD FS の SSL サーバー証明書を更新</h2><p>AD FS の SSL サーバー証明書を更新します。全 AD FS サーバーにて以下を実施します。</p><ol><li>管理者権限で Powershell を起動し、以下のように実行します。</li></ol><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">netsh http show ssl</span><br></pre></td></tr></table></figure><p>以下のように、バインドされている &lt;ホスト名&gt;:&lt;ポート番号&gt; 毎に状態が表示されます。</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">Hostname:<span class="title">port</span>               : <span class="title">localhost</span>:443</span></span><br><span class="line"><span class="function"><span class="title">Certificate</span> <span class="title">Hash</span>             : &lt;既存の証明書の拇印&gt;</span></span><br><span class="line"><span class="function"><span class="title">Application</span> <span class="title">ID</span>               : &#123;5<span class="title">d89a20c</span>-<span class="title">beab</span>-4389-9447-324788<span class="title">eb944a</span>&#125;</span></span><br><span class="line"><span class="function"><span class="title">Certificate</span> <span class="title">Store</span> <span class="title">Name</span>       : <span class="title">MY</span></span></span><br><span class="line"><span class="function"><span class="title">Verify</span> <span class="title">Client</span> <span class="title">Certificate</span> <span class="title">Revocation</span> : <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">Verify</span> <span class="title">Revocation</span> <span class="title">Using</span> <span class="title">Cached</span> <span class="title">Client</span> <span class="title">Certificate</span> <span class="title">Only</span> : <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">Usage</span> <span class="title">Check</span>                 : <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">Revocation</span> <span class="title">Freshness</span> <span class="title">Time</span>   : 0</span></span><br><span class="line"><span class="function"><span class="title">URL</span> <span class="title">Retrieval</span> <span class="title">Timeout</span>       : 0</span></span><br><span class="line"><span class="function"><span class="title">Ctl</span> <span class="title">Identifier</span>               : (<span class="title">null</span>)</span></span><br><span class="line"><span class="function"><span class="title">Ctl</span> <span class="title">Store</span> <span class="title">Name</span>               : (<span class="title">null</span>)</span></span><br><span class="line"><span class="function"><span class="title">DS</span> <span class="title">Mapper</span> <span class="title">Usage</span>             : <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">Negotiate</span> <span class="title">Client</span> <span class="title">Certificate</span> : <span class="title">Enabled</span></span></span><br></pre></td></tr></table></figure><p>更新前後で、証明書の拇印以外の項目が同一になっていることを確認するために、事前にこのコマンド結果をテキストファイルに出力し、取得しておきます。</p><p>(例)<br>netsh http show ssl &gt; c:\temp\ssl.txt</p><ol start="2"><li><p>更新を行うバインドを特定します。<br>Application ID の項目が、{5d89a20c-beab-4389-9447-324788eb944a} であるものが対象です。<br>({5d89a20c-beab-4389-9447-324788eb944a} は、AD FS で利用されていることを示します。)<br>既定では、以下が対象になりますが、環境によって変わる可能性がありますので、Application ID の値で判断してください。</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">・ localhost:<span class="number">443</span></span><br><span class="line">・ &lt;フェデレーションサービス名&gt;:<span class="number">443</span></span><br><span class="line">・ &lt;フェデレーションサービス名&gt;:<span class="number">49443</span>、 もしくは certauth.&lt;フェデレーションサービス名&gt;:<span class="number">443</span></span><br></pre></td></tr></table></figure></li><li><p>更新対象のバインドを削除します。<br>Powershell で、以下のように実行します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">netsh http delete sslcert hostnameport=localhost:<span class="number">443</span></span><br><span class="line">netsh http delete sslcert hostnameport=&lt;フェデレーションサービス名&gt;:<span class="number">443</span></span><br><span class="line">netsh http delete sslcert hostnameport=&lt;フェデレーションサービス名&gt;:<span class="number">49443</span></span><br></pre></td></tr></table></figure><p>※ 上記は、一例となります。実際には、お客さまの環境に合わせて、手順 2 で特定した対象の &lt;ホスト名&gt;:&lt;ポート番号&gt; を指定して削除してください。</p></li></ol><ol start="4"><li>更新対象のバインドを追加します。<br>Powershell で、以下のように実行します。<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">netsh http add sslcert hostnameport=localhost:<span class="number">443</span> certhash=&lt;新しい証明書の拇印&gt; appid=<span class="string">&#x27;&#123;5d89a20c-beab-4389-9447-324788eb944a&#125;&#x27;</span> certstorename=MY</span><br><span class="line">netsh http add sslcert hostnameport=&lt;フェデレーションサービス名&gt;:<span class="number">443</span> certhash=&lt;新しい証明書の拇印&gt; appid=<span class="string">&#x27;&#123;5d89a20c-beab-4389-9447-324788eb944a&#125;&#x27;</span> certstorename=MY sslctlstorename=AdfsTrustedDevices</span><br><span class="line">netsh http add sslcert hostnameport=&lt;フェデレーションサービス名&gt;:<span class="number">49443</span> certhash=&lt;新しい証明書の拇印&gt; appid=<span class="string">&#x27;&#123;5d89a20c-beab-4389-9447-324788eb944a&#125;&#x27;</span> certstorename=MY clientcertnegotiation=Enable</span><br></pre></td></tr></table></figure>※ 上記は、一例となります。実際には環境に合わせて、手順 2 で特定した対象の &lt;ホスト名&gt;:&lt;ポート番号&gt; を指定して追加してください。</li></ol><p>※ 新しい証明書の拇印 (Thumbprint) は、以下のコマンドで確認します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dir</span> Cert:\LocalMachine\My\ | <span class="built_in">FL</span> Thumbprint, Subject, NotBefore, NotAfter</span><br></pre></td></tr></table></figure><p>※ &lt;フェデレーションサービス名&gt;:443 に関しては、sslctlstorename=AdfsTrustedDevices を付与する必要があります。</p><p>※ &lt;フェデレーションサービス名&gt;:49443、もしくは certauth.&lt;フェデレーションサービス名&gt;:443 に関しては、clientcertnegotiation=Enable を付与する必要があります。</p><ol start="5"><li>更新したバインドを確認し、事前に手順 1 で取得しておいたものと比較します。</li></ol><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">netsh http show ssl</span><br></pre></td></tr></table></figure><p>更新対象のバインドすべてに対し、Certificate Hash のみが新しい証明書のものに変わっており、その他のパラメータは事前に取得したものと合致していることをご確認ください。</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="function">Hostname:<span class="title">port</span>               : <span class="title">localhost</span>:443</span></span><br><span class="line"><span class="function"><span class="title">Certificate</span> <span class="title">Hash</span>             : &lt;新しい証明書の拇印&gt; ★ &lt;&lt;&lt; ここだけが変わっていることを確認します。</span></span><br><span class="line"><span class="function"><span class="title">Application</span> <span class="title">ID</span>               : &#123;5<span class="title">d89a20c</span>-<span class="title">beab</span>-4389-9447-324788<span class="title">eb944a</span>&#125;</span></span><br><span class="line"><span class="function"><span class="title">Certificate</span> <span class="title">Store</span> <span class="title">Name</span>       : <span class="title">MY</span></span></span><br><span class="line"><span class="function"><span class="title">Verify</span> <span class="title">Client</span> <span class="title">Certificate</span> <span class="title">Revocation</span> : <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">Verify</span> <span class="title">Revocation</span> <span class="title">Using</span> <span class="title">Cached</span> <span class="title">Client</span> <span class="title">Certificate</span> <span class="title">Only</span> : <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">Usage</span> <span class="title">Check</span>                 : <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">Revocation</span> <span class="title">Freshness</span> <span class="title">Time</span>   : 0</span></span><br><span class="line"><span class="function"><span class="title">URL</span> <span class="title">Retrieval</span> <span class="title">Timeout</span>       : 0</span></span><br><span class="line"><span class="function"><span class="title">Ctl</span> <span class="title">Identifier</span>               : (<span class="title">null</span>)</span></span><br><span class="line"><span class="function"><span class="title">Ctl</span> <span class="title">Store</span> <span class="title">Name</span>               : (<span class="title">null</span>)</span></span><br><span class="line"><span class="function"><span class="title">DS</span> <span class="title">Mapper</span> <span class="title">Usage</span>             : <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">Negotiate</span> <span class="title">Client</span> <span class="title">Certificate</span> : <span class="title">Enabled</span></span></span><br></pre></td></tr></table></figure><h2 id="6-WAP-サーバーを再構成"><a href="#6-WAP-サーバーを再構成" class="headerlink" title="6. WAP サーバーを再構成"></a>6. WAP サーバーを再構成</h2><p>WAP サーバーを再構成します。全 WAP サーバーにて以下を実施します。</p><ol><li><p>レジストリ エディターを開きます。</p></li><li><p>[HKEY_LOCAL_MACHINE\Software\Microsoft\ADFS] を選択します。</p></li><li><p>[ProxyConfigurationStatus] をダブル クリックします。</p></li><li><p>[値のデータ] を 1 にして [OK] をクリックします。</p></li><li><p>スタート画面などから [リモート アクセス管理] コンソールを開きます。</p></li><li><p>画面左側から [構成] - [Web Application Proxy] をクリックします。</p></li><li><p>画面中央から [Web アプリケーション プロキシ構成ウィザードの実行] をクリックします。</p></li><li><p>初期構成時と同様に、WAP サーバーを構成します。</p><p> ※ [AD FS プロキシの証明書] 画面では、手順 2. でインストールした SSL サーバー証明書を選択します。</p></li></ol><blockquote><p>(注意) WAP サーバーの再構成を行う際には、hosts ファイルでフェデレーションサービス名がプライマリ AD FS サーバーに名前解決されるように設定ください。<br>AD FS サーバーと WAP サーバーとの間にロードバランサーが存在する環境の場合、明示的にプライマリ AD FS サーバーに接続されるように設定しておかないと、再構成に失敗することがあるためです。</p></blockquote><p>手順は以上の通りとなります。上記手順は過去にも同様のお問い合わせをお受けした際、多くのお客様にご案内しております実績のある手順となっておりますが、一度検証環境で一連の動作を確認されることをお勧めいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;皆様、こんにちは。Azure &amp;amp; Identity サポート担当の竹村です。&lt;/p&gt;
&lt;p&gt;本ブログでは、netsh コマンドで AD FS サーバーの SSL 証明書を更新する手順をご案内します。&lt;br&gt;AD FS サーバーのバージョンに依らず、汎用的に利用できる</summary>
      
    
    
    
    
    <category term="AD FS" scheme="https://jpazureid.github.io/blog/tags/AD-FS/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Authenticator の MFA 疲労攻撃対策 - 数値の一致による MFA が 有効化されます</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/defend-your-users-from-mfa-fatigue-attacks/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/defend-your-users-from-mfa-fatigue-attacks/</id>
    <published>2023-02-15T15:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.335Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Identity サポート チームの栗井です。</p><p>Microsoft Identity Security のディレクター Alex Weinert によって、昨今脅威が指摘されている MFA 疲労攻撃と、対策としての Microsoft Authenticator の強化機能についての下記ブログ記事が公開されました。</p><p><a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/defend-your-users-from-mfa-fatigue-attacks/ba-p/2365677">Defend your users from MFA fatigue attacks - Microsoft Tech Community</a></p><p>上記記事に記載の一部内容と、私共日本側のサポート チーム宛にお客様からお問い合わせいただく内容等をふまえ、本記事を執筆しました。</p><div class="alert is-info"><p class="alert-title">Note</p><p>下記でご紹介する機能のうち「プッシュ通知に番号の一致が必要」の機能は、2023 年の 5 月 8 日以降、すべてのユーザーに自動で有効化することを予定しています。(元々 2023 年 2 月 27 日以降を予定していましたが、2023 年 2 月 16 日段階で延期されました)</p><p><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-mfa-number-match">公開情報: 多要素認証 (MFA) 通知で数値の一致を使用する方法 - 認証方法ポリシー</a></p></div><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>昨今は多くのお客様の環境において、パスワード “のみ” による認証は十分にセキュアではないという認識が高まり、多要素認証 (MFA) などの導入による認証の強化が行われています。この動向に伴って、<strong>MFA の疲労攻撃 (別名、MFA スパム)</strong> の報告が増えています。</p><p><img src="/blog/azure-active-directory/defend-your-users-from-mfa-fatigue-attacks/Karen_Walker_1-1664319621345.png"></p><p>MFA 疲労攻撃とは、攻撃者が繰り返し何度も MFA 要求を発生させ、その要求を受け取ったユーザーが誤って MFA 要求を承認することを狙った手口です。</p><p>なぜこのような手口が通用するのかというと、音声通話への応答やプッシュ通知の承諾といった単純な MFA 承認方法では、ユーザーが一連の認証の流れ (コンテキスト) の中にいなくても、承諾を完了できてしまえるからです。突然、何の脈絡もなくスマートフォンにプッシュ通知が来たとして、ユーザーが承諾ボタンを押してしまうと攻撃者に侵入を許してしまうことになります。</p><p>例えば私の Microsoft Authenticator に、突然 MFA のプッシュ通知が発生したと仮定します。アプリには「サインインを承認しますか ? (拒否 / 承認)」という選択肢が表示されます。私はこのサインインに身に覚えがないので「拒否」を押下しますが、まだ IT リテラシーの高くない利用者や、たまたまそのタイミングでクラウド アプリにサインインを試行している人であれば、誤って「承認」を選択してしまう可能性もあります。また、攻撃者が繰り返しサインインを試行してプッシュ通知を行うと、ユーザーには複数の通知が届き、どれが自身の意図したプッシュ通知か判断できなくなります。MFA 疲労攻撃は、このような「ユーザーの誤操作」を狙った攻撃です。</p><p>この攻撃が成り立つのは、一連の認証操作において、認証の流れ (コンテキスト) が考慮されていないためです。実際に画面の前でサインインをしていなくても、Microsoft Authenticator 上で「承認」を押すことが “できてしまう” という点が問題です。音声通話 MFA も仕組みは同様です (自身が認証操作をしているか否かにかかわらず、認証要求の電話に対して、シャープ “#” ボタンを押下してしまえば承認できてしまう)。</p><p>本記事ではこのような「MFA の誤承認」からユーザーを保護するための、Microsoft Authenticator における MFA 強化の機能についてご紹介します。</p><h2 id="1-「プッシュ通知に番号の一致が必要」機能によって-MFA-の誤承認発生を防止"><a href="#1-「プッシュ通知に番号の一致が必要」機能によって-MFA-の誤承認発生を防止" class="headerlink" title="1. 「プッシュ通知に番号の一致が必要」機能によって MFA の誤承認発生を防止"></a>1. 「プッシュ通知に番号の一致が必要」機能によって MFA の誤承認発生を防止</h2><p>Microsoft Authenticator の「プッシュ通知に番号の一致が必要」を有効化すると、MFA の際に、「サインイン画面に表示される 2 桁の数字を、Microsoft Authenticator の画面に入力する」という操作が要求されます。</p><p>仮にユーザーの手元の Microsoft Authenticator に、見知らぬ MFA 要求が通知された場合であっても、ユーザーはこれを許可することができません。なぜならユーザーは画面の前におらず、Microsoft Authenticator に入力するための正しい数字を知りようがないからです。この仕組みによって、ユーザーが MFA 要求を誤承認するリスクを大幅に抑えることができます。</p><p><img src="/blog/azure-active-directory/defend-your-users-from-mfa-fatigue-attacks/number-matching.png">  </p><p>「プッシュ通知に番号の一致が必要」の機能は、当ブログ公開時 (2022/10/19) 時点でプレビュー機能でしたが、現在は一般機能として公開済みです。</p><p><a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/advanced-microsoft-authenticator-security-features-are-now/ba-p/2365673">公開情報 : Advanced Microsoft Authenticator security features are now generally available!</a></p><div class="alert is-info"><p class="alert-title">Note</p><p>Update: 本機能は 2023 年の 5 月 8 日以降、すべてのユーザーに自動で有効化することを予定しています。</p></div><p>本機能は 2021 年 11 月にリリースされ、すでに 1 万近くの組織に導入されています。また「番号の一致」は、Microsoft Authenticator を利用したパスワードレス サインインの手段としてもご利用いただくことができます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-mfa-number-match">公開情報: 多要素認証 (MFA) 通知で数値の一致を使用する方法 - 認証方法ポリシー</a></p><h2 id="2-ユーザーが不正アクセスを判断できるように、MFA-要求にサインイン情報を表示"><a href="#2-ユーザーが不正アクセスを判断できるように、MFA-要求にサインイン情報を表示" class="headerlink" title="2. ユーザーが不正アクセスを判断できるように、MFA 要求にサインイン情報を表示"></a>2. ユーザーが不正アクセスを判断できるように、MFA 要求にサインイン情報を表示</h2><p>「プッシュ通知とパスワードレス通知に地理的な場所を表示する」の機能を有効化すると、サインインの発生元の IP アドレスに基づいた位置情報が Microsoft Authenticator の画面に表示されます。また「プッシュ通知とパスワードレス通知にアプリケーション名を表示する」の機能を有効化すると、サインイン先のアプリケーションの名前も表示されます。</p><p>例えば、ユーザー自身が名古屋にいるのに、サインイン元の位置情報が「ブラジル / リオデジャネイロ」と表示された場合、ユーザーは「この MFA 要求はおかしいかも？」と、一瞬手を止めて不正アクセスを疑うきっかけになることが期待されます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-mfa-additional-context">公開情報: Microsoft Authenticator 通知で追加のコンテキストを使用する方法 - 認証方法ポリシー</a></p><p>なお、上記の機能がすべて有効化の対象となっているユーザーでは、Authenticator 宛の MFA 要求は、下記画像のようになります。</p><ul><li>アクセス先のアプリケーションが表示されます。下記例では “App: Azure Portal” と表示されています。</li><li>アクセス元の位置情報が “Location : Tokyo Japan” と、地図と合わせて表示されます。</li><li>MFA 要求の承認のため、数字の入力が要求されます。</li></ul><p><img src="/blog/azure-active-directory/defend-your-users-from-mfa-fatigue-attacks/mfarequest.png">  </p><h2 id="3-Azure-AD-Identity-Protection-の機能もぜひご活用を"><a href="#3-Azure-AD-Identity-Protection-の機能もぜひご活用を" class="headerlink" title="3. Azure AD Identity Protection の機能もぜひご活用を"></a>3. Azure AD Identity Protection の機能もぜひご活用を</h2><p>上記の各種 Microsoft Authenticator の強化機能をすぐに導入することが難しい場合は、Azure AD Identity Protection の機能もぜひご活用ください。Azure AD Identity Protection の導入によって、リスクのあるサインイン パターンや侵害された可能性のあるユーザーが検知され、不正アクセスを防止することができます。</p><p>例えば攻撃者が、馴染みのない場所からのサインインを試み、MFA の実施に失敗した場合、攻撃対象のユーザーのアカウントは「ユーザー リスク有り」と判定されます。不正な MFA 要求を繰り返し発生させる攻撃者は、すでにユーザーのパスワードを把握しています。漏洩したパスワードを継続的に利用することは望ましくないので、まずはパスワードの変更が必要です。</p><p>管理者はユーザー リスクの検知を Azure ポータルから確認し、ユーザーにパスワード変更を要求することができます。パスワードをリセットすることで、攻撃者は古いパスワードを利用した攻撃ができなくなります。また、ユーザー リスクの評価値は自動で低減されます。</p><p>管理者によるリスクの確認およびパスワード変更の手間を省略したい場合、Azure AD Identity Protection の「ユーザー リスク ポリシー」を構成いただくことで、リスクのあるユーザーを自動でセルフサービス パスワード リセット (SSPR) に遷移させることもできます。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/identity-protection/howto-identity-protection-configure-risk-policies">公開情報: リスク ポリシーを構成して有効にする - Azure Active Directory Identity Protection</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/howto-conditional-access-policy-risk-user">公開情報: 条件付きアクセス - 危険なユーザーに対してパスワード変更を必須にする</a></li></ul><h2 id="強化された-Microsoft-Authenticator-の機能を試してみよう"><a href="#強化された-Microsoft-Authenticator-の機能を試してみよう" class="headerlink" title="強化された Microsoft Authenticator の機能を試してみよう"></a>強化された Microsoft Authenticator の機能を試してみよう</h2><p>以下では、Azure ポータルで強化された Microsoft Authenticator の機能を有効化 + 検証する手順をご紹介します。</p><ol><li><p>セキュリティ グループを作成</p><ul><li>管理者のアカウントで Azure ポータルにアクセスし、[Azure Active Directory] &gt; [グループ] から、新しいグループを作成します。グループの種類は “セキュリティ” を選択ください。</li><li>「数字の一致」機能を構成する対象のユーザーをグループのメンバーとして追加します。検証段階では、検証用ユーザーのみをグループに追加ください。<br>本説明内では “Number matching test” という表示名のセキュリティ グループを仮定します。</li></ul></li><li><p>Microsoft Authenticator の認証方法ポリシーを構成</p><ul><li><p>管理者のアカウントで Azure ポータルにアクセスし、下記に進みます。</p><p>  [Azure Active Directory] &gt; [セキュリティ] &gt; [認証方法] &gt; [ポリシー]</p></li><li><p>認証メソッド一覧から “Microsoft Authenticator” を選択します。[基本] タブの “有効にする” の現在の設定値が “いいえ” となっていることをご確認の上、以降の手順にお進みください。</p></li><li><p>[基本] タブの “有効にする” の設定値を “はい” にします。</p><p>  “ターゲット” では “ユーザーの選択” を選択し、”ユーザーとグループの追加” から “Number matching test” を選択します。</p></li><li><p>[構成] タブを開きます。</p></li><li><p>[プッシュ通知に番号の一致が必要] と [プッシュ通知とパスワードレス通知にアプリケーション名を表示する] と [プッシュ通知とパスワードレス通知に地理的な場所を表示する] それぞれの設定項目で、下記のように構成します。</p><ul><li>状態 : 有効</li><li>ターゲット - 含める : “Number matching test” グループを追加</li></ul></li></ul></li><li><p>該当のユーザーに対して MFA を有効化</p><p> 上記の Microsoft Authenticator の認証方法ポリシー設定は、MFA が要求された際のアプリ上での動作をカスタマイズする項目です。ユーザーに対しての MFA 要求の有効化は、別途構成する必要があります。MFA の有効化方法は複数ありますが、本記事では条件付きアクセス ポリシーによる有効化の手順を記載します。</p><ul><li><p> [Azure Active Directory] &gt; [セキュリティ] に進みます </p></li><li><p> [条件付きアクセス] &gt; [ポリシー] に進みます</p></li><li><p>[+ 新しいポリシー] を押下し、以下の内容でポリシーを構成します</p><ul><li><p>[名前] : 任意のポリシーの名前をご入力ください</p></li><li><p>[割り当て] : </p><ul><li>[ユーザーまたはワークロード ID] : “Number matching test” グループを指定</li><li>[クラウド アプリまたは操作] : “すべてのクラウド アプリ” もしくは何らかの特定のアプリケーションを指定</li></ul></li><li><p>[アクセス制御] :</p><ul><li>[許可] : アクセス権の付与 – “多要素認証を要求する” を選択</li></ul></li></ul></li><li><p>[ポリシーの有効化] を [オン] にし、[保存] を押して設定を反映します</p></li></ul><p> 上記を設定後、 “Number matching test” に所属するユーザーによって何らかのアプリケーションにアクセスいただくことで、強化された Microsoft Authenticator の MFA 機能が動作することをご確認ください。設定にあたってのご不明点やご相談事項などございましたら、弊社サポート チームまでお問い合わせください。</p></li></ol><h2 id="Q-amp-A-随時追記予定"><a href="#Q-amp-A-随時追記予定" class="headerlink" title="Q &amp; A (随時追記予定)"></a>Q &amp; A (随時追記予定)</h2><p>Q1. Microsoft Authenticator のアプリ上で発生したサインインで「数字の一致」による MFA を実施する際に、数字の表示画面 / 数字の入力プロンプト が重なってしまい、サインインの完了ができません。</p><p>A1. 一番下の “番号が表示されません” を選択ください。3 秒間のみ数字の入力プロンプトが非表示となり、MFA 認証用の数字が表示されます。<br><img src="/blog/azure-active-directory/defend-your-users-from-mfa-fatigue-attacks/cannotseethenumber.png">  </p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>Microsoft Authenticator の優れた点の 1 つは、今後もさらなる進化および多様化が懸念されるセキュリティ攻撃に対して、いち早く対応できるよう継続的に開発および投資を行っていることです。 Microsoft Authenticator が企業にとって、最も安全かつ便利で費用対効果の高い認証方法であり続けるために、今後もさらに多くの機能強化を続けて参ります。</p><p>各種 MFA 強化の機能の一般公開 (GA) にあたって、利用者の皆様の生のご意見やフィードバックはとても重要です。MFA 疲労攻撃に関する英語記事 (後述)、もしくは <a href="https://feedback.azure.com/d365community/forum/22920db1-ad25-ec11-b6e6-000d3a4f0789">Azure フィードバック サイト</a> まで、ぜひご意見をお寄せいただけますと幸いです。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>Microsoft Tech Community の記事は、新 -&gt; 古 の順で記載しております。</p><ul><li><a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/advanced-microsoft-authenticator-security-features-are-now/ba-p/2365673">(再掲) Advanced Microsoft Authenticator security features are now generally available! - Microsoft Tech Community | Published Oct 25 2022</a></li><li><a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/defend-your-users-from-mfa-fatigue-attacks/ba-p/2365677">(再掲) Defend your users from MFA fatigue attacks - Microsoft Tech Community | Published Sep 28 2022</a></li><li><a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/new-microsoft-authenticator-security-features-are-now-available/ba-p/2464386">New Microsoft Authenticator security features are now available! - Microsoft Tech Community | Published Nov 18 2021</a></li></ul><ul><li><a href="https://feedback.azure.com/d365community/forum/22920db1-ad25-ec11-b6e6-000d3a4f0789">Microsoft Azure  |  Share your Ideas - Azure Active Directory</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Identity サポート チームの栗井です。&lt;/p&gt;
&lt;p&gt;Microsoft Identity Security のディレクター Alex Weinert によって、昨今脅威が指摘されている MFA 疲労攻撃と、対策としての Microsoft </summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Azure Active Directory における危険なサインインへの対策</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/combatting-risky-sign-ins/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/combatting-risky-sign-ins/</id>
    <published>2023-02-13T00:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.279Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 星野です。</p><p>本記事は、2023 年 1 月 30 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/combatting-risky-sign-ins-in-azure-active-directory/ba-p/3724786">Combatting Risky Sign-ins in Azure Active Directory</a>  を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>クラウドの利用が進む現代において、貴社のクラウド アプリケーションが悪意あるサインイン試行の標的となるのは、ほぼ避けられないことでしょう。従業員が業務用アカウントで使用したパスワードを個人アカウントでも使用しているケースはよくあります。仮に自社と関係のない組織からパスワードが漏えいした場合、E メール アドレスや UPN が異なっていても、貴社の従業員がパスワードの漏洩したアプリで同じパスワードを使用している場合は、脅威となりえます。より多くのアプリがクラウドに移行する中、このような悪意のあるサインイン試行を見逃さず、正しい対処をすることは必要不可欠となっています。Azure の ID 管理とアクセス制御のベストプラクティスについては、<a href="https://learn.microsoft.com/ja-jp/azure/security/fundamentals/identity-management-best-practices">こちらのリンク</a> を参照ください。</p><h2 id="リスク-レベルの把握"><a href="#リスク-レベルの把握" class="headerlink" title="リスク レベルの把握"></a>リスク レベルの把握</h2><p><a href="https://www.microsoft.com/ja-jp/security/business/identity-access/azure-active-directory-identity-protection">Azure AD Identity Protection</a> は、Azure AD P2 ライセンスを使用しているテナントの Azure AD で追加構成なく利用できるサービスです。<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/identity-protection/overview-identity-protection#required-roles">Azure AD P2 ライセンスがない場合</a>、Identity Protection の機能は制限付きで動作します。Azure AD Identity Protection は、匿名 IP アドレスの使用、特殊な移動、マルウェアにリンクされた IP アドレス、通常とは異なるサインイン プロパティ、漏洩した資格情報、パスワード スプレーなどのリスクを検出することができます。  </p><p>Identity Protection は、リスクのあるサインインごとに、低、中、高のいずれかのリスク レベルを割り当てます。リスク レベルが高いほど、Identity Protection はこのユーザーまたはサインインが侵害されている可能性が高いと判断します。</p><p>Identity Protection が作成するレポートは以下の 4 種類があります:</p><ul><li>危険なユーザー - リスクのあるユーザー、ユーザーのリスク履歴を集計。</li><li>危険なワークロード ID - サービス プリンシパルのリスク レベルを集計。</li><li>危険なサインイン - サインインのリスク レベル、サインイン情報 (デバイス、アプリケーション、場所など)、検出の種類を集計。  </li><li>リスク検出 - 過去 90 日間のリスク検出と検出の種類およびその他の詳細を集計。</li></ul><p>これらのレポートは、Azure Active Directoryの [セキュリティ] タブで確認することができます。図 1 は、危険なサインインのレポートです。サインインの一つをクリックすると、リスク レベルとそのサインインがリスクありと判断された理由の詳細が表示されます。図 2 では、このサインインのリスク レベルは「低」で、匿名の IP アドレスが使用されているため危険と分類されたことがわかります。</p><p><img src="/blog/azure-active-directory/combatting-risky-sign-ins/figure1.png" alt="図 1: リスクの高いサインイン レポート"></p><p><img src="/blog/azure-active-directory/combatting-risky-sign-ins/figure2.png" alt="図 2: リスクの高いサインインの詳細"></p><p>危険なユーザーのレポートは、危険と分類されたユーザーを表示します。図 3 は危険なユーザーのレポートで、図 4 はそのユーザーに関連する危険なサインインを示しています。危険なユーザーのレポートでユーザーをクリックすることで、ユーザーのパスワード リセット、危険なユーザーとしてのマーク、ユーザーのサインインのブロック、リスクの無視が可能です。ユーザーを危険とマークすると、そのユーザーのリスク レベルは「高」になり、Azure AD はそのユーザーを危険度「高」として扱います。これは、ユーザーのリスク レベルを条件として自動化を構成しているか、条件付きアクセス ポリシーを使用している場合に便利です。逆に、ユーザー リスクを無視すると、そのユーザーに関連するすべてのリスク レベルが削除されます。どちらのアクションも元に戻すことはできません。</p><p><img src="/blog/azure-active-directory/combatting-risky-sign-ins/figure3.png" alt="図 3: リスクのあるユーザー レポート"></p><p><img src="/blog/azure-active-directory/combatting-risky-sign-ins/figure4.png" alt="図 4: ユーザーに関連するリスクのあるサインイン"></p><p>Identity Protection がユーザーとサインインに設定するリスク レベルは、自動化されたアクションを実行する際にも活用できます。これを行うには、ユーザーとサインインに設定されたリスク レベル基づく条件付きアクセス ポリシーを作成します。たとえば、サインインしたユーザーのリスクレベルが「高」の場合、パスワードのリセットを強制的に実行するといったポリシーです。リスク レベルに基づく条件付きアクセス ポリシーに関する推奨事項については、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/identity-protection/howto-identity-protection-configure-risk-policies#microsofts-recommendation">こちら</a> を参照ください。</p><h2 id="危険なサインインを調査する"><a href="#危険なサインインを調査する" class="headerlink" title="危険なサインインを調査する"></a>危険なサインインを調査する</h2><p>危険なサインインを調査する際には、リスクのレベルを決定するいくつかの要素に注目ください。そのユーザーの過去のサインインに基づいて、サインインに異常な属性があるかどうかを理解することが重要です。たとえば以前のサインインを見ると、サインインしたアプリケーション、場所、デバイス、IP アドレス、ユーザー エージェントが同じような値になっているかどうかをご確認いただけます。サインインに使用されたデバイスが <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/devices/concept-azure-ad-join">Azure AD 参加済みデバイス</a> の場合や、 <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/devices/concept-azure-ad-join-hybrid">ハイブリッド Azure AD 参加済みデバイス</a> の場合は、デバイスを特定する情報も確認可能です。以下の事項を確認ください:</p><ul><li>このユーザーは、以前にもこの場所と IP アドレスからサインインしたことがあるか？</li><li>このユーザーは、以前にもこのアプリケーションにサインインしたことがあるか？</li><li>デバイスは Azure AD に登録されているか？</li><li>そのデバイスは「準拠済み」とマークされているか？</li></ul><p>サインインの詳細を調査することで、サインインの真のリスク レベルが明確になり、どのような対応を取るべきかがわかります。例えば、ロンドンに住む 1 名ユーザーから 2 種類のサインインが成功したとします。どちらのサインインも、匿名 IP アドレスを使用しているため、リスクレベルは「低」と認定されました。</p><table><thead><tr><th>属性</th><th>シナリオ 1</th><th>シナリオ 2</th></tr></thead><tbody><tr><td>サインインしたアプリケーション</td><td>Outlook モバイル</td><td>Azure ポータル</td></tr><tr><td>デバイス</td><td>iPhone</td><td>Windows 10</td></tr><tr><td>場所</td><td>スペイン マドリード</td><td>米国 コネチカット州</td></tr><tr><td>ユーザー エージェント</td><td>Mozilla/5.0 (iPhone; CPU iPhone OS 16_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148</td><td>Mozilla/5.0 (Windows NT 10.0; Microsoft Windows 10.0.9200; ja-US) PowerShell/7.1.0</td></tr><tr><td>Azure AD の状態</td><td>Azure AD登録済み</td><td>未参加</td></tr><tr><td>準拠済みデバイス</td><td>準拠済み</td><td>N/A</td></tr></tbody></table><p><strong>上記シナリオ 1</strong> より、ユーザーが iPhone から Outlook Mobile にサインインしたことがわかります。ユーザー エージェントは OS のバージョンに関する詳細な情報を提供します。この情報をより読みやすい形式に変換するツールがオンライン上で数多く提供されていますので、必要に応じご使用ください。また、このデバイスは Azure AD に登録されている、かつ準拠済みデバイスとわかります。匿名の IP アドレスが使用されているのは、Outlook Mobile へのサインイン時にユーザーがモバイルで VPN を使用していたためと思われます。おそらく危険なサインインではありませんが、念のためユーザーに確認を行うことが必要です。</p><p><strong>シナリオ 2</strong> では、Azure ポータルへのサインインが発生したことを示しています。このユーザーの仕事として Azure ポータルでの管理作業が含まれない限り、Azure ポータルへのサインインは疑わしいと判断できます。また、このデバイスは Azure AD に参加していません。ユーザー エージェントは、PowerShell を使用してサインインしたことを示しています。このサインインの真のリスク レベルを判断する前に、このユーザーが本当に侵害されているかどうか、さらに調査する必要があります。このユーザーが侵害されている場合、そのユーザーのセッションを失効させ、パスワードをリセットする必要があります。攻撃者が MFA 設定 (電話番号、アプリ登録、セカンダリの E メールなど) を変更した場合は、これらを削除し、ユーザー自身に MFA を再登録させるようにします。</p><h2 id="リスクの高いサインインの監視"><a href="#リスクの高いサインインの監視" class="headerlink" title="リスクの高いサインインの監視"></a>リスクの高いサインインの監視</h2><p>Azure AD のサインイン ログを <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/log-analytics-overview">Log Analytics</a> ワークスペースまたは <a href="https://learn.microsoft.com/ja-jp/azure/sentinel/overview">Microsoft Sentinel</a> に転送すると、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/queries">ログを検索する</a> ことで更なる調査を行い、攻撃を追跡することができます。Sentinel の <strong>SigninLogs</strong> テーブルには、サインインのリスク レベルに関するデータが格納されています。次のクエリを実行すると、どのリスク検出の種類が最も多かったかを確認できます。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SigninLogs  </span><br><span class="line">| where RiskLevelDuringSignIn != &quot;none&quot;  </span><br><span class="line">| mv-expand todynamic(RiskEventTypes)  </span><br><span class="line">| summarize [&quot;Type Count&quot;] = count() by tostring(RiskEventTypes)  </span><br><span class="line">| sort by [&#x27;Type Count&#x27;] desc  </span><br><span class="line">| render columnchart with(title=&quot;Count of Risk Detection Type&quot;) </span><br></pre></td></tr></table></figure><p>リスクのあるサインインをレベルに基づいて分類し、サインインが成功したかどうかを確認するには、次のクエリを実行します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SigninLogs  </span><br><span class="line">| where RiskLevelDuringSignIn != &quot;none&quot;  </span><br><span class="line">| extend ResultType = iif(ResultType == &quot;0&quot;, &quot;Successfull Logon&quot;, &quot;Failed Logon&quot;)  </span><br><span class="line">| summarize Count = count() by ResultType, RiskLevelDuringSignIn  </span><br><span class="line">| render columnchart with(title = &quot;Risk Levels Count per Successfull and Failed Sign-ins&quot;)  </span><br></pre></td></tr></table></figure><p>貴社においても上記のような悪意のあるサインインに直面することがあるでしょう。Azure AD Identity Protection を利用することで、ユーザーおよびサインインにリスク レベルを割り当て、悪意のあるサインインに対処することができます。さらに、改善のためのアクションを自動化し、収集されたリスクの詳細に関するデータを調査に生かすことが可能です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 星野です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 1 月 30 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techcom</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>MSOnline / AzureAD PowerShell から Graph PowerShell SDK への移行について 4_ユーザー管理</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement4/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement4/</id>
    <published>2023-02-12T00:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.215Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、 Azure Identity サポート チームの小出です。</p><p>この記事は、この記事は、MSOnline / AzureAD モジュール廃止について、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement1/">1. 概要編</a>、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement2/">2. 移行導入編</a>、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement3/">3. インストール・接続編</a> の続きとして連載しています。</p><p>4 回目となる今回からは、具体的に、新しい Microsoft Graph PowerShell SDK を使用したユーザーの管理方法についてご案内します。以前、<a href="https://jpazureid.github.io/blog/azure-active-directory/operating-license-with-microsoft-graph/">こちらの記事</a> にて、ライセンス管理についてご案内させていただきましたが、今回はユーザー管理に特化してご紹介します。まだモジュールをインストールしていない場合や、 Connect-MgGraph コマンドを使用した接続方法が分からない場合などは、本シリーズの 2 と 3 をご確認ください。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ol><li><a href="#idx1">ユーザーの取得</a><ul><li><a href="#idx1-1">テナントの全ユーザーを取得したい</a></li><li><a href="#idx1-2">特定のユーザーを取得したい</a></li><li><a href="#idx1-3">ゲスト ユーザーのみを取得したい)</a></li><li><a href="#idx1-4">アカウントが有効なゲスト ユーザーのみを取得したい)</a></li><li><a href="#idx1-5">特定のユーザーの extensionAttribute の値を取得したい</a></li><li><a href="#idx1-6">削除済みユーザーを取得したい</a></li></ul></li><li><a href="#idx2">ユーザーの作成</a></li><li><a href="#idx3">ユーザーの削除</a></li><li><a href="#idx4">削除済みユーザーの完全削除と復元</a></li><li><a href="#idx5">ユーザーの属性を更新する</a></li><li><a href="#idx6">よくある質問</a></li></ol><hr><h2 id="idx1">1. ユーザーの取得</h2><p>これまでユーザー情報の取得にし使用していた Get-MsolUser や Get-AzureADUser コマンドは、 Get-MgUser コマンドに置き換えられます。ここでは様々なシナリオでユーザーを取得する方法についてご紹介します。</p><h3 id="idx1-1">テナントの全ユーザーを取得したい</h3><p>全てのユーザーを取得するには、-All オプションを使用します。Get-AzureADUser コマンドでは、-All $true とする必要がありましたが、新しいコマンドでは -All のみで動作します。-All を指定しない場合は、100 ユーザーなど一部の結果のみが返されます。 ユーザー数の非常に多い環境では -All オプションをつけると大量の結果が表示されますのでご注意ください。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -All</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-1.png"></p><h3 id="idx1-2">特定のユーザーを取得したい</h3><p>これまでのコマンドと同様に、 ObjectID や UPN を指定することで取得が可能です。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -UserId admin@m365x219253.onmicrosoft.com</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-2.png"></p><p>上記で気になった方もいると思いますが、Usertype の中身が空になっていることにお気づきでしょうか。Get-MsolUser コマンドや Get-AzureADUser コマンドでは、何も指定しなくても、すべての属性の情報が一括で出力されていました。</p><p> Microsoft Graph Powershell SDK では、属性によって下記のような特徴がある点を理解しておくと、「入れたはずの値が表示されない」といった混乱を避けることができます。</p><ul><li>Microsoft Graph PowerShell SDK にはバージョンがあり、v1.0 で取得できる属性値 beta でしか取得できない属性値がある</li><li>Property オプションを使用して明示的に指定しないと、結果に表示されないものがある</li></ul><p>そのため、たとえば下記のように実行すると、Usertype 属性が取得できるようになります。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -UserId admin@m365x219253.onmicrosoft.com -Property Id,Displayname,Mail,UserPrincipalName,Usertype</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-3.png"></p><p>これは、| format-list を利用したときも同様で、| format-list 自体は新しいモジュールでも機能しますが、下記のように、必要な情報が出てこないことがあります。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-4.png"></p><p>AccountEnabled に値が入っていない！と疑問に思うかもしれませんが、Usertype と同様に下記のように実行すると、AccountEnabled の値も取得することが可能です。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -UserId 30a4a94b-9bca-4141-94d2-2dd0e2cc341b -Property Id,Displayname,Mail,UserPrincipalName,Usertype,AccountEnabled | fl</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-5.png"></p><p>もしくは、上記にて紹介した -Property オプションを使用したうえで、さらに Select を使用すると、表示される属性と値をカスタマイズできます。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -UserId 2e7c8a97-ab50-4e53-b193-be3ff9ddc6aa -Property Id,Displayname,Mail,UserPrincipalName,Usertype,AccountEnabled | select displayname,accountenabled</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-6.png"></p><p>次に、-Filter オプションをはじめとするオプションを活用できます。よくお問い合わせをいただく取得方法についてご案内します。</p><h3 id="idx1-3">ゲスト ユーザーのみを取得したい</h3><p>特定の条件を満たすユーザーのみを取得したい場合は -Filter オプションを使用します。usertype が Guest となっているユーザーをフィルターして表示しています。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -All  -Filter &quot;usertype eq &#x27;Guest&#x27;&quot; -Property Id,displayname,Mail,Userprincipalname,Usertype</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-7.png"></p><h3 id="idx1-4">アカウントが有効なゲスト ユーザーのみを取得したい</h3><p>-Filter の条件を 2 つ以上記載したいときは and でつなげると利用できます。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -Filter &quot;accountEnabled eq true and usertype eq &#x27;Guest&#x27;&quot;</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-8.png"></p><h3 id="idx1-5">特定のユーザーの extensionAttribute の値を取得したい</h3><p>ExtensionAttribute1 などの属性は、ユーザーの onpremisesExtensionAttributes の配下に用意されているので、下記のように実行して取得します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(get-mguser -UserId 4e6bc6e4-d6e7-4bd8-9079-3393e12dcec3).onpremisesExtensionAttributes | fl</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-9.png"></p><p>こちらは beta のみ対応しておりますので、Connect-MgGraph での接続後、本コマンド実行前に Select-Mgprofile -name beta にてベータに切り替えを実施ください。</p><h3 id="idx1-6">削除済みユーザーを取得したい</h3><p>削除済みのオブジェクトを取得するコマンドは、Get-MgDirectoryDeletedItem です。-DirectoryObjectID オプションに microsoft.graph.user と記載すると、削除されたユーザー オブジェクトが返されます (これらは、いわゆるごみ箱にある状態のユーザーで、30 日後に完全に削除されると参照できなくなります)。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(Get-MgDirectoryDeletedItem -DirectoryObjectId microsoft.graph.user).AdditionalProperties.value</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-10.png"></p><p>利用可能なパラメーターは Filter 以外にもありますが、各属性によってサポートされるオプションが異なります。下記のような公開情報を確認いただき、使用したい属性とオプションがサポートされているか、あらかじめご確認ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/graph/api/resources/user?view=graph-rest-1.0#properties">user リソースの種類 - プロパティ</a></li><li><a href="https://learn.microsoft.com/ja-jp/graph/api/user-list?view=graph-rest-1.0&tabs=powershell#optional-query-parameters">ユーザーを一覧表示する - オプションのクエリ パラメーター</a></li></ul><h2 id="idx2">2. ユーザーの作成</h2><p>下記のように必要なパラメーターを記載して、 New-Mguser を使用すると新しいユーザーを作成できます。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$params = @&#123;</span><br><span class="line">AccountEnabled = $true</span><br><span class="line">DisplayName = &quot;Adele Vance22&quot;</span><br><span class="line">MailNickname = &quot;AdeleV22&quot;</span><br><span class="line">UserPrincipalName = &quot;AdeleV22@m365x61971868.onmicrosoft.com&quot;</span><br><span class="line">PasswordProfile = @&#123;</span><br><span class="line">ForceChangePasswordNextSignIn = $true</span><br><span class="line">Password = &quot;xWwvJ]6NMw+bWH-d11&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">New-MgUser -BodyParameter $params</span><br></pre></td></tr></table></figure><p>もしくは、下記のように直接 New-Mguser コマンド内で必要な情報を記載することも可能です。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$PasswordProfile = @&#123;</span><br><span class="line">  Password = &#x27;Passw0rd&#x27;</span><br><span class="line">  &#125;</span><br><span class="line">New-MgUser -DisplayName &#x27;Rene Magi&#x27; -PasswordProfile $PasswordProfile -AccountEnabled -MailNickName &#x27;ReneMagi&#x27; -UserPrincipalName &#x27;ReneMagi@m365x61971868.onmicrosoft.com&#x27;</span><br></pre></td></tr></table></figure><p>以下の公開情報も併せてご確認ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/powershell/module/microsoft.graph.users/new-mguser?view=graph-powershell-1.0">New-MgUser</a></li><li><a href="https://learn.microsoft.com/ja-jp/graph/api/user-post-users?view=graph-rest-1.0&tabs=http">ユーザーを作成する</a></li></ul><h2 id="idx3">3. ユーザーの削除</h2><p>Remove-MgUser コマンドにて削除可能です。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Remove-MgUser -UserId 282f0fb7-06a6-4a86-b3d5-01569d7393a1</span><br></pre></td></tr></table></figure><h2 id="idx4">4. 削除済みユーザーの完全削除と復元</h2><p>削除されたユーザーは、30 日間の間、削除済みユーザーとして一時的に保存されます。30 日以内であれば、誤って削除してしまった場合でもこれらのユーザーを復元することが可能です。復元したい場合、 Restore-MgDirectoryDeletedItem コマンドを使用します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Restore-MgDirectoryDeletedItem -DirectoryObjectId 282f0fb7-06a6-4a86-b3d5-01569d7393a1</span><br></pre></td></tr></table></figure><p><a href="https://learn.microsoft.com/ja-jp/graph/api/directory-deleteditems-restore?view=graph-rest-1.0&tabs=http">削除済みアイテムを復元する</a> の公開情報も併せてご確認ください。</p><p>完全に削除したい場合、Remove-MgDirectoryDeletedItem コマンドを使用します。こちらのコマンドを実行すると、オブジェクトは完全に削除され復元できなくなるためご留意ください。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Remove-MgDirectoryDeletedItem -DirectoryObjectId 282f0fb7-06a6-4a86-b3d5-01569d7393a1</span><br></pre></td></tr></table></figure><p><a href="https://learn.microsoft.com/ja-jp/graph/api/directory-deleteditems-delete?view=graph-rest-1.0&tabs=powershell">アイテムを完全に削除する</a> の公開情報も併せてご確認ください。</p><h2 id="idx5">5. ユーザーの属性を更新する</h2><p>Update-Mguser コマンドを利用して更新が可能です。たとえばユーザーの displayname とその他のメール (Othermails) を更新したい場合は下記のように実行します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Update-MgUser -UserId 2e7c8a97-ab50-4e53-b193-be3ff9ddc6aa -DisplayName test1228a -OtherMails @(&quot;bob@contoso.com&quot;, &quot;admin@m365x219253.onmicrosoft.com&quot;)</span><br></pre></td></tr></table></figure><p>一般的には上記のように、変更したい属性を指定して、新しい値を指定すれば更新できます。</p><p>時折ご質問をいただくものとして、extensionattribute 関連の属性を更新したいといったお問い合わせがよくあるため、以下に手順を例として案内します。 Extensionattribute の値を更新したい場合、事前に beta に切り替えてからコマンドを実行ください。</p><ol><li><p>Connect-MgGraph にて接続します。</p></li><li><p>beta バージョンへ切り替えます。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Select-MgProfile -Name &quot;beta&quot;</span><br></pre></td></tr></table></figure></li><li><p>Get-Mguser コマンドを実行して、ユーザーの情報を取得します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(Get-MgUser -UserId 4e6bc6e4-d6e7-4bd8-9079-3393e12dcec3).onpremisesExtensionAttributes | fl</span><br></pre></td></tr></table></figure><p> 以下の画面では、ユーザーの ExtensionAttribute1 の値に test という文字列が入っていることが確認できます。</p><p> <img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-11.png"></p></li><li><p>以下のコマンドを実行して、たとえば ExtensionAttribute1 の値を test2 に更新します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Update-MgUser -UserId 4e6bc6e4-d6e7-4bd8-9079-3393e12dcec3 -OnPremisesExtensionAttributes @&#123;&quot;ExtensionAttribute1&quot;=&#x27;test2&#x27;&#125;</span><br></pre></td></tr></table></figure></li><li><p>値が test2 に更新されたことを確認します。</p><p> <img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-12.png"></p></li></ol><h2 id="idx6">6. よくある質問</h3><p>Q. Set-MsolUser コマンドで実施できた StrongAuthenticationRequirements の有効化や、StrongAuthenticationMethod を無効化する代替案はありますか？</p><p>A. いいえ、現状新しい Microsoft Graph PowerShell SDK では対応していません。<a href="https://learn.microsoft.com/ja-jp/graph/api/resources/authenticationmethods-overview?view=graph-rest-1.0">公開情報</a> にも記載があります。</p><blockquote><p>この機能は現在、StrongAuthenticationMethods プロパティを使用して、MSOLSet-MsolUser コマンドレットを使用してのみサポートされています。</p></blockquote><p>StrongAuthenticationMethod については <a href="https://learn.microsoft.com/en-us/graph/api/resources/authenticationmethods-overview?view=graph-rest-1.0">公開情報 (英語)</a> に記載があり、Microsoft Graph API (PowerShell SDK) を利用して、利用可能なすべての認証方法を個別に削除するというのが今後の正しい代替方法となります。</p><p>基本的なユーザー管理コマンドについて案内していますが、もし利用方法が不明なコマンドがございましたらお気軽にお問い合わせを起票ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、 Azure Identity サポート チームの小出です。&lt;/p&gt;
&lt;p&gt;この記事は、この記事は、MSOnline / AzureAD モジュール廃止について、&lt;a href=&quot;https://jpazureid.github.io/blog/azure-ac</summary>
      
    
    
    
    
    <category term="PowerShell" scheme="https://jpazureid.github.io/blog/tags/PowerShell/"/>
    
    <category term="Microsoft Graph" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Graph/"/>
    
  </entry>
  
  <entry>
    <title>マルチテナントの Azure AD 組織におけるシームレスなアプリケーション アクセスおよびライフ サイクル管理</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/cross-tenant-sync-publicpreview/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/cross-tenant-sync-publicpreview/</id>
    <published>2023-02-05T15:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.331Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は、2023 年 1 月 31 日に米国の Microsoft Entra (Azure AD) Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/seamless-application-access-and-lifecycle-management-for-multi/ba-p/3728752">Seamless Application Access and Lifecycle Management for Multi-tenant Azure AD Organizations</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p></div><p>こんにちは。</p><p>今日は、<strong>テナント間同期</strong> が <strong>パブリック プレビュー</strong> になったことをお知らせします。 </p><p>組織によっては、最近、新しい会社を買収したり、他の会社と合併したり、新しく設立された事業単位に基づき再編成されたりということがあるかと思います。組織が発展するにつれて、IT 部門は変化するニーズに対応するために適応が求められます。これには、既存の Azure Active Directory（Azure AD）テナントとの統合や、新しいテナントの作成も含まれるはずです。ID 基盤の管理方法にかかわらず、エンドユーザーがテナント間でリソースへのアクセスやコラボレーションをシームレスに体験できることがいかに重要であるかを弊社では認識しています。テナント間同期の機能により、マルチテナント環境においてシームレスなアクセスおよびコラボレーション体験を提供することができます。</p><p>現在では、カスタム スクリプトやオンプレミスのソリューションを使用してテナントをつなぎ合わせ、テナント間でシームレスなユーザー体験を提供しているかもしれません。あるお客様からは、組織内でコラボレーションを行う場合、次のようなことを望んでいるとお聞きしました。</p><ol><li><p>アプリケーションを組織内の異なるテナントでホストしている場合でも、ユーザーがアプリケーションにシームレスにアクセスできるようにしたい。</p></li><li><p>管理者がユーザーに代わって組織内のテナント間でデータを共有することに同意することで、ユーザーの目的を妨げるアクションを最小限に抑えたい。</p></li><li><p>カスタム スクリプトや自社開発ソリューションを使用せずに、テナント間で自動的にアカウントの同期を維持し、ユーザーが組織を離れた場合は、自動的にアカウントの削除をしたい。</p></li></ol><p>このようなシナリオを、Azure AD に組み込まれた機能で実現できるようになりました。テナント間同期を有効にすることで、組織内のテナント間でユーザー アカウントの作成を自動化できます。同期プロセスによって作成されたユーザーは、プライマリ テナントと同じように認証でき、各アプリケーションには、必要に応じて条件付きアクセス ポリシーを割り当てることもできます。これにより、組織全体のユーザーは、Microsoft アプリケーションや <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/saas-apps/servicenow-provisioning-tutorial">ServiceNow</a>、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/saas-apps/adobe-identity-management-provisioning-tutorial">Adobe</a> などの Microsoft 以外のアプリケーション、その他何百もの SaaS アプリケーションなど、それらがホストされているテナントに関係なくアプリケーションにアクセスできるようになりました。 </p><p>この同期プロセスは、堅牢な <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/what-is-b2b">Azure AD B2B</a> 機能を活用し、条件付きアクセス、クロステナント アクセス設定、エンタイトルメント管理などの Azure AD のセキュリティおよびガバナンス機能と完全に統合されており、裏側でユーザーに対して透過的に実行されます。</p><h2 id="簡単な-3-ステップでテナント間同期を開始する"><a href="#簡単な-3-ステップでテナント間同期を開始する" class="headerlink" title="簡単な 3 ステップでテナント間同期を開始する"></a>簡単な 3 ステップでテナント間同期を開始する</h2><p>組織内でのテナントをまたがるアプリケーションへのアクセスをユーザーに提供するために、テナント間同期をどのように使用しているか、Contoso 社の例を挙げて説明します。</p><p>Contoso 社は、米国に拠点を置く製造業の会社です。最近、グローバル展開を図るため、ヨーロッパとアジアの企業を買収しました。それぞれの会社は、既存の Azure AD テナントを持っています。<br>Contoso US のユーザーは、新しく買収した Contoso EMEA とContoso APAC のテナントと統合されたアプリケーションにアクセスする必要があります。そのため、Contoso の IT 管理者は、コラボレーションを促進するために、テナント間の B2B ユーザーの作成を自動化するカスタム スクリプトを手作業で作成していました。しかし、残念ながら、このスクリプトはエラーが発生しやすく、Contoso の担当者一人だけがその仕組みを知っていました。</p><p>Contoso の IT 管理者は、テナント間同期の機能を知り、午後には同期を有効にし、カスタム スクリプトを廃止することができました。以下は、その方法です。</p><p><img src="/blog/azure-active-directory/cross-tenant-sync-publicpreview/cts1.jpg"></p><h3 id="ステップ-1-ターゲットテナントにおけるテナント間同期の有効化"><a href="#ステップ-1-ターゲットテナントにおけるテナント間同期の有効化" class="headerlink" title="ステップ 1 - ターゲットテナントにおけるテナント間同期の有効化"></a>ステップ 1 - ターゲットテナントにおけるテナント間同期の有効化</h3><p>Contoso APAC と Contoso EMEA の管理者は、すでにクロステナントのアクセス ポリシーを作成し、Contoso US のテナントからの多要素認証 (MFA) を信頼しています。管理者は、クロステナント アクセス ポリシーの画面に移動し、チェックボックスをクリックするだけで、テナント間同期を有効にすることができます。チェックボックスをクリックするだけで、ターゲット テナントの管理者は完了です。 </p><p>これまでカスタム スクリプトで行っていたアプリの認証情報やシークレットのローテーション管理は、もう必要ありません。</p><p><img src="/blog/azure-active-directory/cross-tenant-sync-publicpreview/cts2.jpg"></p><p><img src="/blog/azure-active-directory/cross-tenant-sync-publicpreview/cts3.jpg"></p><h3 id="ステップ-2-ソーステナントでテナント間同期を有効化する"><a href="#ステップ-2-ソーステナントでテナント間同期を有効化する" class="headerlink" title="ステップ 2 - ソーステナントでテナント間同期を有効化する"></a>ステップ 2 - ソーステナントでテナント間同期を有効化する</h3><p>Contoso US の管理者は、テナント間同期を有効にし、以下を指定します。 </p><ul><li>同期するユーザー (グループ メンバーシップに基づく)。</li><li>同期する属性 (名前、部署、ディレクトリの拡張属性など)。</li><li>表示名の末尾にドメインを追加するなど、必要な変換を行う。</li></ul><p>新規ユーザーは、テナント間で自動的にプロビジョニングされ、必要なアプリケーションにアクセスできるようになり、新しいテナントのリソースに初めてアクセスする際に同意のプロンプトが表示されることはありません。古いスクリプトで作成された既存の B2B ユーザーは、上記で指定されたルールに従って更新されます。 </p><h3 id="ステップ-3-テナント間同期を監視する"><a href="#ステップ-3-テナント間同期を監視する" class="headerlink" title="ステップ 3 - テナント間同期を監視する"></a>ステップ 3 - テナント間同期を監視する</h3><p>Contoso US の管理者は、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/reports-monitoring/concept-provisioning-logs">プロビジョニング ログ</a> を使用して、組織内のテナント間で作成されたすべてのユーザーを監視できます。さらに <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/application-provisioning-log-analytics">Azure Monitor</a> を使用してデータを視覚化するためのカスタム ダッシュボードを作成することも可能です。以下のダッシュボードでは、Contoso US の管理者は、Contoso US テナントのユーザー Nestor がアクセス可能なすべてのテナントを確認できます。Nestorは、2 つのテナント (Contoso EMEA と Contoso APAC) と、彼が以前にプロビジョニングされたいくつかのアプリケーション (ServiceNow と Zscaler Two) へのアクセス権を持っています。Contoso の管理者は、テナント間同期が機能していることを確認できたので、カスタム スクリプトを廃止することができます。</p><p><img src="/blog/azure-active-directory/cross-tenant-sync-publicpreview/cts4.jpg">  </p><h2 id="お客様の声"><a href="#お客様の声" class="headerlink" title="お客様の声"></a>お客様の声</h2><p>DB Systel は、ドイツ国鉄の IT 子会社であり、デジタル パートナーとして、DB AG の全企業のデジタル化を推進しています。同社は、最高の IT 標準と革新的なトピックに基づいて、最適なソリューションとコンサルティング サービスを開発しています。これを実現するために、DB Systel は鉄道と IT に関する豊富な専門知識を活用しています。</p><p><strong>“テナント間同期により、当社のさまざまなテナントを接続し、すべてのマイクロソフト製品で従業員がよりシームレスに対話できるようになりました。また、オンプレミスでの専用アカウントが不要なため、運用コストの削減やテナントのセキュリティの向上にもつながります。弊社は、Azure AD のマルチテナント コラボレーション機能に全面的に信頼を寄せています。”</strong></p><p>組織内のテナント間でユーザー アカウントの作成を自動化することで、組織を改善するための他の方法の検討に時間を費やせることになります。パブリック プレビュー版では、テナント間の同期をさらに向上させるためのフィードバックをお待ちしています。</p><p>ぜひ今すぐテナント間同期をお試しください。これらの新機能に関するご意見は、<a href="https://aka.ms/AzureADFeedback">Azure フォーラム</a> または Twitter で <a href="https://twitter.com/azuread">@AzureAD</a> のタグを付けてお寄せください。  </p><p>Joseph Dadzie, Partner Director of Product Management<br>Linkedin: @joedadzie<br>Twitter: @joe_dadzie</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は、2023 年 1 月 31 日に米国の Microsoft Entra (Azure AD) Blog で公開された &lt;a href=&quot;https:</summary>
      
    
    
    
    
    <category term="B2B" scheme="https://jpazureid.github.io/blog/tags/B2B/"/>
    
    <category term="Azure AD B2B" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-B2B/"/>
    
    <category term="Cross-Tenat Synchronization" scheme="https://jpazureid.github.io/blog/tags/Cross-Tenat-Synchronization/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD に IPv6 が導入されます</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/ipv6-coming-to-azuread/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/ipv6-coming-to-azuread/</id>
    <published>2023-01-22T01:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.503Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 五十嵐 です。</p><p>本記事は、2023 年 1 月 10 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/ipv6-coming-to-azure-ad/ba-p/2967451">IPv6 Coming to Azure AD</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>企業ネットワーク、サービス プロバイダー、デバイスの間で IPv6 の導入とサポートが進む中、多くのお客様が、ユーザーが IPv6 クライアントや IPv6 ネットワークから自社のサービスやアプリケーションに引き続きアクセスできるのかどうか、疑問に思われていることでしょう。</p><p>本日、Microsoft Azure Active Directory (Azure AD) に IPv6 のサポートを導入する計画を発表することができ、大変うれしく思います。これにより、お客様は IPv4、IPv6、またはデュアル スタックのエンドポイントを介して Azure AD サービスにアクセスできるようになります。 </p><p>ほとんどのお客様にとって、IPv4 が IT 環境から完全に消えることはないと思われます。そのため、<strong>Azure AD の機能やサービスにおいて IPv6 を必須としたり、IPv4 の優先順位を下げたりすることは計画していません</strong>。しかし、このブログの推奨事項にのっとり、<a href="https://aka.ms/azureadipv6">こちらのリンク</a> から最新のガイダンスを確認することで、IPv6 サポートにむけた計画および準備を始めることが重要です。</p><p>Azure AD サービスへの IPv6 サポートの導入は、<strong>2023 年 3 月 31 日</strong> から段階的に開始される予定です。 </p><p>IPv6 アドレスを使用していることに加え、条件付きアクセス ポリシーでネームド ロケーションを使用している Azure AD のお客様に向けたガイダンスを以下に記載します。 </p><p><strong>組織内の特定のネットワーク境界を識別するために <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/location-condition">ネームド ロケーション</a> を使用しているお客様は、以下のことを行う必要があります。</strong></p><ol><li>既存のネームド ロケーションの監査を実施し、潜在的な影響を予測する。</li><li>ネットワーク パートナーと協力して、お客様の環境で使用されている外向きの IPv6 アドレスを特定する。</li><li>既存の <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/location-condition#ip-address-ranges">ネームド ロケーション</a> を見直して、確認した IPv6 範囲を含める。</li></ol><p><strong>特定のネットワークからのアプリへのアクセスを制限し、保護するために、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/location-condition">場所に基づく条件付きアクセス ポリシー</a> を使用しているお客様は、以下のことを行う必要があります。</strong></p><ol><li>既存の条件付きアクセス ポリシーの監査を実施し、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/location-condition">ネームド ロケーション</a> を使用している場合は、潜在的な影響がないかを確認する。</li><li>既存の <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/location-condition">場所に基づく条件付きアクセス ポリシー</a> を見直して、組織のセキュリティ要件を引き続き満たすようにする。</li></ol><p>Azure AD における IPv6 の有効化に関する追加のガイダンスを引き続き共有するために、覚えやすいリンクを作成しました。これらの詳細については、こちら (<a href="https://aka.ms/azureadipv6">https://aka.ms/azureadipv6</a>) にアクセスください。なお、日本語の情報は <a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/active-directory/azure-ad-ipv6-support">こちら</a> をご確認ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 五十嵐 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 1 月 10 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techc</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>ゲスト ユーザーの棚卸をする方法</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/GuestUser-Inventory/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/GuestUser-Inventory/</id>
    <published>2023-01-22T00:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.091Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、 Azure ID チームの小出です。今日は、ゲスト ユーザーの棚卸をする方法について紹介します。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>多くの企業のテナントでは、外部のユーザーと一緒に Teams 会議をしたり、外部のユーザーがプロジェクトで使用するリソースにアクセスしたりできるよう、外部のユーザーをテナントにゲスト ユーザーとして招待していると思います。ゲスト ユーザーは、一般ユーザーでも Azure ポータル上から簡単に招待することができますが、ゲスト ユーザーが増えるにつれて、こんな不安をお持ちのテナント管理者もいらっしゃると思います。  </p><ul><li>不要なゲスト ユーザーを削除したいが、誰を削除したらいいかわからない。</li><li>一定期間サインインのないゲスト ユーザーを棚卸したいが、最終サインイン日時がわからない。</li><li>ゲスト ユーザーが大量にいるため、確認に工数がかかっている。棚卸を自動化したい。</li></ul><p>上記のような不安を解消するために、今回は、ゲスト ユーザーを棚卸するための機能として、アクセス レビューとゲスト ユーザーの最終サインイン日時を取得する方法の 2 つを紹介します。</p><p>なお、アクセス レビューをご利用いただくためには、Azure AD Premium P2 ライセンスが必要となります。少なくとも、レビュー担当者として割り当てられているユーザーに P2 ライセンスの割り当てが必要です。詳細については、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/access-reviews-overview#how-many-licenses-must-you-have">こちらの資料</a> をご覧ください。</p><span id="more"></span><h3 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h3><ol><li><a href="#idx1">A. アクセス レビューを使用して一定期間サインインのないユーザー アカウントを自動的に棚卸する方法</a><ul><li><a href="#idx1-1">アクセス レビューの作成手順</a></li><li><a href="#idx1-2">アクセス レビューの実施 (セルフ レビュー編)</a></li><li><a href="#idx1-3">アクセス レビューの実施 (管理者編)</a></li></ul></li><li><a href="#idx2">B. ゲスト ユーザーの最終サインイン日時を取得する方法</a></li></ol><h2 id="idx1">A. アクセス レビューを使用して一定期間サインインのないユーザー アカウントを自動的に棚卸する方法</h2><p>アクセス レビューは、特定のグループやアプリケーションに割り当てられたユーザーを対象に、グループのメンバーシップやアプリケーションの割り当てに問題がないか (不要なユーザーに割り当てが行われていないか) を定期的に確認できる機能です。</p><p>1 回もしくは定期的に行われるレビューでは、レビューを行う管理者ユーザー (以下、レビュー担当者) が、レビュー内で各ユーザーに対し、[許可] もしくは [拒否] を設定します。詳細は後述しますが、レビュー担当者はレビュー内で各対象ユーザーの最終サインイン日時 (=最終利用日時) を確認することが可能ですので、そちらをもとに割り当ての「許可」「拒否」を選択します。</p><p>レビューで拒否が選択された場合、たとえばグループから自動的にユーザーを削除したり、アプリケーションから割り当てを自動的に削除したりすることができます。さらには 30 日間アカウントを無効化 (サインインをブロック) したのちにユーザーを自動的に削除することも可能です。</p><p>このアクセスレビュー機能を応用してゲスト ユーザーの棚卸を行いますが、実際のところレビューを行う管理者は不特定多数のゲスト ユーザーについて 1 人 1 人アクセスの要否を判断することは困難です。そのため、今回はゲスト ユーザー自身にセルフレビューを依頼し、アクセス権の継続が必要な場合のみ [許可] してもらいます。アクセス権が不要になったゲスト ユーザーは自ら [拒否] を選択することも、レビュー自体を無視することも可能です。(レビューを無視した場合は [拒否] 扱いとすることが可能です。)</p><p>以下の手順にてレビューを作成すると、レビューで拒否が設定されたゲスト ユーザーは自動的に無効化され、 30 日後にテナントから自動的に削除されます。</p><h3 id="idx1-1">アクセス レビューの作成手順</h3><ol><li><p>Azure ポータルにサインインし、 [Azure Active Directory] - [Identity Governance] を開きます。もしくは、ポータル上の検索ボックスより、[Identity Governance] を開きます。</p><p> <img src="/blog/azure-active-directory/GuestUser-Inventory/1_access_IdentityGovernance.png"></p></li><li><p>左ペインにて [アクセス レビュー] をクリックし、 [+ 新しいアクセス レビュー] を選択します。</p><p> <img src="/blog/azure-active-directory/GuestUser-Inventory/2_select_AccessReview.png"></p></li><li><p>レビュー対象を指定します。たとえば、 特定のグループを対象にゲスト ユーザーのレビューを行いたい場合は、以下のように指定します。</p><p> 手順1: [チームとグループ] を選択します。<br> 手順2: [チームとグループの選択] を選択し、ゲスト ユーザーが所属しているグループを選択します。<br> 手順3: [ゲスト ユーザーのみ] を選択します。  </p><p> <img src="/blog/azure-active-directory/GuestUser-Inventory/3_create_review1.png"></p><p> 手順 2 ではレビュー対象のグループを指定します。ゲスト ユーザーは既存の業務用セキュリティ グループ (例: プロジェクト A グループ) に参加させることが一般的かと思います。この場合、既存の業務用セキュリティ グループを手順 2 で選択しつつ、手順 3 では [ゲスト ユーザーのみ] を選択すればレビュー対象をゲスト ユーザーのみに限定することが可能です。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>なお、手順 2 で[ゲスト ユーザーを含むすべての Mcirosoft 365 グループ] を選択すると、後述の手順にて [拒否されたゲスト ユーザーに適用するアクション] が構成できません。そのためこの項目では [チームとグループの選択] を使用します。</p></div><div class="alert is-success"><p class="alert-title">ヒント</p><p>ゲスト ユーザーを既存の業務用セキュリティグループに参加させていない場合は、ゲスト ユーザー全員を含む動的グループを利用する方法もあります。具体的には <code>(user.userType -eq &quot;Guest&quot;)</code> のルールで動的グループを作成すると、ゲスト ユーザー全員がメンバーに含まれるグループが作成されます。以下では本グループを手順 2 で指定します。  </p></div><p> 動的グループの作成方法の詳細は、本記事では省略しております。以下の公開情報をご確認ください。</p><p> <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/enterprise-users/groups-create-rule#to-create-a-group-membership-rule">グループ メンバーシップ ルールを作成するには</a></p><p> <img src="/blog/azure-active-directory/GuestUser-Inventory/4_DynamicGroup_forGuest.png"></p><div class="alert is-success"><p class="alert-title">ヒント</p><p> 非アクティブなユーザーのみを、アクセス レビューの対象とすることもできるようになりました。新機能を利用したい場合は、下記チェックをオンにしたうえで、どれくらいサインインのないユーザーをレビューの対象とするか、日付を指定します。</p><p><img src="/blog/azure-active-directory/GuestUser-Inventory/15_inactiveuser_available.png"></p></div></li><li><p>必要に応じて、レビュー担当者と繰り返しの設定を行います。以下の画面では、半年ごとに、ゲスト ユーザー自身がレビューを行うよう設定しています。</p><p> <img src="/blog/azure-active-directory/GuestUser-Inventory/5_create_review2.png"></p><ul><li>管理者のレビューへの負担を最小限にしたい場合は、本手順のように [レビュー担当者を選択する] にて [ユーザーによる自分のアクセスのレビュー] を選択し、 ゲスト自身がセルフ レビューを行うよう構成します。</li><li>ゲスト自身ではなく、特定のユーザーが一括でレビューを管理したい場合は、 [ユーザーまたはグループが選択済み] を選択してレビュー担当者を個別に指定することも可能です。また、[グループの所有者] を選択して、グループの所有者をレビュー担当者とする構成も実現できます。</li><li>上記の設定では、14 日間有効なレビューが半年ごとに繰り返し実行されます。レビューの依頼をうけたゲスト ユーザーは 14 日間 (2 週間) 以内にレビューに対して応答する必要があります。</li></ul><div class="alert is-success"><p class="alert-title">ヒント</p><p>複数ステージのアクセス レビューも実施できるようになりました。最大 3 段階のステージでレビューを行うことができます。たとえば第 1 ステージでセルフ レビューを行い、第 2 ステージ以降で所有者および管理者によるレビューを行うことも可能です。</p><p><img src="/blog/azure-active-directory/GuestUser-Inventory/16_multistage_available.png"></p></div></li><li><p>アクセス レビューの設定を行います。</p><p> <img src="/blog/azure-active-directory/GuestUser-Inventory/6_create_review3.png"></p><p> 自動的に棚卸を行うために、 [リソースへの結果の自動適用] を [有効] に設定します。また、[レビュー担当者が応答しない場合] の設定を [アクセスの削除] に設定します (管理者がレビューを行う場合は、 [アクセスの削除] もしくは  [推奨事項の実行] に設定します。)</p><p> レビューで拒否されたゲスト ユーザーをブロックし、30 日後にテナントから削除されるようにするためには、[拒否されたゲスト ユーザーに適用するアクション] の項目で、[ユーザーのサインインを 30 日間ブロックした後、テナントからユーザーを削除します] を選択します。</p><p> 主な設定項目の説明と、指定する際の判断基準は以下の通りです。</p><table><thead><tr><th>項目</th><th>説明</th></tr></thead><tbody><tr><td>[リソースへの結果の自動適用]</td><td>レビュー完了後、自動で結果を反映させたい場合は [有効] にします。</td></tr><tr><td>[レビュー担当者が応答しない場合]</td><td>レビュー担当者がレビューを行わなかったユーザーに対し、どのような処理を行うか指定します。</td></tr><tr><td>[拒否されたゲスト ユーザーに対するアクション]</td><td>ゲスト ユーザーが拒否された場合の動作を指定します。</td></tr></tbody></table><table><thead><tr><th>[レビュー担当者が応答しない場合] の選択肢</th><th>説明</th></tr></thead><tbody><tr><td>[変更なし]</td><td>レビュー担当者が応答しない場合、特に何も実行されません。</td></tr><tr><td>[アクセスの削除]</td><td>レビュー担当者が [拒否] を設定した時と同様の処理が行われます。実際に行われる処理は、以下の [拒否されたゲスト ユーザーに対するアクション] によって決定されます。</td></tr><tr><td>[アクセスを承認する]</td><td>レビュー担当者が [許可] を設定した時と同様の処理が行われます。そのため、引き続きグループのメンバーシップが維持されます。</td></tr><tr><td>[推奨事項の実行]</td><td>システム上で算出される推奨事項が実行されます。具体的には、 30 日以内にサインインがあれば [許可] 、 30 日以内にサインインがなければ [拒否] が選択される動作となります。    また、 [拒否] が選択されたユーザーに対して行われる処理は、[拒否されたゲスト ユーザーに対するアクション] によって決定されます。</td></tr></tbody></table><table><thead><tr><th>[拒否されたゲスト ユーザーに対するアクション] の選択肢</th><th>説明</th></tr></thead><tbody><tr><td>[リソースからユーザーのメンバーシップを削除]</td><td>レビュー対象のグループから、メンバーが削除されます。またはアプリケーションへのアクセス権が削除されます。ユーザー自体は特に影響を受けないため、テナントには引き続きサインインできます。</td></tr><tr><td>[ユーザーが 30 日間サインインできないようにしてから、テナントからユーザーを削除する]</td><td>他のリソースへのアクセス権を持っているかどうかに関係なく、拒否されたユーザーによるテナントへのサインインがブロックされます。    また、 30 日後にテナントからゲスト ユーザーが削除されます。</td></tr></tbody></table></li><li><p>レビュー名と説明を記入し、アクセスレビューを作成します。</p><p> <img src="/blog/azure-active-directory/GuestUser-Inventory/7_create_review4.png"></p></li></ol><h3 id="idx1-2">アクセス レビューの実施 (セルフ レビュー編)</h2><ol><li><p>アクセス レビューが開始されると、レビュー対象者の元に <a href="mailto:&#x61;&#x7a;&#x75;&#x72;&#101;&#45;&#x6e;&#111;&#114;&#x65;&#112;&#108;&#x79;&#x40;&#x6d;&#105;&#x63;&#114;&#x6f;&#115;&#111;&#x66;&#x74;&#46;&#99;&#111;&#109;">&#x61;&#x7a;&#x75;&#x72;&#101;&#45;&#x6e;&#111;&#114;&#x65;&#112;&#108;&#x79;&#x40;&#x6d;&#105;&#x63;&#114;&#x6f;&#115;&#111;&#x66;&#x74;&#46;&#99;&#111;&#109;</a> からメールが届くので、[レビューを開始する（Review Access）] をクリックします。  </p><p> <img src="/blog/azure-active-directory/GuestUser-Inventory/8_selfReview1.png"></p></li><li><p>以下のような画面が表示されるので、セルフ レビューを実施します。  </p><p> <img src="/blog/azure-active-directory/GuestUser-Inventory/9_selfReview2.png"></p></li><li><p>画面が以下のように遷移します。 Progress の項目が 1/1 と表示されていることを確認します。  </p><p> <img src="/blog/azure-active-directory/GuestUser-Inventory/10_selfReview3.png"></p></li><li><p>指定した日付が経過するなどしてレビューが完了すると、[自動適用] が有効な場合は、自動的に [拒否されたゲスト ユーザーに対するアクション] が実行されます。</p></li></ol><p>たとえば、[ユーザーが 30 日間サインインできないようにしてから、テナントからユーザーを削除する] を設定した場合、拒否したユーザーの [サインインのブロック] が [はい] になります。この状態では、まだユーザーは削除されませんが、ユーザーはポータル上にサインインできない状態となります。また、このあと 30 日経過すると、そのゲスト ユーザーはテナントから削除されます。</p><h3 id="idx1-3">アクセス レビューの実施 (管理者編)</h2><p>上記まではゲスト ユーザー自身にレビューを実施してもらう手順となりますが、もしゲスト ユーザーの数が少ない場合などは管理者が代表してレビューを行うことも可能です。この場合の手順を後述します。</p><ol><li><p>アクセス レビューが開始されると、レビュー対象者の元に <a href="mailto:&#97;&#x7a;&#117;&#114;&#101;&#x2d;&#x6e;&#111;&#x72;&#x65;&#x70;&#108;&#121;&#64;&#109;&#105;&#99;&#x72;&#111;&#x73;&#111;&#x66;&#116;&#46;&#99;&#111;&#109;">&#97;&#x7a;&#117;&#114;&#101;&#x2d;&#x6e;&#111;&#x72;&#x65;&#x70;&#108;&#121;&#64;&#109;&#105;&#99;&#x72;&#111;&#x73;&#111;&#x66;&#116;&#46;&#99;&#111;&#109;</a> からメールが届くので、[レビューを開始する] をクリックします。</p><p> <img src="/blog/azure-active-directory/GuestUser-Inventory/11_adminreview1.png"></p></li><li><p>ユーザーの状況を確認します。各ユーザーを選択すると、 [承認する] と [拒否] がクリックできるようになるので、承認もしくは拒否を指定します。</p></li><li><p>[決定] の項目に、レビューを行った際の承認・拒否の値が表示されることを確認します。</p><p> <img src="/blog/azure-active-directory/GuestUser-Inventory/12_adminreview2.png"></p></li><li><p>指定した日付が経過するなどしてレビューが完了すると、[自動適用] が有効な場合は、自動的に [拒否されたゲスト ユーザーに対するアクション] が実行されます。</p></li></ol><p>アクセス レビューに関する以下の公開情報も、併せてご確認ください。  </p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/governance/access-reviews-external-users#disable-and-delete-external-identities-with-azure-ad-access-reviews">Azure AD アクセス レビューを使用して外部 ID の無効化および削除を行う</a>  </li><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/governance/create-access-review">アクセスレビュー作成手順</a></li></ul><h2 id="idx2">B. ゲスト ユーザーの最終サインイン日時を取得する方法</h2><p>アクセス レビューを使用した棚卸についてご案内しましたが、この機能を利用するためには、 Azure AD Premium P2 ライセンスが必要です。そのため、 Azure AD Premium P1 ライセンスまでのみお持ちの環境では、上記の機能を利用することができません。</p><p>棚卸を完全に自動化したい場合は、Azure AD Premium P2 ライセンスの購入を検討する必要がありますが、一定期間サインインのないユーザーを抽出するのみであれば、以下の Github リポジトリに記載のスクリプトを使用することで、ユーザーの最終サインイン日時を取得することが可能です。</p><p><a href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-get-lastSignInDateTime/">最終サインイン日時を一括で取得する方法</a></p><p>このスクリプトを利用するためには、アプリケーションの登録などの事前準備が必要です。必要な手順につきましては、以下にて詳細をご案内しておりますので、こちらも併せてご参照ください。</p><p><a href="https://github.com/jpazureid/get-last-signin-reports/tree/use-signin-activity-beta-api">アプリケーションの登録手順</a></p><p>スクリプトを実行すると CSV ファイルが出力され、以下のように、ユーザーの ID、UPN、最終サインイン日時、アプリケーション情報を順に確認できます。LastSingInDateUTC は、対話型の最終サインイン日時です。LastNonInteractiveSigninDateUTC は、非対話型の最終サインイン日時となります。</p><p>実行結果:</p><p><img src="/blog/azure-active-directory/GuestUser-Inventory/13_lastsignin1.png"></p><p>なお、上記にてダウンロードしたスクリプトでは、ゲスト ユーザーのみならず、テナントに登録されているすべてのユーザーの情報が取得されます。そのため、取得対象をゲスト ユーザーのみにしたい場合は、Get-LastSignIn.ps1 のスクリプトの 48 行目を、以下のように修正してから実行ください。  </p><p>修正箇所:</p><p><img src="/blog/azure-active-directory/GuestUser-Inventory/14_lastsignin2.png"></p><p>修正前:</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$users</span> = <span class="built_in">Get-MgUser</span> <span class="literal">-All</span> <span class="literal">-Property</span> id, userPrincipalName, signInActivity</span><br></pre></td></tr></table></figure><p>修正後:</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$users</span> = <span class="built_in">Get-MgUser</span> <span class="literal">-All</span> <span class="literal">-Property</span> id, userPrincipalName, signInActivity <span class="literal">-Filter</span> <span class="string">&quot;usertype eq &#x27;Guest&#x27;&quot;</span></span><br></pre></td></tr></table></figure><p>上記手順で 30 日以上サインインしていないゲスト ユーザーを手動で抽出し、必要に応じて、削除処理などを実施いただければと思います。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、 Azure ID チームの小出です。今日は、ゲスト ユーザーの棚卸をする方法について紹介します。&lt;/p&gt;
&lt;h2 id=&quot;はじめに&quot;&gt;&lt;a href=&quot;#はじめに&quot; class=&quot;headerlink&quot; title=&quot;はじめに&quot;&gt;&lt;/a&gt;はじめに&lt;/h2&gt;&lt;p&gt;多くの企業のテナントでは、外部のユーザーと一緒に Teams 会議をしたり、外部のユーザーがプロジェクトで使用するリソースにアクセスしたりできるよう、外部のユーザーをテナントにゲスト ユーザーとして招待していると思います。ゲスト ユーザーは、一般ユーザーでも Azure ポータル上から簡単に招待することができますが、ゲスト ユーザーが増えるにつれて、こんな不安をお持ちのテナント管理者もいらっしゃると思います。  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;不要なゲスト ユーザーを削除したいが、誰を削除したらいいかわからない。&lt;/li&gt;
&lt;li&gt;一定期間サインインのないゲスト ユーザーを棚卸したいが、最終サインイン日時がわからない。&lt;/li&gt;
&lt;li&gt;ゲスト ユーザーが大量にいるため、確認に工数がかかっている。棚卸を自動化したい。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;上記のような不安を解消するために、今回は、ゲスト ユーザーを棚卸するための機能として、アクセス レビューとゲスト ユーザーの最終サインイン日時を取得する方法の 2 つを紹介します。&lt;/p&gt;
&lt;p&gt;なお、アクセス レビューをご利用いただくためには、Azure AD Premium P2 ライセンスが必要となります。少なくとも、レビュー担当者として割り当てられているユーザーに P2 ライセンスの割り当てが必要です。詳細については、&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/active-directory/governance/access-reviews-overview#how-many-licenses-must-you-have&quot;&gt;こちらの資料&lt;/a&gt; をご覧ください。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="B2B" scheme="https://jpazureid.github.io/blog/tags/B2B/"/>
    
    <category term="Access review" scheme="https://jpazureid.github.io/blog/tags/Access-review/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD が提供するパスワードレスのユーザー体験</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/end-user-passwordless-utopia/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/end-user-passwordless-utopia/</id>
    <published>2023-01-07T03:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.347Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 竜 です。</p><p>本記事は、2022 年 12 月 15 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/end-user-passwordless-utopia/ba-p/2144517">End user passwordless utopia</a> を意訳したものになります。</p><hr><p>Azure と Azure Active Directory (Azure AD) で利用できる技術はたくさんありますが、全体像を把握し、それらがどのようにエンドユーザーのユーザー体験に作用するという全体像については見逃しがちです。</p><p>Azure AD で利用できる技術には以下があります: </p><ul><li>Azure AD</li><li>多要素認証 (MFA: multi-factor authentication)</li><li>パスワードレス認証</li><li>条件付きアクセスおよび認証強度</li><li>デバイス登録</li><li>プライマリ更新トークン (PRT: Primary Refresh Token)</li><li>エンタープライズ アプリ / シングル サインオン (SSO)</li><li>Intune</li><li>Autopilot</li><li>一時アクセス パス</li></ul><p>上記の中には、利便性を促進する機能もあればセキュリティを強化する機能もあります。これらの技術を使用することで、ユーザーの認証負担を軽減し、セキュリティを強化することができます。 </p><p>弊社の目標は、パスワードや資格情報のプロンプトや従来の MFA プロンプト無しに、安全性を維持しながらデバイスを使用し、企業のアプリケーションやデータにアクセスする方法を示すことです。</p><p>まずは、弊社が取り組んでいる 2 つの問題からお話しします。</p><p><strong>1. 認証疲労</strong></p><p>私たちは、ユーザーとして、20 年以上にわたり、デバイスがユーザー名とパスワードの入力プロンプトを表示する度に、それらを入力するよう促されてきました。これは、まさに攻撃者がユーザーをフィッシングするのに利用している手法です。攻撃者は、偽のサインイン ページに誘導するリンクをユーザーに送り、そこでユーザーが認証情報を入力するよう促します。</p><p><strong>2. MFA 疲労</strong>  </p><p>Microsoft の <a href="https://www.microsoft.com/en-us/security/blog/2019/08/20/one-simple-action-you-can-take-to-prevent-99-9-percent-of-account-attacks/">統計</a> によると、Azure AD で侵害されたアカウントの 99.9% は、MFA を強制していないアカウントでした。</p><p>MFA が構成されているエンド ユーザーであっても侵害するため、攻撃者はその手法を変更せざるを得なくなりました。ユーザーは、携帯電話に表示された MFA プロンプトに従って行動することが想定されます。攻撃者は、この行動を悪用してアカウントを侵害しようとします。ユーザーの認証情報が漏洩し、攻撃者が狙いすましたタイミングで多数の MFA プロンプトをユーザーに送信すると、ユーザーが誤って「承認」をクリックしてしまう可能性があります。これは、MFA フィッシングとして知られています。</p><p>Microsoft Authenticator の <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-mfa-number-match">番号の一致機能</a> により、この問題を軽減することができます。MFA プロンプトが表示されたら、ユーザーはコンピュータの画面に表示された番号を認証アプリのプロンプトに入力します。コンピューターの認証画面上にプロンプトが表示されていないのにも関わらず、Authenticator アプリ上でこのプロンプトが表示された場合、ユーザーは番号を入力できないため、ユーザーが誤って「承認」することとはできず、MFA フィッシングに遭う可能性は大幅に減少します。</p><h2 id="解決方法"><a href="#解決方法" class="headerlink" title="解決方法"></a>解決方法</h2><p>Azure AD に登録されたクラウド アプリや、アプリケーション プロキシを経由したオンプレミス アプリの利用に、パスワードレス認証を組み合わせて使用することで、これらの問題に対処できます。 </p><p>企業が管理するデバイスからであれば、ユーザーはユーザー名やパスワードの入力やを求められたり、携帯電話で MFA のプロンプトや電話、SMS による認証を行うことなく、これらのアプリケーションにアクセスすることができます。 </p><p>詳細の説明の前に、このシナリオを図で表したものが以下です。「ハイブリッド Azure AD 参加」および「Azure AD 参加」したデバイスのどちらでも同じ流れとなります。</p><p>注: 今回の説明では、ドメイン コントローラーへの認証フローは省略します。</p><p>クラウド アプリケーションにアクセスする際の SSO フローの概要:</p><p><img src="/blog/azure-active-directory/end-user-passwordless-utopia/1.png"></p><table><thead><tr><th>ステップ</th><th>説明</th></tr></thead><tbody><tr><td>A</td><td>ユーザーが Windows Hello for Business を使用して、PIN、生体認証、または FIDO2 キーを使用し、デスクトップまたはノート PC にサインインします。</td></tr><tr><td>B</td><td>コンピューターがユーザーを認証すると、次に Azure AD へのサインインを試みます。デバイスがハイブリッド Azure AD 参加しているか、Azure AD 参加しているかにより、この順序は異なります。Azure AD がユーザーを認証すると、MFA クレームを含むプライマリ更新トークンが発行されます。</td></tr><tr><td>C</td><td>ユーザーが、Azure AD を IDP (ID プロバイダー) として使用しているアプリケーションにアクセスすると、Azure AD に誘導されます。この誘導処理では、ユーザーは特段の操作を必要とせず、動作も透過的なものになります。デバイスは既に Azure AD に登録されているため、サインイン時に使用する Microsoft Online の URL がレジストリに保存されています。これらの URL が、SSO の際に誘導される Azure AD の URL と一致するため、ブラウザーこれをもって SSO を開始し、PRT の使用を試みます。</td></tr><tr><td>D</td><td>次に、条件付きアクセスがサインインを評価します。このアプリケーションを MFA で保護するポリシーが適用されている場合、PRT にすでに MFA クレームが含まれているため、ユーザーは MFA を行う必要はありません。</td></tr><tr><td>E</td><td>ここで、Azure AD は、アプリにアクセスする際に必要となるトークンをユーザーに発行します。このトークンは、アプリケーションの構成に応じて、SAML または OAuth のトークンとして発行されます。</td></tr><tr><td>F</td><td>ユーザーは、これらのトークンをアプリケーションに提示し、アプリケーションにサインインします。</td></tr></tbody></table><p>ステップ B の詳細: <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/devices/concept-primary-refresh-token#prt-issuance-during-first-sign-in">初回サインイン中の PRT 発行</a></p><p>ステップ C の詳細: <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/devices/concept-primary-refresh-token#browser-sso-using-prt">PRT を使用したブラウザー SSO</a>  </p><h2 id="動作の詳細"><a href="#動作の詳細" class="headerlink" title="動作の詳細"></a>動作の詳細</h2><h3 id="デバイスの登録"><a href="#デバイスの登録" class="headerlink" title="デバイスの登録"></a>デバイスの登録</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/devices/device-registration-how-it-works">ハイブリッド Azure AD 参加または Azure AD 参加 (デバイス登録)</a> が、Windows Hello for Business または FIDO キーを使用するための前提条件です。デバイスを Azure AD に登録するのに、様々な方法で登録プロセスを開始するようにポリシーを適用することができます。</p><h3 id="パスワードレス-MFA"><a href="#パスワードレス-MFA" class="headerlink" title="パスワードレス/MFA"></a>パスワードレス/MFA</h3><p>Windows Hello for Business や FIDO2 キーは、パスワードの代わりに、デバイス上で強力な二要素認証を行います。この認証は、デバイスに紐づけられたユーザーの資格情報で構成されており、生体認証または PIN が使用されます。Windows Hello for Business の詳細については <a href="https://learn.microsoft.com/ja-jp/windows/security/identity-protection/hello-for-business/hello-overview#how-windows-hello-for-business-works-key-points">このリンク</a> を、FIDO2 のログオンについては <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/howto-authentication-passwordless-security-key-windows">このリンク</a> をご参照ください。</p><p>ログオンを完了するためには、キーのデータを含む実際のデバイスと、そのキーへのアクセスを解除するための PIN または生体認証の 2 つの要素が必要です。この処理には、私たちが持っているもの (コンピューター)、私たちが知っているもの (PIN) または私たち自身 (生体認証) という複数要素が必要となります。なぜパスワードより PIN の方が優れているかについては、詳しくは <a href="https://learn.microsoft.com/ja-jp/windows/security/identity-protection/hello-for-business/hello-why-pin-is-better-than-password">こちらの公開情報</a> をご覧ください。</p><h3 id="エンタープライズ-アプリ-SSO"><a href="#エンタープライズ-アプリ-SSO" class="headerlink" title="エンタープライズ アプリ/SSO"></a>エンタープライズ アプリ/SSO</h3><p>デバイスが Azure AD に参加すると、いくつかの URL がレジストリに追加されます。これらの Azure AD の URL がサインインの際に使用されます。ブラウザーから Azure AD に登録されたアプリケーションにアクセスし、<strong>さらに</strong> そのブラウザーが Azure AD SSO をサポートしており (Edge、Office 用の拡張機能付きの Chrome, Firefox v91 以上)、<strong>かつ</strong> 誘導された Azure AD の URL がレジストリ内の URL と一致する場合、ブラウザ－はデバイスへのサインイン時に取得したプライマリ更新トークンを使用して、ユーザー操作を必要とせずに認証を試行します。これについては、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/devices/concept-primary-refresh-token#browser-sso-using-prt">PRT を使用したブラウザー SSO</a> で詳しく説明しています。</p><p>この場合、ユーザーには、サインイン時にプロンプトは表示され<strong>ません</strong>。</p><p>ユーザーが Azure AD に似た偽のウェブサイトに誘導され、ユーザー名とパスワードの入力プロンプトが表示されたとしても、この URL はレジストリに保存されている URL とは異なるため、SSO の処理は開始されません。偽のウェブページには SSO を受け入れるために必要なエンドポイントがないため、SSO の処理が開始されることはありません。本物の Azure AD のサインイン ページでは、パスワード プロンプトは表示されません。</p><h3 id="条件付きアクセス"><a href="#条件付きアクセス" class="headerlink" title="条件付きアクセス"></a>条件付きアクセス</h3><p>次に、条件付きアクセスが認可の要求を評価します。ユーザーやアプリに対して構成された条件付きアクセス ポリシーのアクセス制御に従って、MFA、ハイブリッド Azure AD 参加、および準拠しているデバイスなど、複数のアクセス権付与の要件 (コントロール) を設定することができます。MFA やハイブリッド Azure AD 参加など、 1 つまたは複数のコントロールを必要とすることもできます。Azure AD に登録されているデバイスは、ハイブリッド Azure AD 参加の条件を満たし、プライマリ更新トークンに存在する MFA クレームは MFA の条件を満たすことができます。</p><p>また、<a href="https://jpazureid.github.io/blog/azure-active-directory/authentication-strength-choose-the-right-auth-method-for-your/">認証強度</a> という条件付きアクセスの新しいプレビュー機能を使って、会社のデータおよびアプリにアクセスする際に、Windows Hello for Business のようなパスワードレスの認証や FIDO2 のようなフィッシング耐性のある MFA を要求することも可能です。 </p><p>これらの技術を用いることで、以下のようなことが実現可能となります:</p><ul><li>ユーザーがアカウントの正当な保持者であり、複数の認証要素を用いてコンピューターにログオンしたことを証明する。</li><li>管理されたデバイスにサインインする。 </li><li>同じアプリに、普段から使われる場所からアクセスする。</li><li>ユーザーのセキュリティ状態が変更されていないことを確認する (アカウントが無効になっていない、パスワードがリセットされていない状態)。</li><li>流出した資格情報にそのユーザーの情報が含まれていないことを確認する。</li></ul><p>ここまでのことから、ユーザーに頻繁に再認証させる必要性はないというのがお分かりいただけると思います。</p><p>注: 上記の議論は、企業が管理するデバイスにのみ当てはまります。BYOD や、その他のサポートされているデバイスでは引き続き条件付きアクセス ポリシーがトリガーされるため、MFA やその他のコントロールを満たす必要があります。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>既に多くのお客様がこれらの技術を利用しています。恐らく、皆さまの組織でも、気付かないうちにこれらの構成によってもたらされるセキュリティ強化の恩恵を受けています。上記の情報を理解したうえで、ユーザーに対して、会社のデバイスから会社のアプリケーションやサービス、データにアクセスする際に、限られた状況を除き、パスワードが要求されることはほとんどないということができます。ユーザーがパスワードを使用しなければ、パスワードが漏えいする可能性は大幅に減少します。</p><p>サイバー セキュリティのトレーニングでは、エンド ユーザーに対し、ユーザーが資格情報を入力するたびに、使用しているサイトが本物であるか、URL に疑わしいものがないか、有効な証明書などでサイトが安全であるかを確認する責任を常に課しています。MFA のプロンプトが表示された場合にも、ユーザーが自ら開始した MFA であることを確認する責任を課しています。</p><p>ユーザーがこれらの複雑さから解放され、よりシンプルな確認で済むよう共に取り組んでいきましょう。もしユーザーが自身の資格情報を入力させるようなプロンプトを見かけたら、認証を行わず、社内の IT に報告するように依頼しましょう。もし MFA のプロンプトが突然表示されたとしたら、おそらくユーザーが開始した MFA ではないので、認証を行わず社内 IT に報告するように依頼しましょう。すべてのサインインの試行とすべての MFA を確認するよりも、このような方法の方が簡単なはずです。</p><p>これらの技術により、私たちのセキュリティが向上します。ユーザーがフィッシングの被害者になる可能性を減らすことができるのです。Intune、Autopilot、Temporary Access Pass または FIDO2 キーを組み合わせれば、ユーザーは会社から支給された新しいノートパソコンを箱から取り出し、デスクトップを開いて、パスワードを知ることなく会社のアプリケーションやデータにアクセスし始めることができるようになります。これでパスワードのない世界が実現できます。</p><p>Tarek Dawoud<br>Principal Program Manager, Product Management<br>Twitter: @cybertarek</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 竜 です。&lt;/p&gt;
&lt;p&gt;本記事は、2022 年 12 月 15 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techco</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Authenticator が FIPS 140 に準拠しました</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-brings-fips-140-compliance/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/microsoft-brings-fips-140-compliance/</id>
    <published>2023-01-01T00:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.547Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの小出です。</p><p>本記事は、2022 年 12 月 8 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/microsoft-brings-fips-140-compliance-to-authenticator-supporting/ba-p/2365671">Microsoft brings FIPS 140 Compliance to Authenticator supporting Federal Agencies</a> を意訳したものになります。日本語での情報は、下記でも用意されております。併せてご確認ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/whats-new#general-availability---authenticator-on-ios-is-fips-140-compliant">新機能 リリース ノート - Azure Active Directory - Microsoft Entra | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/concept-authentication-authenticator-app#fips-140-compliant-for-azure-ad-authentication">Microsoft Authenticator の認証方法 - Azure Active Directory - Microsoft Entra | Microsoft Learn</a></li></ul><hr><p>多くのお客様が、セキュリティやコンプライアンスに配慮し、認証機能には連邦情報処理標準 (FIPS) 140 (参考: NIST SP 800-63B) で検証済みの暗号を使用する必要のある環境で業務を行っています。この度、iOS 版の Microsoft Authenticator が FIPS 140 に準拠したことをお知らせいたします (Android 版の対応は近日公開予定です)。iOS 版 Authenticator のバージョン 6.6.8 以降は、プッシュ型多要素認証 (MFA)、パスワードレス電話サインイン (PSI)、時間ベースのワンタイム パスコード (TOTP) を用いた Azure Active Directory (Azure AD) のすべての認証において FIPS 140 に準拠しています。</p><p>Authenticator が FIPS 140 に準拠したことで、連邦政府機関が <a href="https://www.whitehouse.gov/briefing-room/presidential-actions/2021/05/12/executive-order-on-improving-the-nations-cybersecurity/">大統領令 (EO) 14028 “国家のサイバー セキュリティの改善”</a> の要件を満たすこと、ならびに医療機関が <a href="https://learn.microsoft.com/en-us/azure/compliance/offerings/offering-epcs-us">EPCS (Electronic Prescriptions for Controlled Substances</a> の要件を満たす事がより容易となります。</p><p>この機能を有効にするために、Authenticator アプリや Azure ポータルで設定を変更する必要はありません。iOS の Authenticator バージョン 6.6.8 以降のユーザーは、Azure AD 認証において既定で FIPS 140 に準拠した状態になります。</p><p>Authenticator は、Apple のネイティブ暗号機能を活用し、Apple iOS デバイスで FIPS 140 (Security Level 1) への準拠を実現します。使用されている認証の詳細については、<a href="https://support.apple.com/guide/certifications/ios-security-certifications-apc3fa917cb49/1/web/1.0">Apple CoreCrypto モジュール</a> を参照ください。</p><p>皆様からのご意見をお待ちしています。コメントをお寄せいただくか、aka.ms/AzureADFeedback までお気軽にご連絡ください。</p><p>Alex Weinert (<a href="https://twitter.com/Alex_T_Weinert">@Alex_T_Weinert</a>)<br>VP Director of Identity Security, Microsoft</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの小出です。&lt;/p&gt;
&lt;p&gt;本記事は、2022 年 12 月 8 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techcomm</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD における新しい &quot;会社のブランド&quot; 機能の紹介</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/introducing-enhanced-company-branding-for-sign-in-experiences/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/introducing-enhanced-company-branding-for-sign-in-experiences/</id>
    <published>2022-12-25T00:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.495Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの高田です。</p><p>本記事は、2022 年 12 月 12 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/introducing-enhanced-company-branding-for-sign-in-experiences-in/ba-p/3094110">Introducing enhanced company branding for sign-in experiences in Azure AD</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>皆さんんにちは。</p><p>この度、Azure AD と Microsoft 365 アプリで用いられている既定の認証フローをより柔軟かつユーザー中心的にカスタマイズできるよう、会社のブランド機能を再デザインしましたのでお知らせします。新しいユーザー体験は、Azure AD 上で動作する B2B、B2E、ファースト パーティ アプリケーションのユースケースを含む、ディレクトリ内のユーザーと外部ユーザーへのサインインに適用されます。パブリック プレビューは、本日より試用できます。</p><h2 id="あなたのお客様にあなただけの体験を"><a href="#あなたのお客様にあなただけの体験を" class="headerlink" title="あなたのお客様にあなただけの体験を"></a>あなたのお客様にあなただけの体験を</h2><p>これらのカスタマイズの機能は、ユーザーの体験をより詳細に制御したいというお客様のフィードバックに基づいて追加されました。顧客向けアプリケーションを構築する場合、B2C プラットフォームでの経験から、信頼関係を構築する上で美しくブランディングされたユーザー体験が重要です。</p><p>会社のブランド機能の強化により、既定のサインイン ページや、特定のブラウザ言語を対象にしたページのデザインをカスタマイズできるようになりました。さらに、セルフ サービス パスワード リセット (SSPR)、フッターのハイパーリンク、ブラウザ アイコンのカスタマイズ、スタイル シート (CSS) によるサインイン体験の設定、事前に定義されたテンプレートを使用してヘッダーとフッターを有効にすることも可能になりました。</p><h2 id="サインイン体験を構成する"><a href="#サインイン体験を構成する" class="headerlink" title="サインイン体験を構成する"></a>サインイン体験を構成する</h2><p>新しいカスタマイズ機能は、テナントの Azure ポータルで「会社のブランド」ブレードを使用して構成できます。この画面では、ユーザーが組織のサインイン ページにアクセスしたときに表示されるカスタマイズ結果を設定することができます。これは特定のブラウザー言語ごとに構成することも可能です。</p><p>会社のブランドのブレードで利用可能なすべての新しい設定は以下のとおりです。</p><h3 id="レイアウトの構成"><a href="#レイアウトの構成" class="headerlink" title="レイアウトの構成"></a>レイアウトの構成</h3><p>サインイン ページでウェブページの各要素の配置を指定することができます。</p><p><img src="/blog/azure-active-directory/introducing-enhanced-company-branding-for-sign-in-experiences/pic1.png"></p><h3 id="カスタムのセルフ-サービス-パスワード-リセットのハイパーリンク"><a href="#カスタムのセルフ-サービス-パスワード-リセットのハイパーリンク" class="headerlink" title="カスタムのセルフ サービス パスワード リセットのハイパーリンク"></a>カスタムのセルフ サービス パスワード リセットのハイパーリンク</h3><p>この機能により、サインイン ページでのセルフ サービス パスワード リセットのリンクを表示したり、隠したり、カスタマイズすることが可能です。</p><p><img src="/blog/azure-active-directory/introducing-enhanced-company-branding-for-sign-in-experiences/pic2.png"></p><h3 id="フッターのハイパーリンクのカスタマイズ"><a href="#フッターのハイパーリンクのカスタマイズ" class="headerlink" title="フッターのハイパーリンクのカスタマイズ"></a>フッターのハイパーリンクのカスタマイズ</h3><p>サインイン ページのフッターに表示されるプライバシーと利用規約の URL および表示文字列をカスタマイズいただけます。</p><p><img src="/blog/azure-active-directory/introducing-enhanced-company-branding-for-sign-in-experiences/pic3.png"></p><h3 id="Favicon-の設定"><a href="#Favicon-の設定" class="headerlink" title="Favicon の設定"></a>Favicon の設定</h3><p>ウェブ ブラウザーのタブに表示されるアイコンを設定いただけます。</p><p><img src="/blog/azure-active-directory/introducing-enhanced-company-branding-for-sign-in-experiences/pic4.png"></p><p>設定がアップロードされると、最終的なユーザー体験をご覧いただくことができます。</p><p><img src="/blog/azure-active-directory/introducing-enhanced-company-branding-for-sign-in-experiences/pic5.png"></p><p>Azue AD Premium もしくは Office 365 を利用して、会社のブランド機能をぜひ利用ください。</p><p>会社のブランド機能については <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/how-to-customize-branding">こちら</a> もご参照ください。</p><p>いつものように、皆様からのフィードバックをお待ちしております。</p><p>Robin Goldstein<br>Director of Product Management, Microsoft identity</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの高田です。&lt;/p&gt;
&lt;p&gt;本記事は、2022 年 12 月 12 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techcom</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra ワークロード ID の一般提供</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-workload-id-ga/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-workload-id-ga/</id>
    <published>2022-12-24T00:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.555Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 三輪 です。 </p><p>本記事は、2022 年 11 月 28 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/microsoft-entra-workload-identities-now-generally-available/ba-p/3402815">Microsoft Entra Workload Identities now generally available - Microsoft Community Hub</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。 </p><hr><p>クラウドの普及に伴い、より多くのワークロードがクラウドに移行し、新しいエンタープライズ ソフトウェアのソリューションがクラウド上で直接展開されるようになっています。その結果、ワークロード用の ID が大量に増加しており、これらの ID に関連するデータやリソースへのアクセス許可が爆発的に増加しました。組織やセキュリティ プロバイダーは、これまで人間の ID についてのセキュリティに注力してきたため、こうした新たに増加している ID を管理するためのアクセス制御やセキュリティ機能は限定的でした。このため、ID セキュリティの担当者の負担はますます大きくなっています。 </p><p>ゼロ トラストとは、すべての人 (およびすべてのもの) が確実かつ継続的に認証と認可を受けるようにすることです。ワークロードのような新しい要素が組織の環境に導入されるとき、それらの要素もゼロ トラスト戦略に組み込まれなければなりません。このため、マイクロソフトでは、すべての人とすべてのものをサポートするというミッションの一環として、サポートする ID の種類を拡大し、ワークロード ID をサポートの対象に加えました。</p><p>本日、<a href="https://www.microsoft.com/ja-jp/security/business/microsoft-entra">Microsoft Entra</a> ポートフォリオの新機能として、<a href="https://www.microsoft.com/ja-jp/security/business/identity-access/microsoft-entra-workload-identities">Microsoft Entra ワークロード ID</a> の一般提供 (GA) を発表します。Microsoft Entra ワークロード ID は、独立したソリューションとして、1 ワークロード ID あたり月額 3 ドルで本日より提供されます。</p><h2 id="人間の-ID-以外の-ID-に高度な機能を拡張する"><a href="#人間の-ID-以外の-ID-に高度な機能を拡張する" class="headerlink" title="人間の ID 以外の ID に高度な機能を拡張する"></a>人間の ID 以外の ID に高度な機能を拡張する</h2><p>現在 Microsoft Entra で扱われている、ワークロード ID の数は 2019 年の 3 倍以上に増えています。Evaluserve が今年実施した調査では、68% のワークロードが機密データや資産にアクセスできることが判明しています。しかしながら、組織もセキュリティ プロバイダーも、人間の ID のセキュリティばかりに注力しがちです。結果として人間の ID のセキュリティが向上し続けているため、最近のサイバー攻撃では、ワークロード ID が標的環境への侵入口として使われ始めています。そのため、ワークロード ID を管理し保護することは、組織、ユーザー、およびデータを保護するために非常に重要です。Microsoft Entra ワークロード ID を使用すると、条件付きアクセスの実装、脅威の未然防止、ワークロード ID のライフサイクルの把握により、ワークロード ID のセキュリティを強化することができます。 </p><p>主な機能:</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/workload-identity">条件付きアクセス</a>: 業界で最も強力なアクセス制御の 1 つである条件付きアクセスをワークロード ID に導入することができます。条件付きアクセスは、ワークロード ID の場所ベースまたはリスク ベースのポリシーをサポートします。組織は信頼できる場所以外からのサインイン試行や、Identity Protection によって検出された危険なアプリやサービスによるサインイン試行をブロックすることができます。 </li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/identity-protection/concept-workload-identity-risk">Identity Protection</a>: 人間の ID とは異なり、ワークロード ID のライフサイクルは十分に定義されていないことが多く、そのため管理が困難です。この問題に対処するため、マイクロソフトではワークロード ID のライフサイクルを横断的に調査し、怪しい兆候がないかを監視しています。Identity Protection は、資格情報の侵害、異常なサインイン、アカウント情報の不審な変更に関するレポートを提供します。危険なユーザーと同様に、危険なワークロード ID のリスク レポートは、ポータル、Microsoft Graph、または、診断設定を使用してデータをエクスポートした先のツールなど、お好みのフォーマットで表示することができます。 </li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/privileged-identity-management/pim-create-azure-ad-roles-and-resource-roles-review">アクセス レビュー</a>: 特権ロールの割り当てに関連するリスクを軽減するために、定期的なアクセス レビューが必要です。この機能により、ワークロード ID に対してアクセス レビューを作成し、最小特権アクセスを強制することができます。 </li></ul><p>これは、ワークロード ID を使用して組織の生産性と安全性を維持するという弊社の取り組みの始まりにすぎません。未使用のアプリ、期限切れの資格情報、未使用の資格情報などのアプリケーションに関する推奨事項を提供する新機能である <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/reports-monitoring/overview-recommendations">Azure Active Directory の推奨事項</a>の App Health Recommendations は、11 月末までにパブリック プレビューを開始する予定です。 </p><h2 id="Microsoft-Entra-Workload-Identities-を今すぐお試しください"><a href="#Microsoft-Entra-Workload-Identities-を今すぐお試しください" class="headerlink" title="Microsoft Entra Workload Identities を今すぐお試しください"></a>Microsoft Entra Workload Identities を今すぐお試しください</h2><p>Microsoft Entra Workload Identities の <a href="https://ms.portal.azure.com/?feature.canmodifyextensions=true&feature.canmodifystamps=true&Microsoft_Azure_ManagedServiceIdentity=test3&Microsoft_AAD_IAM_isWorkloadIdentitiesFreeTrialEnabled=true&Microsoft_Azure_ManagedServiceIdentity_isWorkloadIdentitiesUpsellBannerEnabled=true&Microsoft_Azure_ManagedServiceIdentity_isWorkloadIdentitiesPlaceHolderBannerEnabled=false#view/Microsoft_Azure_ManagedServiceIdentity/WorkloadIdentitiesBlade">90 日間無料試用版</a> では、新しい条件付きアクセス ポリシーを設定し、検出されたリスクのレポートを確認し、最小特権アクセスを適用することができます。 </p><p>Microsoft Entra ワークロード ID の詳細については、<a href="https://www.microsoft.com/ja-jp/security/business/identity-access/microsoft-entra-workload-identities">弊社の Web サイト</a> で <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/workload-identities-overview">製品ドキュメント</a> をご覧ください。この体験をお客様と共にすることを楽しみにしており、お客様からのご連絡をお待ちしております。 </p><p>Ilana Smith<br>Group Product Manager<br>Azure Active Directory<br>@ilanas</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 三輪 です。 &lt;/p&gt;
&lt;p&gt;本記事は、2022 年 11 月 28 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://tech</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>新しい管理センターにおける Azure AD および他の ID とアクセス製品の統合</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/new-admin-center-unifies-azure-ad-with-other-identity-and-access-product/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/new-admin-center-unifies-azure-ad-with-other-identity-and-access-product/</id>
    <published>2022-12-18T03:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.567Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 竜 です。</p><p>本記事は、2022 年 12 月 1 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/new-admin-center-unifies-azure-ad-with-other-identity-and-access/ba-p/2792595">New Admin Center Unifies Azure AD with Other Identity and Access Products</a> を意訳したものになります。</p><hr><p>Microsoft の ID に関するビジョンは、従来の ID 管理を超えて、マルチクラウドやマルチプラットフォーム環境におけるすべての人、すべてのものへのアクセスを保護するツールセットをお客様に提供することです。今年初めには、<a href="https://www.microsoft.com/ja-jp/security/business/microsoft-entra">Microsoft Entra</a> と新しい <a href="https://entra.microsoft.com/">Microsoft Entra 管理センター</a>を発表し、このビジョンを大幅に前進させました。</p><p>Microsoft 365 および Azure Active Directory (Azure AD) のお客様を対象とした Entra 管理センターの段階的なロールアウトをお知らせします。今月から、多くのお客様の手元でも、Azure AD 管理センター (<a href="https://aad.portal.azure.com/">aad.portal.azure.com</a>) に代わり、Microsoft 365 から <a href="https://entra.microsoft.com/">entra.microsoft.com</a> に自動的に遷移され始めるようになります。</p><p><img src="/blog/azure-active-directory/new-admin-center-unifies-azure-ad-with-other-identity-and-access-product/01.png"></p><h2 id="Microsoft-Entra-の管理センターを知る"><a href="#Microsoft-Entra-の管理センターを知る" class="headerlink" title="Microsoft Entra の管理センターを知る"></a>Microsoft Entra の管理センターを知る</h2><p><a href="(https://entra.microsoft.com/#home)">Microsoft Entra の管理センター</a> は、以下のような <a href="https://www.microsoft.com/ja-jp/security/business/microsoft-entra">Microsoft Entra</a> の ID とアクセス ソリューションの全体像を可視化し管理機能を統合します。  </p><p>  <strong>Azure AD</strong></p><p>  30 万以上の組織で使用されているマルチクラウドの ID およびアクセス管理ソリューションで、人々をアプリケーション、デバイス、データに結び付け、組織を保護します。</p><p>  <strong>Microsoft Entra Permissions Management</strong></p><p>  クラウド基盤のエンタイトルメント管理 (CIEM: Cloud Infrastructure Entitlement Management) ソリューションにより、マルチクラウド インフラ全体の権限リスクを発見し、修復し、監視することができます。</p><p>  <strong>Microsoft Entra Verified ID</strong></p><p>  プライバシーを尊重した非中央集権的な ID 資格情報の作成、発行および検証を行う ID 検証ソリューションで、あらゆる人や物事に対して、より安全なやり取りを実現することができます。</p><p>  <strong>Microsoft Entra ワークロード ID</strong></p><p>  アプリケーションやサービスなどのデジタル ワークロードの ID を管理し、保護することができます。リスクベースのポリシーと最小特権アクセスの実施により、クラウド リソースへのアクセスを制御します。</p><p>  <strong>Microsoft Entra Identity Governance</strong></p><p>  オンプレミスおよびクラウド ベースのユーザー ディレクトリにまたがる完全なソリューションにより、運用を簡素化すること、規制要件を満たすこと、および複数の個別ソリューション (特定の個別事象を解消するための機能) を統合することを実現します。</p><p>2023 年には、Microsoft Entra 管理センターを通じて、さらに多くの機能が提供される予定です。</p><h2 id="Azure-AD-はどうなるのでしょうか？"><a href="#Azure-AD-はどうなるのでしょうか？" class="headerlink" title="Azure AD はどうなるのでしょうか？"></a>Azure AD はどうなるのでしょうか？</h2><p>Microsoft Entra の管理センターから、Azure AD の管理タスクをすべて完了させることができます。Azure AD 管理センターにある機能は、すべて、Entra 管理センターの左パネル内の [Azure AD] タブから引き続き利用できます。また、Entra 管理センターにあるリンクから、Azure AD 管理センターに戻ることができます。</p><p>Azure AD は、Azure AD アプリケーション ギャラリー、多要素認証、パスワードレスなどご好評いただいている機能により、従業員、顧客、パートナーのアクセスを保護するための基本的なソリューションを提供し続けています。<a href="https://www.microsoft.com/en-us/security/blog/?p=124436">Microsoft は、2022 年に Gartner® Magic Quadrant™ for Access Management にて 6 年連続でリーダーに選ばれており</a>、認証、回復性、条件付きアクセスの分野で <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/bg-p/Identity">日々進化を続けて</a> います。</p><h2 id="Microsoft-Entra-管理センターへの移行を準備する"><a href="#Microsoft-Entra-管理センターへの移行を準備する" class="headerlink" title="Microsoft Entra 管理センターへの移行を準備する"></a>Microsoft Entra 管理センターへの移行を準備する</h2><p>管理画面に継続してアクセスできるよう、組織は必要に応じて、ファイアウォール ルールを更新する必要があります。</p><p>Microsoft Entra の管理センターは、本日より <a href="https://entra.microsoft.com/">entra.microsoft.com</a> で利用できますので、完全移行に向けてぜひご活用ください。</p><p><a href="https://entra.microsoft.com/">管理センター</a> から、ご意見をお寄せいただけるのをお待ちしております。</p><p>Kristina Hotz, Principal Manager of Product Management</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 竜 です。&lt;/p&gt;
&lt;p&gt;本記事は、2022 年 12 月 1 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techcom</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>機械学習による推奨事項（ピア外れ値）をアクセス レビューに導入する方法について</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/machine-learning-recommendations-in-access-review/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/machine-learning-recommendations-in-access-review/</id>
    <published>2022-12-14T00:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.507Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。 Azure ID チームの小出です。</p><p>この記事では、2022 年 12 月 1 日に公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/introducing-machine-learning-based-recommendations-in-azure-ad/ba-p/2466923">Introducing Machine Learning based recommendations in Azure AD Access reviews</a> の記事の抄訳をもとに、新しいアクセス レビューの機能について紹介します。</p><hr><p>従業員やゲスト、ワークロード ID のアクセスを管理できる Azure AD のアクセス レビューの機能は、すでに多くのお客様にご利用いただいております。一方、これまでに「レビューのプロセスを簡単にしてほしい」、「もう少し迅速に決定を下せるようにしたい」とのご要望をいただいていました。</p><p>今回は、「ピア外れ値」を活用した、新しいアクセス レビューの「推奨事項」についてご紹介します。</p><p>この機能は、高度な機械学習モデルを使用し、組織のレポート構造 (組織図) に基づいて、レビュー対象グループへのユーザーの所属状況を判断します。この機能が「推奨事項」に追加されたことにより、レビュー担当者は、レビューを簡単に行うことができるようになりました。</p><p><img src="/blog/azure-active-directory/machine-learning-recommendations-in-access-review/machine-learning-recommendations-in-access-review1.png"></p><h2 id="User-to-Group-Affiliation-ピア外れ値-とは何ですか？"><a href="#User-to-Group-Affiliation-ピア外れ値-とは何ですか？" class="headerlink" title="User-to-Group Affiliation (ピア外れ値) とは何ですか？"></a>User-to-Group Affiliation (ピア外れ値) とは何ですか？</h2><p>User-to-Group Affiliation (ピア外れ値) は、組織のレポート構造 (組織図) に基づいて、グループ内の他のユーザーとユーザーの相対的な所属を比較するものです。機械学習ベースで点数をつけるメカニズムにより、組織階層内のユーザー間の距離を識別する仕組みです。これにより、グループ内の他のユーザー (ピア) と非常に離れているユーザー、つまり「所属度合いが低い」外れ値のユーザーを検出し、システムは「拒否」の推奨事項を表示します。</p><p>具体例を用いて紹介しますと、レビュー対象としているグループの中に、下記赤丸の 4 名のユーザーがいたとします。3 名は組織図上同じ部門に所属していますが、 1 名だけ違う部門に所属しており、ほかの 3 名と比べて違和感があります。</p><p>このような場合、1人だけ所属から離れたユーザーは「グループに所属すべきではない」と機械学習で判断し、「拒否」の推奨事項を画面に表示します (あくまでも推奨事項のため、推奨事項と異なる決定をすること自体は可能です)。</p><p><img src="/blog/azure-active-directory/machine-learning-recommendations-in-access-review/machine-learning-recommendations-in-access-review2.png"></p><h2 id="User-to-Group-Affiliation-ピア外れ値-の設定方法"><a href="#User-to-Group-Affiliation-ピア外れ値-の設定方法" class="headerlink" title="User-to-Group Affiliation (ピア外れ値) の設定方法"></a>User-to-Group Affiliation (ピア外れ値) の設定方法</h2><p>アクセス レビュー作成時の画面で簡単に設定できます。User-to-Group Affiliation (ピア外れ値) のチェックをオンにするだけで、そのほかは通常のレビューと変更ありません。</p><p><img src="/blog/azure-active-directory/machine-learning-recommendations-in-access-review/machine-learning-recommendations-in-access-review3.png"></p><h2 id="レビュー担当者がどのように推奨事項を活用できるか？"><a href="#レビュー担当者がどのように推奨事項を活用できるか？" class="headerlink" title="レビュー担当者がどのように推奨事項を活用できるか？"></a>レビュー担当者がどのように推奨事項を活用できるか？</h2><p>アクセス レビューのレビュー担当者は、そのユーザーがグループ内の他のユーザーと「関係度合いが低い」場合、既存の非アクティブ ユーザーの推奨事項と同様に、推奨事項の情報を見ることができます。レビュー担当者は、「推奨事項を承認する」をクリックして推奨事項を承認するか、推奨事項に表示された情報に基づいて、手動でアクセスを「承認」または「拒否」することができます (あくまでも推奨事項のため、推奨事項と異なる決定をすること自体は可能です)。</p><p><img src="/blog/azure-active-directory/machine-learning-recommendations-in-access-review/machine-learning-recommendations-in-access-review4.png"></p><h2 id="承認および拒否の決定を判断するための追加情報について"><a href="#承認および拒否の決定を判断するための追加情報について" class="headerlink" title="承認および拒否の決定を判断するための追加情報について"></a>承認および拒否の決定を判断するための追加情報について</h2><p>アクセス判断のために追加情報が必要なレビュー担当者は、追加情報を確認することもできます。「詳細」をクリックすると、アクセスを「許可」または「拒否」するオプションが表示され、推奨事項の理由も表示できます。</p><p>レビュー担当者が推奨されるオプションを選択した場合、決定は直接送信されます。一方、レビュー担当者が推奨されるオプションとは異なる決定を行う場合、理由が必要となります。 </p><p><img src="/blog/azure-active-directory/machine-learning-recommendations-in-access-review/machine-learning-recommendations-in-access-review5.png"></p><h2 id="リソースとフィードバック"><a href="#リソースとフィードバック" class="headerlink" title="リソースとフィードバック"></a>リソースとフィードバック</h2><p>詳細については、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/review-recommendations-access-reviews#user-to-group-affiliation-preview">本公開情報</a> を併せてご覧ください。また、本プレビューについてのフィードバックを募集しています。aka.ms/AzureADFeedback までお気軽にコメントをお寄せください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。 Azure ID チームの小出です。&lt;/p&gt;
&lt;p&gt;この記事では、2022 年 12 月 1 日に公開された &lt;a href=&quot;https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-bl</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
    <category term="Access Review" scheme="https://jpazureid.github.io/blog/tags/Access-Review/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra の変更管理のアナウンス (2022 年 11 月の状況)</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/Microsoft-Entra-change-announcements-November-2022-train/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/Microsoft-Entra-change-announcements-November-2022-train/</id>
    <published>2022-12-04T03:00:00.000Z</published>
    <updated>2023-03-05T14:02:06.103Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 竜 です。</p><p>本記事は、2022 年 11 月 30 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/microsoft-entra-change-announcements-november-2022-train/ba-p/2967452">MMicrosoft Entra Change Announcements – November 2022 Train</a> を意訳したものになります。</p><hr><p>皆さん、こんにちは。</p><p>Microsoft Entra の変更管理に関するアナウンスは、<a href="https://www.microsoft.com/en-us/security/blog/2022/05/31/secure-access-for-a-connected-worldmeet-microsoft-entra/">Microsoft Entra</a> のすべての変更を含めて、半年に一度の製品廃止のお知らせと、四半期に一度の機能変更のお知らせをお伝えしています。これらのアナウンスの合間には、新製品や新機能のリリースに関するブログ記事を公開しています。たとえば、<a href="https://jpazureid.github.io/blog/azure-active-directory/Microsoft-Entra-change-announcements-September-2022-train/">9 月の変更管理のブログ記事</a> では、<a href="https://jpazureid.github.io/blog/azure-active-directory/Announcing-a-New-Azure-AD-part-of-Microsoft-Entra-region-in-Japan/">日本での新しいリージョンの一般提供</a> を開始したことを発表しました。</p><p>本日は、機能変更との既存の動作に影響を与える 11 月分の変更についてお知らせします。これらの変更は、リリース ノートや電子メールでもお知らせしています。また、お客様が新しい <a href="https://entra.microsoft.com/">Entra 管理センター</a> で、ライフサイクルの変更 (廃止、サポート終了、サービスの破壊的な変更) を管理しやすくなるよう、引き続き取り組んでいます。</p><p>以下に、2022 年 11 月分として発表された機能変更の一覧をご紹介します。    </p><h2 id="Microsoft-Authenticator-における番号の一致機能"><a href="#Microsoft-Authenticator-における番号の一致機能" class="headerlink" title="Microsoft Authenticator における番号の一致機能"></a>Microsoft Authenticator における番号の一致機能</h2><p>Microsoft Authenticator で <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-mfa-number-match">「番号の一致 (Number Matching)」機能</a> と <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-mfa-additional-context">「追加のコンテキスト (Additional Context)」機能</a> の一般提供を開始しました (2022 年 10 月 24 日現在)。番号の一致機能では、Authenticator アプリで多要素認証を承認する際に、サインイン画面に表示される数値の入力をユーザーに求めることで、誤って通知を承認するのを防ぐことができます。また、Authenticator の通知でユーザーに追加のコンテキストを表示することで、誤って承認するのを減らすことも可能です。管理者は以下の機能の有効化を選択できるようになりました。</p><ol><li>アプリケーションのコンテキスト: ユーザーがどのアプリケーションにサインインしているかを表示します。</li><li>地理的な位置のコンテキスト: サインインしているデバイスの IP アドレスに基づき、ユーザーのサインイン場所を表示します。</li></ol><p><a href="https://jpazureid.github.io/blog/azure-active-directory/defend-your-users-from-mfa-fatigue-attacks/">MFA 疲労攻撃が増加している</a> 中、これらの機能は組織を守るために非常に重要です。Azure ポータルの管理者画面と Microsoft Graph API を活用することで、これらの重要なセキュリティ機能を組織でスムーズに導入することができますので、ぜひご検討ください。</p><p>Microsoft は、2023 年 2 月 27 日より、Microsoft Authenticator アプリを利用するすべてのユーザーを対象に、番号の一致機能を有効化する予定です。 詳しくは、<a href="https://jpazureid.github.io/blog/azure-active-directory/defend-your-users-from-mfa-fatigue-attacks/">Microsoft Authenticator の MFA 疲労攻撃対策</a> をご参照ください。</p><h2 id="Azure-AD-への-IPv6-の導入"><a href="#Azure-AD-への-IPv6-の導入" class="headerlink" title="Azure AD への IPv6 の導入"></a>Azure AD への IPv6 の導入</h2><p>企業ネットワーク、サービス プロバイダー、およびデバイスにおける IPv6 の普及とサポートが進む中、ユーザーが IPv6 クライアントや IPv6 ネットワークを使用して自社のサービスやアプリケーションに引き続きアクセスできるかどうか気にされているお客様も多くいらっしゃいます。</p><p>本日、Azure AD (Microsoft Entra) に IPv6 のサポートを導入する計画を発表しました。この変更により、お客様は IPv4 と IPv6 の両方のネットワーク プロトコル (デュアルスタック) で Azure AD のサービスにアクセスすることができるようになります。</p><p>ほとんどのお客様において、IPv4 が完全に利用されなくなることはないと想定しているため、Azure AD の機能やサービスにおいて、<strong>IPv6 を必須としたり、IPv4 の優先順位を下げたりすることは予定していません</strong>。</p><p><strong>2023 年 3 月 31 日</strong> から、段階的に、Azure AD のサービスに IPv6 対応を導入していく予定です。 </p><div class="alert is-info"><p class="alert-title">Note</p><p>サポート部門による注釈: 一部の Azure AD のサービスでは、IPv6 はすでにサポートされています。上記発表は今後、より多くのサービスにおいて、IPv6 がサポートされることを示しています。</p></div><p>IPv6 アドレスおよび条件付きアクセス ポリシーで <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/location-condition#named-locations">ネームド ロケーション</a> を使用している Azure AD のお客様向けに、以下のガイダンスを用意しました。</p><p>組織内で、特定のネットワーク境界を識別するためにネームド ロケーションを使用しているお客様は、以下の作業が必要となります: </p><ol><li>既存の <strong>ネームド ロケーション</strong> の確認を行い潜在的な影響を予期すること</li><li>ネットワーク パートナーと協力してお客様の環境で使用されている外部向けの IPv6 アドレスを特定すること</li><li>既存の <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/location-condition#ip-address-ranges">ネームド ロケーション</a> の見直しと変更を行い確認した IPv6 の範囲を含めること</li></ol><p><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/location-condition">条件付きアクセス ポリシーにおける場所の条件</a> を使用して特定のネットワークからのアクセスのみを許可するよう制限しているお客様は、以下の作業が必要となります: </p><ol><li>既存の条件付アクセス ポリシーの確認を行いネームド ロケーションの利用による想定される影響を確認すること</li><li>場所の条件を使用した既存の条件付きアクセス ポリシーの見直しと更新を行いそれらが組織のセキュリティ要件を引き続き満たしているかどうかを確認すること</li></ol><p>Azure AD における IPv6 の有効化に関する追加のガイダンスは、こちらの覚えやすい URL (<a href="https://aka.ms/azureadipv6">https://aka.ms/azureadipv6</a>) にて引き続き共有していく予定です。</p><h2 id="Azure-AD-Domain-Services-のクラシック仮想ネットワーク-サポート"><a href="#Azure-AD-Domain-Services-のクラシック仮想ネットワーク-サポート" class="headerlink" title="Azure AD Domain Services のクラシック仮想ネットワーク サポート"></a>Azure AD Domain Services のクラシック仮想ネットワーク サポート</h2><p>以前発表したように、2017 年に Azure AD Domain Services (Azure AD DS) が Azure Resource Manager ネットワークでホスト可能になりました。それ以降、弊社は Azure Resource Manager の最新の機能を使用して、より安全なサービスを構築してきました。今後クラシック デプロイは Azure Resource manager デプロイに完全に移行するため、Azure AD DS クラシック仮想ネットワークのデプロイは 2023 年 3 月 1 日に廃止される予定です。クラシック仮想ネットワークからの Azure AD DS の移行についての詳細は <a href="https://learn.microsoft.com/ja-jp/azure/active-directory-domain-services/migrate-from-classic-vnet">クラシック仮想ネットワーク モデルから Resource Manager への Azure Active Directory Domain Services の移行</a> をご参照ください。</p><p>以下は、弊社からの Microsoft Entra の変更管理についての連絡予定の概要です。</p><table><thead><tr><th><strong>カテゴリ</strong></th><th><strong>定義</strong></th><th><strong>連絡の予定</strong></th></tr></thead><tbody><tr><td>製品の廃止の連絡</td><td><strong>機能、性能、または製品を特定の期間後に廃止</strong>することを指します。これは、一般的に、新たなお客様に対してサービスや機能の提供を停止し、廃止予定の機能に対して技術的面での投資が削減されることを意味します。最終的には、EOL (end-of-life) の状態に至り、すべてのお客様に対してサービスや機能の提供が停止されます。</td><td>年に 2 回 (3 月、9 月)</td></tr><tr><td>製品の機能変更および既存の動作に影響を与える変更のお知らせ</td><td><strong>既存の動作に影響を与える変更</strong>: 継続的な運用のためにお客様が何らかの操作や変更を行わない場合、既存のユーザーおよびパートナー体験に影響が生じると想定される変更です。<br><strong>機能の変更</strong>: 既存の ID の機能に対する変更であり、お客様側での作業は必要はありませんが、ユーザー体験に変化が生じます。多くは、UI/UX (ユーザー インターフェイスおよびユーザー体験) への変更です。<br><br>これらの変更は一般的に頻繁に発生するため、より頻繁に弊社からの通知が必要となります。</td><td>年に 4 回 (3 月、6 月、9 月、11 月)</td></tr></tbody></table><p>毎月の更新については、リリースノートのページでご確認ください: <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/whats-new">Azure Active Directory の新着情報</a></p><p>いつものように、フィードバックや提案をお待ちしています。以下のコメントまたは <a href="https://feedback.azure.com/d365community/forum/22920db1-ad25-ec11-b6e6-000d3a4f0789">Azure AD feedback forum</a> でご意見をお聞かせください。</p><p>また、Microsoft Q&amp;A で、質問、未解決の問題や機能に関するご要望を #AzureADChangeManagementNov2022Train のタグを使用して送信することも可能です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 竜 です。&lt;/p&gt;
&lt;p&gt;本記事は、2022 年 11 月 30 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techco</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
</feed>
